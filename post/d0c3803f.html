<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/img/blog/crown.png"><link rel="icon" type="image/png" href="/img/blog/crown.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"><meta name="theme-color" content="#2f4154"><meta name="description" content="Nothing is so common as the wish to be remarkables"><meta name="author" content="Bryce Huang"><meta name="keywords" content="blog,program,life"><title>kubernetes å®‰è£… - Bryce&#39;s Club</title><link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.0.0/styles/dracula.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_fmb4a04yx8h.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_pjno9b9zyxs.css"><link rel="stylesheet" href="https://cdn.staticfile.org/gitalk/1.6.2/gitalk.css"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/css/custom.css"><meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="Bryce's Club" type="application/atom+xml"></head><body><div id="dark" onclick="switchDarkMode()"></div><script>var isNight=18<=(new Date).getHours()||(new Date).getHours()<8;(matchMedia("(prefers-color-scheme: dark)").matches||isNight||"1"===localStorage.getItem("dark"))&&(isNight&&"1"===localStorage.getItem("noDark")||document.body.classList.add("dark")),document.getElementById("dark").innerHTML=document.querySelector("body").classList.contains("dark")?"ğŸŒ™":"ğŸŒ"</script><header style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/">&nbsp;<strong>Bryce's Club</strong>&nbsp;</a> <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/"><i class="iconfont icon-home-fill"></i> é¦–é¡µ</a></li><li class="nav-item"><a class="nav-link" href="/archives/"><i class="iconfont icon-archive-fill"></i> å½’æ¡£</a></li><li class="nav-item"><a class="nav-link" href="/categories/"><i class="iconfont icon-category-fill"></i> åˆ†ç±»</a></li><li class="nav-item"><a class="nav-link" href="/tags/"><i class="iconfont icon-tags-fill"></i> æ ‡ç­¾</a></li><li class="nav-item"><a class="nav-link" href="/links/"><i class="iconfont icon-link-fill"></i> å‹é“¾</a></li><li class="nav-item"><a class="nav-link" href="/messageboard/"><i class="iconfont icon-speakernotes"></i> ç•™è¨€</a></li><li class="nav-item"><a class="nav-link" href="/features/"><i class="iconfont icon-exp-fill"></i> åŠŸèƒ½</a></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-user-fill"></i> å…³äº</a></li><li class="nav-item" id="search-btn"><a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;&nbsp;<i class="iconfont icon-search"></i>&nbsp;&nbsp;</a></li></ul></div></div></nav><div class="view intro-2" id="background" parallax="true" style="background:url(/img/star-guardian/champion-pajama-group-splash.webp) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="container text-center white-text fadeInUp"><span class="h2" id="subtitle"></span><div class="mt-3 post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2020-05-01 17:23">æ˜ŸæœŸäº”, äº”æœˆ 1æ—¥ 2020, 5:23 ä¸‹åˆ</time></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 22.3k å­— </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 384 åˆ†é’Ÿ</span></div></div></div></div></div></header><main><div class="container-fluid"><div class="row"><div class="d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-md"><div class="container nopadding-md" id="board-ctn"><div class="py-5" id="board"><div class="post-content mx-auto" id="post"><article class="markdown-body"><p><strong>kubernetes ubuntuå®‰è£…éƒ¨ç½²</strong></p><h2 id="å®‰è£…åŸºç¡€ç¯å¢ƒ"><a href="#å®‰è£…åŸºç¡€ç¯å¢ƒ" class="headerlink" title="å®‰è£…åŸºç¡€ç¯å¢ƒ"></a><strong>å®‰è£…åŸºç¡€ç¯å¢ƒ</strong></h2><h3 id="é…ç½®ç³»ç»Ÿhostsæ–‡ä»¶"><a href="#é…ç½®ç³»ç»Ÿhostsæ–‡ä»¶" class="headerlink" title="é…ç½®ç³»ç»Ÿhostsæ–‡ä»¶"></a>é…ç½®ç³»ç»Ÿhostsæ–‡ä»¶</h3><div class="hljs"><pre><code class="hljs bash"> cat &gt;&gt; /etc/hosts &lt;&lt;EOF

10.10.34.92   ukm01
10.10.34.93   ukm02
10.10.34.94   ukm03
10.10.34.95   uki01
10.10.34.96   uki02
10.10.34.97   uki03
10.10.34.98   ukn01
10.10.34.99   ukn02
10.10.34.100  ukn03
EOF</code></pre></div><h3 id="é…ç½®ä¸»æœºå"><a href="#é…ç½®ä¸»æœºå" class="headerlink" title="é…ç½®ä¸»æœºå"></a>é…ç½®ä¸»æœºå</h3><div class="hljs"><pre><code class="hljs bash">hostnamectl <span class="hljs-built_in">set</span>-hostname ukm01</code></pre></div><h3 id="é…ç½®sshkey"><a href="#é…ç½®sshkey" class="headerlink" title="é…ç½®sshkey"></a>é…ç½®sshkey</h3><h4 id="åˆ›å»ºsshkey"><a href="#åˆ›å»ºsshkey" class="headerlink" title="åˆ›å»ºsshkey"></a>åˆ›å»ºsshkey</h4><div class="hljs"><pre><code class="hljs bash"> ssh-keygen -t dsa -b 1024 -C <span class="hljs-string">"seanzhau@mokr.cn"</span>
Generating public/private dsa key pair.
Enter file <span class="hljs-keyword">in</span> <span class="hljs-built_in">which</span> to save the key (/root/.ssh/id_dsa):
Enter passphrase (empty <span class="hljs-keyword">for</span> no passphrase):
Enter same passphrase again:
Your identification has been saved <span class="hljs-keyword">in</span> /root/.ssh/id_dsa.
Your public key has been saved <span class="hljs-keyword">in</span> /root/.ssh/id_dsa.pub.
The key fingerprint is:
SHA256:LaO+CdmwvXlHaIPXvZf0s/XjKxPjVUdtvoHC0PCGEUs seanzhau@mokr.cn
The key<span class="hljs-string">'s randomart image is:</span>
<span class="hljs-string">+---[DSA 1024]----+</span>
<span class="hljs-string">|         E+     .|</span>
<span class="hljs-string">|        ..=.    +|</span>
<span class="hljs-string">|         ooo  .+ |</span>
<span class="hljs-string">|         ..o . .+|</span>
<span class="hljs-string">|    .  .So...   =|</span>
<span class="hljs-string">|     *..=oo .o.o |</span>
<span class="hljs-string">|    + +o o  .o+o.|</span>
<span class="hljs-string">|     o +. . .+oo+|</span>
<span class="hljs-string">|      *o .   .++*|</span>
<span class="hljs-string">+----[SHA256]-----+</span></code></pre></div><h4 id="åˆ†å‘key"><a href="#åˆ†å‘key" class="headerlink" title="åˆ†å‘key"></a>åˆ†å‘key</h4><div class="hljs"><pre><code class="hljs bash"> ssh-copy-id ukm01
/usr/bin/ssh-copy-id: INFO: Source of key(s) to be installed: <span class="hljs-string">"/root/.ssh/id_dsa.pub"</span>
/usr/bin/ssh-copy-id: INFO: attempting to <span class="hljs-built_in">log</span> <span class="hljs-keyword">in</span> with the new key(s), to filter out any that are already installed
/usr/bin/ssh-copy-id: INFO: 1 key(s) remain to be installed -- <span class="hljs-keyword">if</span> you are prompted now it is to install the new keys

Number of key(s) added: 1
...

 ssh-copy-id ukn03
...</code></pre></div><h4 id="æ ¡éªŒ"><a href="#æ ¡éªŒ" class="headerlink" title="æ ¡éªŒ"></a>æ ¡éªŒ</h4><div class="hljs"><pre><code class="hljs bash"> ssh ukm01
Welcome to Ubuntu 18.04.3 LTS (GNU/Linux 4.15.0-88-generic x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage

 System information disabled due to load higher than 4.0
...

 ssh ukn03
...</code></pre></div><h3 id="é…ç½®é˜¿é‡Œäº‘-repo"><a href="#é…ç½®é˜¿é‡Œäº‘-repo" class="headerlink" title="é…ç½®é˜¿é‡Œäº‘ repo"></a>é…ç½®é˜¿é‡Œäº‘ repo</h3><div class="hljs"><pre><code class="hljs bash"> mv /etc/apt/sources.list /etc/apt/sources.list.bak

 cat &gt; /etc/apt/sources.list &lt;&lt;EOF
deb http://mirrors.aliyun.com/ubuntu/ bionic main restricted universe multiverse
deb-src http://mirrors.aliyun.com/ubuntu/ bionic main restricted universe multiverse

deb http://mirrors.aliyun.com/ubuntu/ bionic-security main restricted universe multiverse
deb-src http://mirrors.aliyun.com/ubuntu/ bionic-security main restricted universe multiverse

deb http://mirrors.aliyun.com/ubuntu/ bionic-updates main restricted universe multiverse
deb-src http://mirrors.aliyun.com/ubuntu/ bionic-updates main restricted universe multiverse

deb http://mirrors.aliyun.com/ubuntu/ bionic-proposed main restricted universe multiverse
deb-src http://mirrors.aliyun.com/ubuntu/ bionic-proposed main restricted universe multiverse

deb http://mirrors.aliyun.com/ubuntu/ bionic-backports main restricted universe multiverse
deb-src http://mirrors.aliyun.com/ubuntu/ bionic-backports main restricted universe multiverse

EOF</code></pre></div><h3 id="å®‰è£…åŸºç¡€åŒ…"><a href="#å®‰è£…åŸºç¡€åŒ…" class="headerlink" title="å®‰è£…åŸºç¡€åŒ…"></a>å®‰è£…åŸºç¡€åŒ…</h3><p>ubuntu 18.04 é»˜è®¤æœªå®‰è£…pythonï¼Œéœ€è¦æ¯å°æœåŠ¡å™¨æ‰‹åŠ¨å®‰è£…ã€‚</p><div class="hljs"><pre><code class="hljs bash">apt update &amp;&amp; apt install -y software-properties-common apt-transport-https ca-certificates gnupg2 python curl</code></pre></div><h2 id="å®‰è£…-ansible"><a href="#å®‰è£…-ansible" class="headerlink" title="å®‰è£… ansible"></a><strong>å®‰è£… ansible</strong></h2><p>åªéœ€åœ¨ master èŠ‚ç‚¹å®‰è£…</p><div class="hljs"><pre><code class="hljs bash">apt-add-repository --yes --update ppa:ansible/ansible

apt install -y ansible</code></pre></div><h3 id="é…ç½®-ansible-cfg"><a href="#é…ç½®-ansible-cfg" class="headerlink" title="é…ç½® ansible.cfg"></a>é…ç½® ansible.cfg</h3><div class="hljs"><pre><code class="hljs bash"> cat &gt; /etc/ansible/ansible.cfg &lt;&lt;EOF
[defaults]
log_path = /var/<span class="hljs-built_in">log</span>/ansible.log

forks = 20
host_key_checking = False
retry_files_enabled = False
deprecation_warnings = False
nocows = True
remote_user = root
roles_path = roles/
gathering = smart
fact_caching = jsonfile
fact_caching_connection = /etc/ansible/facts
fact_caching_timeout = 600
callback_whitelist = profile_tasks
inventory_ignore_extensions = secrets.py, .pyc, .cfg, .crt, .ini
timeout = 30

[inventory]
unparsed_is_failed=<span class="hljs-literal">true</span>

[ssh_connection]
pipelining = True
ssh_args = -o ControlMaster=auto -o ControlPersist=600s
timeout = 10
control_path = %(directory)s/%%h-%%r
EOF</code></pre></div><h3 id="é…ç½®-inventory-hosts"><a href="#é…ç½®-inventory-hosts" class="headerlink" title="é…ç½® inventory hosts"></a>é…ç½® inventory hosts</h3><div class="hljs"><pre><code class="hljs bash"> cat &gt; /etc/ansible/hosts &lt;&lt;EOF
[ins]
10.10.34.92  hostname=<span class="hljs-string">'ukm01'</span>
10.10.34.93  hostname=<span class="hljs-string">'ukm02'</span>
10.10.34.94  hostname=<span class="hljs-string">'ukm03'</span>
10.10.34.95  hostname=<span class="hljs-string">'uki01'</span>
10.10.34.96  hostname=<span class="hljs-string">'uki02'</span>
10.10.34.97  hostname=<span class="hljs-string">'uki03'</span>
10.10.34.98  hostname=<span class="hljs-string">'ukn01'</span>
10.10.34.99  hostname=<span class="hljs-string">'ukn02'</span>
10.10.34.100 hostname=<span class="hljs-string">'ukn03'</span> ansible_ssh_user=<span class="hljs-string">'root'</span> ansible_ssh_pass=<span class="hljs-string">'xxxxxxx'</span>

[ans]
10.10.34.92

[master]
10.10.34.9[2:4]

[infra]
10.10.34.9[5:7]

[worker]
10.10.34.9[8:9]
10.10.34.100
EOF</code></pre></div><h3 id="éªŒè¯-ansible-é…ç½®"><a href="#éªŒè¯-ansible-é…ç½®" class="headerlink" title="éªŒè¯ ansible é…ç½®"></a>éªŒè¯ ansible é…ç½®</h3><div class="hljs"><pre><code class="hljs bash"> ansible ins -m ping
10.10.34.92 | SUCCESS =&gt; &#123;
    <span class="hljs-string">"ansible_facts"</span>: &#123;
        <span class="hljs-string">"discovered_interpreter_python"</span>: <span class="hljs-string">"/usr/bin/python"</span>
    &#125;,
    <span class="hljs-string">"changed"</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-string">"ping"</span>: <span class="hljs-string">"pong"</span>
&#125;
...</code></pre></div><h3 id="é›†ç¾¤èŠ‚ç‚¹ç»‘å®šä¸»æœºå"><a href="#é›†ç¾¤èŠ‚ç‚¹ç»‘å®šä¸»æœºå" class="headerlink" title="é›†ç¾¤èŠ‚ç‚¹ç»‘å®šä¸»æœºå"></a>é›†ç¾¤èŠ‚ç‚¹ç»‘å®šä¸»æœºå</h3><div class="hljs"><pre><code class="hljs bash"> ansible ins:\!ans -m shell -a <span class="hljs-string">'cat &gt;&gt; /etc/hosts &lt;&lt;EOF</span>
<span class="hljs-string">10.10.34.92   ukm01</span>
<span class="hljs-string">10.10.34.93   ukm02</span>
<span class="hljs-string">10.10.34.94   ukm03</span>
<span class="hljs-string">10.10.34.95   uki01</span>
<span class="hljs-string">10.10.34.96   uki02</span>
<span class="hljs-string">10.10.34.97   uki03</span>
<span class="hljs-string">10.10.34.98   ukn01</span>
<span class="hljs-string">10.10.34.99   ukn02</span>
<span class="hljs-string">10.10.34.100  ukn03</span>
<span class="hljs-string">EOF'</span>

 ansible ins:\!ans -m shell -a <span class="hljs-string">'cat /etc/hosts'</span></code></pre></div><h3 id="åˆ†å‘é…ç½®"><a href="#åˆ†å‘é…ç½®" class="headerlink" title="åˆ†å‘é…ç½®"></a>åˆ†å‘é…ç½®</h3><div class="hljs"><pre><code class="hljs bash">åˆ†å‘ç§é’¥
ansible master -m copy -a <span class="hljs-string">'src=/root/.ssh/id_rsa dest=/root/.ssh/id_rsa mode=0600 owner=root'</span>

åˆ†å‘ ansible é…ç½®
ansible master -m copy -a <span class="hljs-string">'src=/etc/ansible/hosts dest=/etc/ansible/hosts'</span>

ansible master -m copy -a <span class="hljs-string">'src=/etc/ansible/ansible.cfg dest=/etc/ansible/ansible.cfg'</span></code></pre></div><h2 id="å®‰è£…-Docker-CE"><a href="#å®‰è£…-Docker-CE" class="headerlink" title="å®‰è£… Docker CE"></a><strong>å®‰è£… Docker CE</strong></h2><p>æ·»åŠ  Docker GPG key</p><div class="hljs"><pre><code class="hljs bash">ansible ins -m shell -a <span class="hljs-string">'curl -fsSL https://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg | sudo apt-key add -'</span></code></pre></div><h3 id="é…ç½®-Docker-æº"><a href="#é…ç½®-Docker-æº" class="headerlink" title="é…ç½® Docker æº"></a>é…ç½® Docker æº</h3><ul><li>åŠ¨æ€è¯†åˆ«æ“ä½œç³»ç»Ÿç‰ˆæœ¬ <code>add-apt-repository &quot;deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable&quot;</code></li></ul><div class="hljs"><pre><code class="hljs bash">ansible ins -m shell -a <span class="hljs-string">'add-apt-repository "deb [arch=amd64] https://mirrors.aliyun.com/docker-ce/linux/ubuntu bionic stable"'</span></code></pre></div><h3 id="å®‰è£…-Docker"><a href="#å®‰è£…-Docker" class="headerlink" title="å®‰è£… Docker"></a>å®‰è£… Docker</h3><div class="hljs"><pre><code class="hljs bash">ansible ins -m shell -a <span class="hljs-string">'apt update &amp;&amp; apt install -y docker-ce docker-ce-cli containerd.io'</span></code></pre></div><h3 id="é…ç½®-docker-daemon"><a href="#é…ç½®-docker-daemon" class="headerlink" title="é…ç½® docker daemon"></a>é…ç½® docker daemon</h3><div class="hljs"><pre><code class="hljs bash"> cat &gt; /etc/docker/daemon.json &lt;&lt;EOF
&#123;
  <span class="hljs-string">"exec-opts"</span>: [<span class="hljs-string">"native.cgroupdriver=systemd"</span>],
  <span class="hljs-string">"log-driver"</span>: <span class="hljs-string">"json-file"</span>,
  <span class="hljs-string">"log-opts"</span>: &#123;
    <span class="hljs-string">"max-size"</span>: <span class="hljs-string">"100m"</span>,
    <span class="hljs-string">"max-file"</span>: <span class="hljs-string">"5"</span>
  &#125;,
  <span class="hljs-string">"registry-mirrors"</span>: [<span class="hljs-string">"https://docker.mirrors.ustc.edu.cn"</span>],
  <span class="hljs-string">"storage-driver"</span>: <span class="hljs-string">"overlay2"</span>
&#125;
EOF</code></pre></div><h3 id="åˆ†å‘-daemon-json"><a href="#åˆ†å‘-daemon-json" class="headerlink" title="åˆ†å‘ daemon.json"></a>åˆ†å‘ daemon.json</h3><div class="hljs"><pre><code class="hljs bash">ansible ins -m copy -a <span class="hljs-string">'src=/etc/docker/daemon.json dest=/etc/docker/daemon.json'</span>

ansible ins -m shell -a <span class="hljs-string">'mkdir -p /etc/systemd/system/docker.service.d'</span></code></pre></div><h3 id="é‡å¯-docker-æœåŠ¡"><a href="#é‡å¯-docker-æœåŠ¡" class="headerlink" title="é‡å¯ docker æœåŠ¡"></a>é‡å¯ docker æœåŠ¡</h3><div class="hljs"><pre><code class="hljs bash">ansible ins -m shell -a <span class="hljs-string">'systemctl daemon-reload'</span>

ansible ins -m shell -a <span class="hljs-string">'systemctl restart docker'</span>

ansible ins -m shell -a <span class="hljs-string">'docker info|grep -i cgroup'</span>
Cgroup Driver: systemd</code></pre></div><h3 id="daemon-json-é…ç½®è¯¦è§£"><a href="#daemon-json-é…ç½®è¯¦è§£" class="headerlink" title="daemon.json é…ç½®è¯¦è§£"></a>daemon.json é…ç½®è¯¦è§£</h3><div class="hljs"><pre><code class="hljs bash"> cat /etc/docker/daemon.json
&#123;
  <span class="hljs-string">"authorization-plugins"</span>: [],
  <span class="hljs-string">"data-root"</span>: <span class="hljs-string">""</span>,
  <span class="hljs-string">"dns"</span>: [],
  <span class="hljs-string">"dns-opts"</span>: [],
  <span class="hljs-string">"dns-search"</span>: [],
  <span class="hljs-string">"exec-opts"</span>: [],
  <span class="hljs-string">"exec-root"</span>: <span class="hljs-string">""</span>,
  <span class="hljs-string">"experimental"</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-string">"features"</span>: &#123;&#125;,
  <span class="hljs-string">"storage-driver"</span>: <span class="hljs-string">""</span>,
  <span class="hljs-string">"storage-opts"</span>: [],
  <span class="hljs-string">"labels"</span>: [],
  <span class="hljs-string">"live-restore"</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-string">"log-driver"</span>: <span class="hljs-string">"json-file"</span>,
  <span class="hljs-string">"log-opts"</span>: &#123;
    <span class="hljs-string">"max-size"</span>: <span class="hljs-string">"10m"</span>,
    <span class="hljs-string">"max-file"</span>:<span class="hljs-string">"5"</span>,
    <span class="hljs-string">"labels"</span>: <span class="hljs-string">"somelabel"</span>,
    <span class="hljs-string">"env"</span>: <span class="hljs-string">"os,customer"</span>
  &#125;,
  <span class="hljs-string">"mtu"</span>: 0,
  <span class="hljs-string">"pidfile"</span>: <span class="hljs-string">""</span>,
  <span class="hljs-string">"cluster-store"</span>: <span class="hljs-string">""</span>,
  <span class="hljs-string">"cluster-store-opts"</span>: &#123;&#125;,
  <span class="hljs-string">"cluster-advertise"</span>: <span class="hljs-string">""</span>,
  <span class="hljs-string">"max-concurrent-downloads"</span>: 3,
  <span class="hljs-string">"max-concurrent-uploads"</span>: 5,
  <span class="hljs-string">"default-shm-size"</span>: <span class="hljs-string">"64M"</span>,
  <span class="hljs-string">"shutdown-timeout"</span>: 15,
  <span class="hljs-string">"debug"</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-string">"hosts"</span>: [],
  <span class="hljs-string">"log-level"</span>: <span class="hljs-string">""</span>,
  <span class="hljs-string">"tls"</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-string">"tlsverify"</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-string">"tlscacert"</span>: <span class="hljs-string">""</span>,
  <span class="hljs-string">"tlscert"</span>: <span class="hljs-string">""</span>,
  <span class="hljs-string">"tlskey"</span>: <span class="hljs-string">""</span>,
  <span class="hljs-string">"swarm-default-advertise-addr"</span>: <span class="hljs-string">""</span>,
  <span class="hljs-string">"api-cors-header"</span>: <span class="hljs-string">""</span>,
  <span class="hljs-string">"selinux-enabled"</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-string">"userns-remap"</span>: <span class="hljs-string">""</span>,
  <span class="hljs-string">"group"</span>: <span class="hljs-string">""</span>,
  <span class="hljs-string">"cgroup-parent"</span>: <span class="hljs-string">""</span>,
  <span class="hljs-string">"default-ulimits"</span>: &#123;
    <span class="hljs-string">"nofile"</span>: &#123;
      <span class="hljs-string">"Name"</span>: <span class="hljs-string">"nofile"</span>,
      <span class="hljs-string">"Hard"</span>: 64000,
      <span class="hljs-string">"Soft"</span>: 64000
    &#125;
  &#125;,
  <span class="hljs-string">"init"</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-string">"init-path"</span>: <span class="hljs-string">"/usr/libexec/docker-init"</span>,
  <span class="hljs-string">"ipv6"</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-string">"iptables"</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-string">"ip-forward"</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-string">"ip-masq"</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-string">"userland-proxy"</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-string">"userland-proxy-path"</span>: <span class="hljs-string">"/usr/libexec/docker-proxy"</span>,
  <span class="hljs-string">"ip"</span>: <span class="hljs-string">"0.0.0.0"</span>,
  <span class="hljs-string">"bridge"</span>: <span class="hljs-string">""</span>,
  <span class="hljs-string">"bip"</span>: <span class="hljs-string">""</span>,
  <span class="hljs-string">"fixed-cidr"</span>: <span class="hljs-string">""</span>,
  <span class="hljs-string">"fixed-cidr-v6"</span>: <span class="hljs-string">""</span>,
  <span class="hljs-string">"default-gateway"</span>: <span class="hljs-string">""</span>,
  <span class="hljs-string">"default-gateway-v6"</span>: <span class="hljs-string">""</span>,
  <span class="hljs-string">"icc"</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-string">"raw-logs"</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-string">"allow-nondistributable-artifacts"</span>: [],
  <span class="hljs-string">"registry-mirrors"</span>: [],
  <span class="hljs-string">"seccomp-profile"</span>: <span class="hljs-string">""</span>,
  <span class="hljs-string">"insecure-registries"</span>: [],
  <span class="hljs-string">"no-new-privileges"</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-string">"default-runtime"</span>: <span class="hljs-string">"runc"</span>,
  <span class="hljs-string">"oom-score-adjust"</span>: -500,
  <span class="hljs-string">"node-generic-resources"</span>: [<span class="hljs-string">"NVIDIA-GPU=UUID1"</span>, <span class="hljs-string">"NVIDIA-GPU=UUID2"</span>],
  <span class="hljs-string">"runtimes"</span>: &#123;
    <span class="hljs-string">"cc-runtime"</span>: &#123;
      <span class="hljs-string">"path"</span>: <span class="hljs-string">"/usr/bin/cc-runtime"</span>
    &#125;,
    <span class="hljs-string">"custom"</span>: &#123;
      <span class="hljs-string">"path"</span>: <span class="hljs-string">"/usr/local/bin/my-runc-replacement"</span>,
      <span class="hljs-string">"runtimeArgs"</span>: [
        <span class="hljs-string">"--debug"</span>
      ]
    &#125;
  &#125;,
  <span class="hljs-string">"default-address-pools"</span>:[
    &#123;<span class="hljs-string">"base"</span>:<span class="hljs-string">"172.80.0.0/16"</span>,<span class="hljs-string">"size"</span>:24&#125;,
    &#123;<span class="hljs-string">"base"</span>:<span class="hljs-string">"172.90.0.0/16"</span>,<span class="hljs-string">"size"</span>:24&#125;
  ]
&#125;</code></pre></div><h3 id="æ ¼å¼åŒ–æŸ¥çœ‹-images"><a href="#æ ¼å¼åŒ–æŸ¥çœ‹-images" class="headerlink" title="æ ¼å¼åŒ–æŸ¥çœ‹ images"></a>æ ¼å¼åŒ–æŸ¥çœ‹ images</h3><ul><li>.ID Image ID</li><li>.Repository Image ä»“åº“åœ°å€å’Œåç§°</li><li>.Tag Image æ ‡ç­¾</li><li>.Digest Image hash å€¼ä¿¡æ¯</li><li>.CreatedSince Image åˆ›å»ºåˆ°ç°åœ¨çš„æ—¶é—´</li><li>.CreatedAt Image åˆ›å»ºçš„å…·ä½“æ—¶é—´</li><li>.Size Image å¤§å°</li></ul><div class="hljs"><pre><code class="hljs bash">docker images --format <span class="hljs-string">"table &#123;&#123; .Repository &#125;&#125; \t &#123;&#123; .Tag &#125;&#125; \t &#123;&#123; .ID &#125;&#125; \t &#123;&#123; .CreatedSince &#125;&#125; \t &#123;&#123; .CreatedAt &#125;&#125; \t &#123;&#123; .Size &#125;&#125;"</span> --digests</code></pre></div><h3 id="docker-pull-è¿‡ç¨‹"><a href="#docker-pull-è¿‡ç¨‹" class="headerlink" title="docker pull è¿‡ç¨‹"></a>docker pull è¿‡ç¨‹</h3><ul><li>Docker å®¢æˆ·ç«¯å‘é€ REPOSITORY å’Œ TAGï¼ˆæˆ–è€… DIGESTï¼‰ç»™ Registryï¼›</li><li>Registry æ ¹æ® REPOSITORY å’Œ TAGï¼ˆæˆ–è€… DIGESTï¼‰æ‰¾åˆ°ç›¸åº” image manifestï¼›</li><li>Registry å°† manifest è¿”å›ç»™ Docker å®¢æˆ·ç«¯ï¼›</li><li>Docker å®¢æˆ·ç«¯æ ¹æ® manifest è¯»å– image çš„ digest(sha256) ï¼Œ sha256 å°±æ˜¯ IMAGE IDï¼›</li><li>Docker å®¢æˆ·ç«¯æ ¹æ® ID æŸ¥æ‰¾æœ¬åœ°æ˜¯å¦å­˜åœ¨å¯¹åº”çš„ imageï¼›</li><li>å¦‚æœ image å­˜åœ¨åˆ™åˆ›å»ºå¯¹åº”çš„ image REPOSITORY å’Œ TAGï¼›</li><li>å¦‚æœ image ä¸å­˜åœ¨ï¼Œåˆ™ç»§ç»­è¯·æ±‚ Registry è·å– image çš„é…ç½®æ–‡ä»¶ï¼›</li><li>æ ¹æ® image é…ç½®æ–‡ä»¶ä¸­çš„ diff_ids åœ¨æœ¬åœ°æ‰¾å¯¹åº”çš„ layer æ˜¯å¦å­˜åœ¨ï¼›</li><li>å¦‚æœ layer å­˜åœ¨ï¼Œåˆ™è¿”å› Already existsï¼›</li><li>å¦‚æœ layer ä¸å­˜åœ¨ï¼Œåˆ™æ ¹æ® manifest ä¸­ layer çš„ sha256 å’Œ media type å»æœåŠ¡å™¨ä¸‹è½½å¯¹åº”çš„ layerï¼›</li><li>ä¸‹è½½è§£å‹ä¹‹åï¼Œæ ¡éªŒ tar åŒ…çš„ sha256 æ˜¯å¦å’Œ Image Config ä¸­çš„ diff_id ä¸€è‡´ã€‚</li></ul><h3 id="imageæœ¬åœ°å­˜æ”¾ä¿¡æ¯"><a href="#imageæœ¬åœ°å­˜æ”¾ä¿¡æ¯" class="headerlink" title="imageæœ¬åœ°å­˜æ”¾ä¿¡æ¯"></a>imageæœ¬åœ°å­˜æ”¾ä¿¡æ¯</h3><div class="hljs"><pre><code class="hljs bash"> æŸ¥çœ‹ image DIGEST ä¿¡æ¯
 docker images --digests
REPOSITORY                    TAG                 DIGEST                                                                    IMAGE ID            CREATED             SIZE
busybox                       latest              sha256:a8cf7ff6367c2afa2a90acd081b484cbded349a7076e7bdf37a05279f276bc12   be5888e67be6        2 weeks ago         1.22MB

 å¦‚æœæ˜¯å…¶ä»–çš„æ–‡ä»¶ç³»ç»Ÿçš„è¯ï¼Œåå­—ä¼šæ˜¯å…¶ä»–çš„ï¼Œæ¯”å¦‚btrfsã€overlay2ã€devicemapperç­‰ã€‚
 cat /var/lib/docker/image/overlay2/repositories.json | python -m json.tool
&#123;
    <span class="hljs-string">"Repositories"</span>: &#123;
        <span class="hljs-string">"busybox"</span>: &#123;
            <span class="hljs-string">"busybox:latest"</span>: <span class="hljs-string">"sha256:be5888e67be651f1fbb59006f0fd791b44ed3fceaa6323ab4e37d5928874345a"</span>,
            <span class="hljs-string">"busybox@sha256:a8cf7ff6367c2afa2a90acd081b484cbded349a7076e7bdf37a05279f276bc12"</span>: <span class="hljs-string">"sha256:be5888e67be651f1fbb59006f0fd791b44ed3fceaa6323ab4e37d5928874345a"</span>
        &#125;
    &#125;
&#125;

 æ ¡éªŒ image config çš„ sha256 å€¼
 sha256sum /var/lib/docker/image/overlay2/imagedb/content/sha256/be5888e67be651f1fbb59006f0fd791b44ed3fceaa6323ab4e37d5928874345a
be5888e67be651f1fbb59006f0fd791b44ed3fceaa6323ab4e37d5928874345a  /var/lib/docker/image/overlay2/imagedb/content/sha256/be5888e67be651f1fbb59006f0fd791b44ed3fceaa6323ab4e37d5928874345a

 æŸ¥çœ‹ image config
 cat /var/lib/docker/image/overlay2/imagedb/content/sha256/be5888e67be651f1fbb59006f0fd791b44ed3fceaa6323ab4e37d5928874345a | python -m json.tool
&#123;
    <span class="hljs-string">"architecture"</span>: <span class="hljs-string">"amd64"</span>,
    <span class="hljs-string">"config"</span>: &#123;
        <span class="hljs-string">"ArgsEscaped"</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-string">"AttachStderr"</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-string">"AttachStdin"</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-string">"AttachStdout"</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-string">"Cmd"</span>: [
            <span class="hljs-string">"sh"</span>
        ],
        <span class="hljs-string">"Domainname"</span>: <span class="hljs-string">""</span>,
        <span class="hljs-string">"Entrypoint"</span>: null,
        <span class="hljs-string">"Env"</span>: [
            <span class="hljs-string">"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"</span>
        ],
        <span class="hljs-string">"Hostname"</span>: <span class="hljs-string">""</span>,
        <span class="hljs-string">"Image"</span>: <span class="hljs-string">"sha256:b0acc7ebf5092fcdd0fe097448529147e6619bd051f03ccf25b29bcae87e783f"</span>,
        <span class="hljs-string">"Labels"</span>: null,
        <span class="hljs-string">"OnBuild"</span>: null,
        <span class="hljs-string">"OpenStdin"</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-string">"StdinOnce"</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-string">"Tty"</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-string">"User"</span>: <span class="hljs-string">""</span>,
        <span class="hljs-string">"Volumes"</span>: null,
        <span class="hljs-string">"WorkingDir"</span>: <span class="hljs-string">""</span>
    &#125;,
    <span class="hljs-string">"container"</span>: <span class="hljs-string">"f7e67f16a539f8bbf53aae18cdb5f8c53e6a56930e7660010d9396ae77f7acfa"</span>,
    <span class="hljs-string">"container_config"</span>: &#123;
        <span class="hljs-string">"ArgsEscaped"</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-string">"AttachStderr"</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-string">"AttachStdin"</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-string">"AttachStdout"</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-string">"Cmd"</span>: [
            <span class="hljs-string">"/bin/sh"</span>,
            <span class="hljs-string">"-c"</span>,
            <span class="hljs-string">"(nop) "</span>,
            <span class="hljs-string">"CMD [\"sh\"]"</span>
        ],
        <span class="hljs-string">"Domainname"</span>: <span class="hljs-string">""</span>,
        <span class="hljs-string">"Entrypoint"</span>: null,
        <span class="hljs-string">"Env"</span>: [
            <span class="hljs-string">"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"</span>
        ],
        <span class="hljs-string">"Hostname"</span>: <span class="hljs-string">"f7e67f16a539"</span>,
        <span class="hljs-string">"Image"</span>: <span class="hljs-string">"sha256:b0acc7ebf5092fcdd0fe097448529147e6619bd051f03ccf25b29bcae87e783f"</span>,
        <span class="hljs-string">"Labels"</span>: &#123;&#125;,
        <span class="hljs-string">"OnBuild"</span>: null,
        <span class="hljs-string">"OpenStdin"</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-string">"StdinOnce"</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-string">"Tty"</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-string">"User"</span>: <span class="hljs-string">""</span>,
        <span class="hljs-string">"Volumes"</span>: null,
        <span class="hljs-string">"WorkingDir"</span>: <span class="hljs-string">""</span>
    &#125;,
    <span class="hljs-string">"created"</span>: <span class="hljs-string">"2020-04-14T19:19:53.590635493Z"</span>,
    <span class="hljs-string">"docker_version"</span>: <span class="hljs-string">"18.09.7"</span>,
    <span class="hljs-string">"history"</span>: [
        &#123;
            <span class="hljs-string">"created"</span>: <span class="hljs-string">"2020-04-14T19:19:53.444488372Z"</span>,
            <span class="hljs-string">"created_by"</span>: <span class="hljs-string">"/bin/sh -c (nop) ADD file:09a89925137e1b768ef1f0e7d1d7325eb2b4f1a0895b3aa8dfc98b0c75f3f507 in / "</span>
        &#125;,
        &#123;
            <span class="hljs-string">"created"</span>: <span class="hljs-string">"2020-04-14T19:19:53.590635493Z"</span>,
            <span class="hljs-string">"created_by"</span>: <span class="hljs-string">"/bin/sh -c (nop)  CMD [\"sh\"]"</span>,
            <span class="hljs-string">"empty_layer"</span>: <span class="hljs-literal">true</span>
        &#125;
    ],
    <span class="hljs-string">"os"</span>: <span class="hljs-string">"linux"</span>,
    <span class="hljs-string">"rootfs"</span>: &#123;
        <span class="hljs-string">"diff_ids"</span>: [
            <span class="hljs-string">"sha256:5b0d2d635df829f65d0ffb45eab2c3124a470c4f385d6602bda0c21c5248bcab"</span>
        ],
        <span class="hljs-string">"type"</span>: <span class="hljs-string">"layers"</span>
    &#125;
&#125;

 layer diff_id å’Œ digest çš„å¯¹åº”å…³ç³»
 diffid-by-digestï¼š å­˜æ”¾ digest åˆ° diffid çš„å¯¹åº”å…³ç³»
 v2metadata-by-diffidï¼š å­˜æ”¾ diffid åˆ° digest çš„å¯¹åº”å…³ç³»
 tree /var/lib/docker/image/overlay2/distribution/
/var/lib/docker/image/overlay2/distribution/
â”œâ”€â”€ diffid-by-digest
â”‚Â Â  â””â”€â”€ sha256
â”‚Â Â      â”œâ”€â”€ e2334dd9fee4b77e48a8f2d793904118a3acf26f1f2e72a3d79c6cae993e07f0
â”‚Â Â      â””â”€â”€ ec237e1426f0de497da8c0951d5db1d2b7f155d207cfc0df02f3fb0508a3036a
â””â”€â”€ v2metadata-by-diffid
    â””â”€â”€ sha256
        â”œâ”€â”€ 5b0d2d635df829f65d0ffb45eab2c3124a470c4f385d6602bda0c21c5248bcab
        â””â”€â”€ f53db92a80829925f8ec12396ab68569d7a769d9ab94983b86dbe6b26ae3d1fa

 æ ¹æ® diffid è·å– digest
~ cat /var/lib/docker/image/overlay2/distribution/v2metadata-by-diffid/sha256/5b0d2d635df829f65d0ffb45eab2c3124a470c4f385d6602bda0c21c5248bcab | python -m json.tool
[
    &#123;
        <span class="hljs-string">"Digest"</span>: <span class="hljs-string">"sha256:e2334dd9fee4b77e48a8f2d793904118a3acf26f1f2e72a3d79c6cae993e07f0"</span>,
        <span class="hljs-string">"HMAC"</span>: <span class="hljs-string">""</span>,
        <span class="hljs-string">"SourceRepository"</span>: <span class="hljs-string">"docker.io/library/busybox"</span>
    &#125;
]

 æ ¹æ® digest è·å– diffid
 cat /var/lib/docker/image/overlay2/distribution/diffid-by-digest/sha256/e2334dd9fee4b77e48a8f2d793904118a3acf26f1f2e72a3d79c6cae993e07f0
sha256:5b0d2d635df829f65d0ffb45eab2c3124a470c4f385d6602bda0c21c5248bcab

 æ ¹æ® digest æŸ¥çœ‹ layer å…ƒæ•°æ®
 <span class="hljs-built_in">cd</span> /var/lib/docker/image/overlay2/layerdb/sha256/5b0d2d635df829f65d0ffb45eab2c3124a470c4f385d6602bda0c21c5248bcab/ &amp;&amp; ls -l
total 24
-rw-r--r-- 1 root root    64 Apr 30 15:21 cache-id
-rw-r--r-- 1 root root    71 Apr 30 15:21 diff
-rw-r--r-- 1 root root     7 Apr 30 15:21 size
-rw-r--r-- 1 root root 12159 Apr 30 15:21 tar-split.json.gz

 cache-id æ˜¯ docker ä¸‹è½½ layer çš„æ—¶å€™éšæœºç”Ÿæˆ uuidï¼ŒæŒ‡å‘çœŸæ­£å­˜æ”¾ layer æ–‡ä»¶çš„ä½ç½®ã€‚
 cat cache-id
486d3aacd2ee026b1e3db99b23e32a9f60d0972f7224fd53657a41943c871872

 diff æ–‡ä»¶å­˜æ”¾ layer çš„ diffid
 cat diff
sha256:5b0d2d635df829f65d0ffb45eab2c3124a470c4f385d6602bda0c21c5248bcab

 size å½“å‰ layer çš„å¤§å°ï¼Œå•ä½æ˜¯å­—èŠ‚ã€‚
 tar-split.json.gz æ˜¯ layer çš„ split æ–‡ä»¶ï¼Œé€šè¿‡è¿™ä¸ªæ–‡ä»¶å¯ä»¥è¿˜åŸ layer çš„ tar åŒ…ï¼Œåœ¨ docker save å¯¼å‡º image æ—¶ä¼šç”¨åˆ°ã€‚

 layer æ•°æ®ï¼Œimage å­˜å‚¨æ•°æ®ï¼Œä½¿ç”¨ cache-id è®¿é—®ã€‚
 <span class="hljs-built_in">cd</span> /var/lib/docker/overlay2/486d3aacd2ee026b1e3db99b23e32a9f60d0972f7224fd53657a41943c871872
 tree -d diff/
diff/
â”œâ”€â”€ bin
â”œâ”€â”€ dev
â”œâ”€â”€ etc
â”‚Â Â  â””â”€â”€ network
â”‚Â Â      â”œâ”€â”€ <span class="hljs-keyword">if</span>-down.d
â”‚Â Â      â”œâ”€â”€ <span class="hljs-keyword">if</span>-post-down.d
â”‚Â Â      â”œâ”€â”€ <span class="hljs-keyword">if</span>-pre-up.d
â”‚Â Â      â””â”€â”€ <span class="hljs-keyword">if</span>-up.d
â”œâ”€â”€ home
â”œâ”€â”€ root
â”œâ”€â”€ tmp
â”œâ”€â”€ usr
â”‚Â Â  â””â”€â”€ sbin
â””â”€â”€ var
    â”œâ”€â”€ spool
    â”‚Â Â  â””â”€â”€ mail
    â””â”€â”€ www

 manifest å­˜å‚¨å¯¹ config å’Œ layer çš„ sha256 + media <span class="hljs-built_in">type</span> æè¿°ï¼Œç›®çš„å°±æ˜¯ä¸ºäº†ä¸‹è½½ config å’Œ layerã€‚ä¸‹è½½å®Œæˆåï¼Œmanifest çš„ä½¿å‘½å°±å®Œæˆäº†ï¼Œæ‰€ä»¥åœ¨æœ¬åœ°æ²¡æœ‰å­˜å‚¨ manifest æ–‡ä»¶ã€‚</code></pre></div><h3 id="docker-ç©ºé—´ç®¡ç†"><a href="#docker-ç©ºé—´ç®¡ç†" class="headerlink" title="docker ç©ºé—´ç®¡ç†"></a>docker ç©ºé—´ç®¡ç†</h3><div class="hljs"><pre><code class="hljs bash"> æŸ¥çœ‹ç©ºé—´
 docker system df
TYPE                TOTAL               ACTIVE              SIZE                RECLAIMABLE
Images              11                  9                   1.084GB             202.9MB (18%)
Containers          18                  12                  10.61kB             0B (0%)
Local Volumes       0                   0                   0B                  0B
Build Cache         0                   0                   0B                  0B

 æ¸…ç†æ–‡ä»¶ç³»ç»Ÿ
 docker system prune
WARNING! This will remove:
  - all stopped containers
  - all networks not used by at least one container
  - all dangling images
  - all dangling build cache

Are you sure you want to <span class="hljs-built_in">continue</span>? [y/N]

 å¼ºåˆ¶æ¸…ç†ï¼Œå¿½ç•¥ä¾èµ–å…³ç³»ã€‚
 docker system prune -a -f

 æ¸…ç†æ‰€æœ‰çŠ¶æ€ä¸º &lt;none&gt; çš„ image
 docker image prune
WARNING! This will remove all images without at least one container associated to them.
Are you sure you want to <span class="hljs-built_in">continue</span>? [y/N]

 å¼ºåˆ¶æ¸…ç† imageï¼Œå¿½ç•¥ä¾èµ–å…³ç³»ã€‚
 docker image prune -a
WARNING! This will remove all images without at least one container associated to them.
Are you sure you want to <span class="hljs-built_in">continue</span>? [y/N]

 æ¸…ç†æ— ç”¨æ•°æ®å·
 docker volume ls
 docker volume prune
WARNING! This will remove all <span class="hljs-built_in">local</span> volumes not used by at least one container.
Are you sure you want to <span class="hljs-built_in">continue</span>? [y/N]

 æ¸…ç†æ‰€æœ‰åœæ­¢çš„å®¹å™¨
 docker container prune
WARNING! This will remove all stopped containers.
Are you sure you want to <span class="hljs-built_in">continue</span>? [y/N]</code></pre></div><h2 id="é…ç½®ç³»ç»Ÿ"><a href="#é…ç½®ç³»ç»Ÿ" class="headerlink" title="é…ç½®ç³»ç»Ÿ"></a><strong>é…ç½®ç³»ç»Ÿ</strong></h2><p>å†…æ ¸å…³é—­ swap</p><div class="hljs"><pre><code class="hljs bash">ansible ins -m shell -a <span class="hljs-string">'echo "vm.swappiness = 0" &gt;&gt; /etc/sysctl.conf &amp;&amp; sysctl -p'</span></code></pre></div><p>é›¶æ—¶å…³é—­ swap</p><div class="hljs"><pre><code class="hljs bash">ansible ins -m shell -a <span class="hljs-string">'swapoff -a'</span></code></pre></div><p>ç³»ç»Ÿ fstab å…³é—­é…ç½®</p><div class="hljs"><pre><code class="hljs bash">ansible ins -m shell -a <span class="hljs-string">"sed -i 's/^[^#].*swap*/#&amp;/g'  /etc/fstab &amp;&amp; chattr +i /etc/fstab"</span></code></pre></div><ul><li>WARNING: No swap limit support</li></ul><div class="hljs"><pre><code class="hljs bash">sed -i <span class="hljs-string">'/GRUB_CMDLINE_LINUX=/cGRUB_CMDLINE_LINUX="net.ifnames=0 biosdevname=0 console=tty0 console=ttyS0,115200 cgroup_enable=memory swapaccount=1"'</span> /etc/default/grub

ansible ins -m copy -a <span class="hljs-string">'src=/etc/default/grub dest=/etc/default/grub'</span>

ansible ins -m shell -a <span class="hljs-string">'update-grub &amp;&amp; shutdown -r +1 "reboot for turnoff swap"'</span></code></pre></div><h2 id="å®‰è£…-kubernetes"><a href="#å®‰è£…-kubernetes" class="headerlink" title="å®‰è£… kubernetes"></a><strong>å®‰è£… kubernetes</strong></h2><ul><li>æ¿€æ´»æ—§ç‰ˆæœ¬çš„é˜²ç«å¢™é…ç½®ï¼ˆ19å¹´ä¹‹åçš„æ“ä½œç³»ç»Ÿéœ€è¦ä¿®æ”¹ï¼‰</li></ul><div class="hljs"><pre><code class="hljs bash">apt install -y iptables arptables ebtables

update-alternatives --<span class="hljs-built_in">set</span> iptables /usr/sbin/iptables-legacy

update-alternatives --<span class="hljs-built_in">set</span> ip6tables /usr/sbin/ip6tables-legacy

update-alternatives --<span class="hljs-built_in">set</span> arptables /usr/sbin/arptables-legacy

update-alternatives --<span class="hljs-built_in">set</span> ebtables /usr/sbin/ebtables-legacy</code></pre></div><h2 id="é…ç½®-kubernetes-repo"><a href="#é…ç½®-kubernetes-repo" class="headerlink" title="é…ç½® kubernetes repo"></a>é…ç½® kubernetes repo</h2><div class="hljs"><pre><code class="hljs bash">æ‰¹é‡é…ç½®
ansible ins -m shell -a <span class="hljs-string">'curl -fsSL https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg | apt-key add -'</span>

ansible ins -m shell -a <span class="hljs-string">'add-apt-repository "deb [arch=amd64] https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main"'</span></code></pre></div><h2 id="å®‰è£…-kubernetes-åŸºç¡€å·¥å…·"><a href="#å®‰è£…-kubernetes-åŸºç¡€å·¥å…·" class="headerlink" title="å®‰è£… kubernetes åŸºç¡€å·¥å…·"></a>å®‰è£… kubernetes åŸºç¡€å·¥å…·</h2><div class="hljs"><pre><code class="hljs bash">æŸ¥çœ‹å½“å‰æ”¯æŒçš„ç‰ˆæœ¬ä¿¡æ¯
apt-cache policy kubeadm

ansible ins -m shell -a <span class="hljs-string">'apt update &amp;&amp; apt install -y kubelet=1.17.3-00 kubeadm=1.17.3-00 kubectl=1.17.3-00'</span></code></pre></div><h2 id="é…ç½®-driver"><a href="#é…ç½®-driver" class="headerlink" title="é…ç½® driver"></a>é…ç½® driver</h2><div class="hljs"><pre><code class="hljs bash"> cat &gt; /etc/default/kubelet &lt;&lt;EOF
KUBELET_EXTRA_ARGS=--cgroup-driver=systemd
EOF

 cat &gt; /etc/systemd/system/kubelet.service.d/10-kubeadm.conf &lt;&lt;EOF
[Service]
Environment=<span class="hljs-string">"KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf --cgroup-driver=systemd"</span>
Environment=<span class="hljs-string">"KUBELET_CONFIG_ARGS=--config=/var/lib/kubelet/config.yaml"</span>
<span class="hljs-comment"># è¿™æ˜¯ "kubeadm init" å’Œ "kubeadm join" è¿è¡Œæ—¶ç”Ÿæˆçš„æ–‡ä»¶ï¼ŒåŠ¨æ€åœ°å¡«å…… KUBELET_KUBEADM_ARGS å˜é‡</span>
EnvironmentFile=-/var/lib/kubelet/kubeadm-flags.env
<span class="hljs-comment"># è¿™æ˜¯ä¸€ä¸ªæ–‡ä»¶ï¼Œç”¨æˆ·åœ¨ä¸å¾—å·²ä¸‹å¯ä»¥å°†å…¶ç”¨ä½œæ›¿ä»£ kubelet argsã€‚</span>
<span class="hljs-comment"># ç”¨æˆ·æœ€å¥½ä½¿ç”¨ .NodeRegistration.KubeletExtraArgs å¯¹è±¡åœ¨é…ç½®æ–‡ä»¶ä¸­æ›¿ä»£ã€‚</span>
<span class="hljs-comment"># KUBELET_EXTRA_ARGS åº”è¯¥ä»æ­¤æ–‡ä»¶ä¸­è·å–ã€‚</span>
EnvironmentFile=-/etc/default/kubelet
ExecStart=
ExecStart=/usr/bin/kubelet <span class="hljs-variable">$KUBELET_KUBECONFIG_ARGS</span> <span class="hljs-variable">$KUBELET_CONFIG_ARGS</span> <span class="hljs-variable">$KUBELET_KUBEADM_ARGS</span> <span class="hljs-variable">$KUBELET_EXTRA_ARGS</span>

EOF

ansible ins -m copy -a <span class="hljs-string">'src=/etc/default/kubelet dest=/etc/default/kubelet'</span>
ansible ins -m copy -a <span class="hljs-string">'src=/etc/systemd/system/kubelet.service.d/10-kubeadm.conf dest=/etc/systemd/system/kubelet.service.d/10-kubeadm.conf'</span></code></pre></div><h3 id="é‡å¯-kubelet"><a href="#é‡å¯-kubelet" class="headerlink" title="é‡å¯ kubelet"></a>é‡å¯ kubelet</h3><div class="hljs"><pre><code class="hljs bash">ansible ins -m shell -a <span class="hljs-string">'systemctl daemon-reload &amp;&amp; systemctl restart kubelet'</span></code></pre></div><h2 id="å¼€å¯-ipvs-æ”¯æŒ"><a href="#å¼€å¯-ipvs-æ”¯æŒ" class="headerlink" title="å¼€å¯ ipvs æ”¯æŒ"></a>å¼€å¯ ipvs æ”¯æŒ</h2><h3 id="é…ç½®å†…æ ¸æ”¯æŒ-IP-è½¬å‘"><a href="#é…ç½®å†…æ ¸æ”¯æŒ-IP-è½¬å‘" class="headerlink" title="é…ç½®å†…æ ¸æ”¯æŒ IP è½¬å‘"></a>é…ç½®å†…æ ¸æ”¯æŒ IP è½¬å‘</h3><div class="hljs"><pre><code class="hljs bash">ansible ins -m shell -a <span class="hljs-string">'grep net.ipv4.ip_forward /etc/sysctl.conf &amp;&amp; sed -i "/net.ipv4.ip_forward/c\net.ipv4.ip_forward=1" /etc/sysctl.conf || echo "net.ipv4.ip_forward=1" &gt;&gt; /etc/sysctl.conf'</span>
ansible ins -m shell -a <span class="hljs-string">'grep net.bridge.bridge-nf-call-iptables /etc/sysctl.conf &amp;&amp; sed -i "/net.bridge.bridge-nf-call-iptables/c\net.bridge.bridge-nf-call-iptables=1" /etc/sysctl.conf || echo "net.bridge.bridge-nf-call-iptables=1" &gt;&gt; /etc/sysctl.conf'</span>
ansible ins -m shell -a <span class="hljs-string">'grep net.bridge.bridge-nf-call-ip6tables /etc/sysctl.conf &amp;&amp; sed -i "/net.bridge.bridge-nf-call-ip6tables/c\net.bridge.bridge-nf-call-ip6tables=1" /etc/sysctl.conf || echo "net.bridge.bridge-nf-call-ip6tables=1" &gt;&gt; /etc/sysctl.conf'</span>

ansible ins -m shell -a <span class="hljs-string">'sysctl -p'</span></code></pre></div><h3 id="é…ç½®å†…æ ¸åŠ è½½-ipvs-æ¨¡å—"><a href="#é…ç½®å†…æ ¸åŠ è½½-ipvs-æ¨¡å—" class="headerlink" title="é…ç½®å†…æ ¸åŠ è½½ ipvs æ¨¡å—"></a>é…ç½®å†…æ ¸åŠ è½½ ipvs æ¨¡å—</h3><div class="hljs"><pre><code class="hljs bash"> cat &gt; /tmp/ipvs.modules &lt;&lt;EOF
<span class="hljs-meta">#!/bin/bash</span>
ipvs_modules=<span class="hljs-string">"ip_vs ip_vs_lc ip_vs_wlc ip_vs_rr ip_vs_wrr ip_vs_lblc ip_vs_lblcr ip_vs_dh ip_vs_sh ip_vs_fo ip_vs_nq ip_vs_sed ip_vs_ftp nf_conntrack_ipv4"</span>
<span class="hljs-keyword">for</span> kernel_module <span class="hljs-keyword">in</span> \<span class="hljs-variable">$&#123;ipvs_modules&#125;</span>; <span class="hljs-keyword">do</span>
    /sbin/modinfo -F filename \<span class="hljs-variable">$&#123;kernel_module&#125;</span> &gt; /dev/null 2&gt;&amp;1
    <span class="hljs-keyword">if</span> [ $? -eq 0 ]; <span class="hljs-keyword">then</span>
        /sbin/modprobe \<span class="hljs-variable">$&#123;kernel_module&#125;</span>
    <span class="hljs-keyword">fi</span>
<span class="hljs-keyword">done</span>
EOF

 ansible ins -m copy -a <span class="hljs-string">'src=/tmp/ipvs.modules dest=/tmp/ipvs.modules mode=0755'</span>
 ansible ins -m shell -a <span class="hljs-string">'/tmp/ipvs.modules'</span>

 éªŒè¯ ipvs æ”¯æŒ
 ansible ins -m shell -a <span class="hljs-string">'lsmod | grep ip_vs'</span></code></pre></div><h3 id="å®‰è£…-ipvsadm"><a href="#å®‰è£…-ipvsadm" class="headerlink" title="å®‰è£… ipvsadm"></a>å®‰è£… ipvsadm</h3><div class="hljs"><pre><code class="hljs bash">ansible ins -m yum -a <span class="hljs-string">'name=ipvsadm state=present'</span></code></pre></div><h2 id="åˆ›å»º-kubernetes-é›†ç¾¤"><a href="#åˆ›å»º-kubernetes-é›†ç¾¤" class="headerlink" title="åˆ›å»º kubernetes é›†ç¾¤"></a><strong>åˆ›å»º kubernetes é›†ç¾¤</strong></h2><p>ukm01 ä¸Šæ‰§è¡Œ</p><ul><li>å†…ç½‘è´Ÿè½½å‡è¡¡åœ°å€ 10.10.34.89</li></ul><div class="hljs"><pre><code class="hljs bash"> é…ç½®æ–‡ä»¶åˆ›å»ºï¼Œå¯ä»¥ä¿®æ”¹è¾ƒå¤šçš„å‚æ•°ã€‚
 cat &gt; kubeadm-config.yaml &lt;&lt;EOF
apiVersion: kubeadm.k8s.io/v1beta2
kind: InitConfiguration
localAPIEndpoint:
  advertiseAddress: 0.0.0.0
  bindPort: 6443
nodeRegistration:
  criSocket: /var/run/dockershim.sock
  kubeletExtraArgs:
    cgroup-driver: <span class="hljs-string">"systemd"</span>
  ignorePreflightErrors:
  - IsPrivilegedUser
---
apiVersion: kubeadm.k8s.io/v1beta2
kind: ClusterConfiguration
controlPlaneEndpoint: 192.168.0.113:6443
certificatesDir: /etc/kubernetes/pki
clusterName: kubernetes
dns:
  <span class="hljs-built_in">type</span>: CoreDNS
apiServer:
  timeoutForControlPlane: 5m0s
  extraArgs:
    authorization-mode: <span class="hljs-string">"Node,RBAC"</span>
  certSANs:
  - <span class="hljs-string">"192.168.0.113"</span>
  - <span class="hljs-string">"192.168.0.110"</span>
  - <span class="hljs-string">"192.168.0.111"</span>
  - <span class="hljs-string">"192.168.0.112"</span>
  - <span class="hljs-string">"node1"</span>
  - <span class="hljs-string">"node2"</span>
  - <span class="hljs-string">"node3"</span>
  - <span class="hljs-string">"kubernetes"</span>
  - <span class="hljs-string">"kubernetes.default"</span>
  - <span class="hljs-string">"kubernetes.default.svc"</span>
  - <span class="hljs-string">"kubernetes.default.svc.cluster"</span>
  - <span class="hljs-string">"kubernetes.default.svc.cluster.local"</span>
controllerManager:
  extraArgs:
    <span class="hljs-string">"node-cidr-mask-size"</span>: <span class="hljs-string">"20"</span>
scheduler:
  extraArgs:
    address: <span class="hljs-string">"0.0.0.0"</span>
dns:
  <span class="hljs-built_in">type</span>: CoreDNS
etcd:
  <span class="hljs-built_in">local</span>:
    dataDir: /var/lib/etcd
imageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers
kubernetesVersion: v1.20.1
networking:
  dnsDomain: cluster.local
  serviceSubnet: 10.96.0.0/12
  podSubnet: 192.168.0.0/16
---
apiVersion: kubeproxy.config.k8s.io/v1alpha1
kind: KubeProxyConfiguration
bindAddress: 0.0.0.0
mode: ipvs   
ipvs:
  scheduler: wlc
  syncPeriod: 30s
  minSyncPeriod: 5s
  tcpTimeout: 0s
  tcpFinTimeout: 0s
  udpTimeout: 0s
---
apiVersion: kubelet.config.k8s.io/v1beta1
kind: KubeletConfiguration
cgroupDriver: systemd
rotateCertificates: <span class="hljs-literal">true</span>
EOF


 éªŒè¯ kubeadm-config é…ç½®
 kubeadm init --config=kubeadm-config.yaml --upload-certs

 åˆ›å»ºé›†ç¾¤
 kubeadm init --config=kubeadm-config.yaml --upload-certs

 å‚æ•°åŒ–åˆ›å»ºé›†ç¾¤
 kubeadm init \
  --apiserver-bind-port 8443 \
  --control-plane-endpoint <span class="hljs-string">"10.10.34.89:8443"</span> \
  --image-repository registry.cn-hangzhou.aliyuncs.com/google_containers \
  --kubernetes-version=v1.17.3 \
  --upload-certs \
  --pod-network-cidr=10.100.0.0/16 \
  --service-cidr=10.96.0.0/12 \

...
kubeadm join 10.10.34.89:8443 --token 7nf8wp.cefgemzgn5xcdmln \
    --discovery-token-ca-cert-hash sha256:36b328e0052c7f8e7cac826d70b21bef0cdc4e0505fddc8200c52b8b01605da3 \
    --control-plane --certificate-key bd9fc1600d2db4f2b323a17b2b7be4f4234d7ed8705bc64976dcd43d929a24a8
...
kubeadm join 10.10.34.89:8443 --token 7nf8wp.cefgemzgn5xcdmln \
    --discovery-token-ca-cert-hash sha256:36b328e0052c7f8e7cac826d70b21bef0cdc4e0505fddc8200c52b8b01605da3</code></pre></div><h3 id="kubeadm-init-å¸¸ç”¨å‚æ•°"><a href="#kubeadm-init-å¸¸ç”¨å‚æ•°" class="headerlink" title="kubeadm init å¸¸ç”¨å‚æ•°"></a>kubeadm init å¸¸ç”¨å‚æ•°</h3><div class="hljs"><pre><code class="hljs bash">--apiserver-advertise-address string
API æœåŠ¡å™¨æ‰€å…¬å¸ƒçš„å…¶æ­£åœ¨ç›‘å¬çš„ IP åœ°å€ã€‚å¦‚æœæœªè®¾ç½®ï¼Œåˆ™ä½¿ç”¨é»˜è®¤ç½‘ç»œæ¥å£ã€‚
--apiserver-bind-port int32     é»˜è®¤å€¼ï¼š6443
API æœåŠ¡å™¨ç»‘å®šçš„ç«¯å£ã€‚
--apiserver-cert-extra-sans stringSlice
ç”¨äº API Server æœåŠ¡è¯ä¹¦çš„å¯é€‰é™„åŠ ä¸»é¢˜å¤‡ç”¨åç§°ï¼ˆSANï¼‰ã€‚å¯ä»¥æ˜¯ IP åœ°å€å’Œ DNS åç§°ã€‚
--cert-dir string     é»˜è®¤å€¼ï¼š<span class="hljs-string">"/etc/kubernetes/pki"</span>
ä¿å­˜å’Œå­˜å‚¨è¯ä¹¦çš„è·¯å¾„ã€‚
--certificate-key string
ç”¨äºåŠ å¯† kubeadm-certs Secret ä¸­çš„æ§åˆ¶å¹³é¢è¯ä¹¦çš„å¯†é’¥ã€‚
--config string
kubeadm é…ç½®æ–‡ä»¶çš„è·¯å¾„ã€‚
--control-plane-endpoint string
ä¸ºæ§åˆ¶å¹³é¢æŒ‡å®šä¸€ä¸ªç¨³å®šçš„ IP åœ°å€æˆ– DNS åç§°ã€‚
--cri-socket string
è¦è¿æ¥çš„ CRI å¥—æ¥å­—çš„è·¯å¾„ã€‚å¦‚æœä¸ºç©ºï¼Œåˆ™ kubeadm å°†å°è¯•è‡ªåŠ¨æ£€æµ‹æ­¤å€¼ï¼›ä»…å½“å®‰è£…äº†å¤šä¸ª CRI æˆ–å…·æœ‰éæ ‡å‡† CRI æ’æ§½æ—¶ï¼Œæ‰ä½¿ç”¨æ­¤é€‰é¡¹ã€‚
--dry-run
ä¸è¦åº”ç”¨ä»»ä½•æ›´æ”¹ï¼›åªæ˜¯è¾“å‡ºå°†è¦æ‰§è¡Œçš„æ“ä½œã€‚
-k, --experimental-kustomize string
ç”¨äºå­˜å‚¨ kustomize ä¸ºé™æ€ pod æ¸…å•æ‰€æä¾›çš„è¡¥ä¸çš„è·¯å¾„ã€‚
--feature-gates string
ä¸€ç»„ç”¨æ¥æè¿°å„ç§åŠŸèƒ½ç‰¹æ€§çš„é”®å€¼ï¼ˆkey=valueï¼‰å¯¹ã€‚é€‰é¡¹æ˜¯ï¼š
IPv6DualStack=<span class="hljs-literal">true</span>|<span class="hljs-literal">false</span> (ALPHA - default=<span class="hljs-literal">false</span>)
-h, --<span class="hljs-built_in">help</span>
init æ“ä½œçš„å¸®åŠ©å‘½ä»¤
--ignore-preflight-errors stringSlice
é”™è¯¯å°†æ˜¾ç¤ºä¸ºè­¦å‘Šçš„æ£€æŸ¥åˆ—è¡¨ï¼›ä¾‹å¦‚ï¼š<span class="hljs-string">'IsPrivilegedUser,Swap'</span>ã€‚å–å€¼ä¸º <span class="hljs-string">'all'</span> æ—¶å°†å¿½ç•¥æ£€æŸ¥ä¸­çš„æ‰€æœ‰é”™è¯¯ã€‚
--image-repository string     é»˜è®¤å€¼ï¼š<span class="hljs-string">"k8s.gcr.io"</span>
é€‰æ‹©ç”¨äºæ‹‰å–æ§åˆ¶å¹³é¢é•œåƒçš„å®¹å™¨ä»“åº“
--kubernetes-version string     é»˜è®¤å€¼ï¼š<span class="hljs-string">"stable-1"</span>
ä¸ºæ§åˆ¶å¹³é¢é€‰æ‹©ä¸€ä¸ªç‰¹å®šçš„ Kubernetes ç‰ˆæœ¬ã€‚
--node-name string
æŒ‡å®šèŠ‚ç‚¹çš„åç§°ã€‚
--pod-network-cidr string
æŒ‡æ˜ pod ç½‘ç»œå¯ä»¥ä½¿ç”¨çš„ IP åœ°å€æ®µã€‚å¦‚æœè®¾ç½®äº†è¿™ä¸ªå‚æ•°ï¼Œæ§åˆ¶å¹³é¢å°†ä¼šä¸ºæ¯ä¸€ä¸ªèŠ‚ç‚¹è‡ªåŠ¨åˆ†é… CIDRsã€‚
--service-cidr string     é»˜è®¤å€¼ï¼š<span class="hljs-string">"10.96.0.0/12"</span>
ä¸ºæœåŠ¡çš„è™šæ‹Ÿ IP åœ°å€å¦å¤–æŒ‡å®š IP åœ°å€æ®µ
--service-dns-domain string     é»˜è®¤å€¼ï¼š<span class="hljs-string">"cluster.local"</span>
ä¸ºæœåŠ¡å¦å¤–æŒ‡å®šåŸŸåï¼Œä¾‹å¦‚ï¼š<span class="hljs-string">"myorg.internal"</span>ã€‚
--skip-certificate-key-print
ä¸è¦æ‰“å°ç”¨äºåŠ å¯†æ§åˆ¶å¹³é¢è¯ä¹¦çš„å¯†é’¥ã€‚
--skip-phases stringSlice
è¦è·³è¿‡çš„é˜¶æ®µåˆ—è¡¨
--skip-token-print
è·³è¿‡æ‰“å° <span class="hljs-string">'kubeadm init'</span> ç”Ÿæˆçš„é»˜è®¤å¼•å¯¼ä»¤ç‰Œã€‚
--token string
è¿™ä¸ªä»¤ç‰Œç”¨äºå»ºç«‹æ§åˆ¶å¹³é¢èŠ‚ç‚¹ä¸å·¥ä½œèŠ‚ç‚¹é—´çš„åŒå‘é€šä¿¡ã€‚æ ¼å¼ä¸º [a-z0-9]&#123;6&#125;\.[a-z0-9]&#123;16&#125; - ç¤ºä¾‹ï¼šabcdef.0123456789abcdef
--token-ttl duration     é»˜è®¤å€¼ï¼š24h0m0s
ä»¤ç‰Œè¢«è‡ªåŠ¨åˆ é™¤ä¹‹å‰çš„æŒç»­æ—¶é—´ï¼ˆä¾‹å¦‚ 1 sï¼Œ2 mï¼Œ3 hï¼‰ã€‚å¦‚æœè®¾ç½®ä¸º <span class="hljs-string">'0'</span>ï¼Œåˆ™ä»¤ç‰Œå°†æ°¸ä¸è¿‡æœŸ
--upload-certs
å°†æ§åˆ¶å¹³é¢è¯ä¹¦ä¸Šä¼ åˆ° kubeadm-certs Secretã€‚</code></pre></div><h3 id="master-èŠ‚ç‚¹æ‰©å®¹"><a href="#master-èŠ‚ç‚¹æ‰©å®¹" class="headerlink" title="master èŠ‚ç‚¹æ‰©å®¹"></a>master èŠ‚ç‚¹æ‰©å®¹</h3><p>åœ¨ ukm02 ukm03 ä¸Šæ‰§è¡Œ</p><div class="hljs"><pre><code class="hljs bash">ansible master:\!ans -m shell -a <span class="hljs-string">'kubeadm join 10.10.34.89:8443 \</span>
<span class="hljs-string">   --apiserver-bind-port 8443 \</span>
<span class="hljs-string">   --control-plane \</span>
<span class="hljs-string">   --token 7nf8wp.cefgemzgn5xcdmln \</span>
<span class="hljs-string">   --discovery-token-ca-cert-hash sha256:36b328e0052c7f8e7cac826d70b21bef0cdc4e0505fddc8200c52b8b01605da3 \</span>
<span class="hljs-string">   --control-plane --certificate-key bd9fc1600d2db4f2b323a17b2b7be4f4234d7ed8705bc64976dcd43d929a24a8'</span></code></pre></div><h3 id="kubeadm-join-å¸¸ç”¨å‚æ•°"><a href="#kubeadm-join-å¸¸ç”¨å‚æ•°" class="headerlink" title="kubeadm join å¸¸ç”¨å‚æ•°"></a>kubeadm join å¸¸ç”¨å‚æ•°</h3><div class="hljs"><pre><code class="hljs bash">--apiserver-advertise-address string
å¦‚æœè¯¥èŠ‚ç‚¹æ‰˜ç®¡ä¸€ä¸ªæ–°çš„æ§åˆ¶å¹³é¢å®ä¾‹ï¼Œåˆ™ API æœåŠ¡å™¨å°†å…¬å¸ƒå…¶æ­£åœ¨ä¾¦å¬çš„ IP åœ°å€ã€‚å¦‚æœæœªè®¾ç½®ï¼Œåˆ™ä½¿ç”¨é»˜è®¤ç½‘ç»œæ¥å£ã€‚
--apiserver-bind-port int32     é»˜è®¤å€¼: 6443
å¦‚æœèŠ‚ç‚¹åº”è¯¥æ‰˜ç®¡æ–°çš„æ§åˆ¶å¹³é¢å®ä¾‹ï¼Œåˆ™ä¸º API æœåŠ¡å™¨è¦ç»‘å®šçš„ç«¯å£ã€‚
--certificate-key string
ä½¿ç”¨æ­¤å¯†é’¥å¯ä»¥è§£å¯†ç”± init ä¸Šä¼ çš„è¯ä¹¦ secretã€‚
--config string
kubeadm é…ç½®æ–‡ä»¶çš„è·¯å¾„ã€‚
--control-plane
åœ¨æ­¤èŠ‚ç‚¹ä¸Šåˆ›å»ºä¸€ä¸ªæ–°çš„æ§åˆ¶å¹³é¢å®ä¾‹
--cri-socket string
è¦è¿æ¥çš„ CRI å¥—æ¥å­—çš„è·¯å¾„ã€‚å¦‚æœä¸ºç©ºï¼Œåˆ™ kubeadm å°†å°è¯•è‡ªåŠ¨æ£€æµ‹æ­¤å€¼ï¼›ä»…å½“å®‰è£…äº†å¤šä¸ª CRI æˆ–å…·æœ‰éæ ‡å‡† CRI æ’æ§½æ—¶ï¼Œæ‰ä½¿ç”¨æ­¤é€‰é¡¹ã€‚
--discovery-file string
å¯¹äºåŸºäºæ–‡ä»¶çš„å‘ç°ï¼Œç»™å‡ºç”¨äºåŠ è½½é›†ç¾¤ä¿¡æ¯çš„æ–‡ä»¶æˆ–è€… URLã€‚
--discovery-token string
å¯¹äºåŸºäºä»¤ç‰Œçš„å‘ç°ï¼Œè¯¥ä»¤ç‰Œç”¨äºéªŒè¯ä» API æœåŠ¡å™¨è·å–çš„é›†ç¾¤ä¿¡æ¯ã€‚
--discovery-token-ca-cert-hash stringSlice
å¯¹åŸºäºä»¤ç‰Œçš„å‘ç°ï¼ŒéªŒè¯æ ¹ CA å…¬é’¥æ˜¯å¦ä¸æ­¤å“ˆå¸ŒåŒ¹é… (æ ¼å¼: <span class="hljs-string">"&lt;type&gt;:&lt;value&gt;"</span>)ã€‚
--discovery-token-unsafe-skip-ca-verification
å¯¹äºåŸºäºä»¤ç‰Œçš„å‘ç°ï¼Œå…è®¸åœ¨æœªå…³è” --discovery-token-ca-cert-hash å‚æ•°çš„æƒ…å†µä¸‹æ·»åŠ èŠ‚ç‚¹ã€‚
-k, --experimental-kustomize string
ç”¨äºå­˜å‚¨ kustomize ä¸ºé™æ€ pod æ¸…å•æ‰€æä¾›çš„è¡¥ä¸çš„è·¯å¾„ã€‚
-h, --<span class="hljs-built_in">help</span>
join æ“ä½œçš„å¸®åŠ©å‘½ä»¤
--ignore-preflight-errors stringSlice
é”™è¯¯å°†æ˜¾ç¤ºä¸ºè­¦å‘Šçš„æ£€æŸ¥åˆ—è¡¨ï¼›ä¾‹å¦‚ï¼š<span class="hljs-string">'IsPrivilegedUser,Swap'</span>ã€‚å–å€¼ä¸º <span class="hljs-string">'all'</span> æ—¶å°†å¿½ç•¥æ£€æŸ¥ä¸­çš„æ‰€æœ‰é”™è¯¯ã€‚
--node-name string
æŒ‡å®šèŠ‚ç‚¹çš„åç§°
--skip-phases stringSlice
è¦è·³è¿‡çš„é˜¶æ®µåˆ—è¡¨
--tls-bootstrap-token string
æŒ‡å®šåœ¨åŠ å…¥èŠ‚ç‚¹æ—¶ç”¨äºä¸´æ—¶é€šè¿‡ Kubernetes æ§åˆ¶å¹³é¢è¿›è¡Œèº«ä»½éªŒè¯çš„ä»¤ç‰Œã€‚
--token string
å¦‚æœæœªæä¾›è¿™äº›å€¼ï¼Œåˆ™å°†å®ƒä»¬ç”¨äº discovery-token ä»¤ç‰Œå’Œ tls-bootstrap ä»¤ç‰Œã€‚</code></pre></div><p>é…ç½® master ç®¡ç†å‘½ä»¤</p><div class="hljs"><pre><code class="hljs bash">ansible master -m shell -a <span class="hljs-string">'echo "source &lt;(kubectl completion bash)" &gt;&gt; ~/.bashrc'</span>

ansible master -m shell -a <span class="hljs-string">'mkdir -p /root/.kube'</span>

ansible master -m copy -a <span class="hljs-string">'src=/etc/kubernetes/admin.conf dest=/root/.kube/config mode=0600 owner=root remote_src=yes'</span></code></pre></div><h3 id="éªŒè¯-master"><a href="#éªŒè¯-master" class="headerlink" title="éªŒè¯ master"></a>éªŒè¯ master</h3><div class="hljs"><pre><code class="hljs bash"> kubectl get nodes -l node-role.kubernetes.io/master
NAME    STATUS     ROLES    AGE     VERSION
ukm01   NotReady   master   3m26s   v1.17.3
ukm02   NotReady   master   1m56s   v1.17.3
ukm03   NotReady   master   2m14s   v1.17.3

 kubectl get pods --all-namespaces
NAMESPACE     NAME                            READY   STATUS    RESTARTS   AGE
kube-system   coredns-7f9c544f75-h9hmm        0/1     Pending   0          3m55s
kube-system   coredns-7f9c544f75-k9pb7        0/1     Pending   0          3m55s
kube-system   etcd-ukm01                      1/1     Running   1          20s
kube-system   etcd-ukm02                      1/1     Running   0          40s
kube-system   etcd-ukm03                      1/1     Running   0          20s
kube-system   kube-apiserver-ukm01            1/1     Running   0          20s
kube-system   kube-apiserver-ukm02            1/1     Running   0          20s
kube-system   kube-apiserver-ukm03            1/1     Running   0          20s
kube-system   kube-controller-manager-ukm01   1/1     Running   3          5m17s
kube-system   kube-controller-manager-ukm02   1/1     Running   0          74s
kube-system   kube-controller-manager-ukm03   1/1     Running   2          3m27s
kube-system   kube-proxy-4fkkx                1/1     Running   0          3m27s
kube-system   kube-proxy-5vjpc                1/1     Running   0          2m9s
kube-system   kube-proxy-plx2x                1/1     Running   0          3m55s
kube-system   kube-scheduler-ukm01            1/1     Running   2          5m17s
kube-system   kube-scheduler-ukm02            1/1     Running   0          75s
kube-system   kube-scheduler-ukm03            1/1     Running   0          3m26s</code></pre></div><h3 id="ç¡®è®¤-kube-proxy-å¯ç”¨äº†-ipvs-æ¨¡å¼"><a href="#ç¡®è®¤-kube-proxy-å¯ç”¨äº†-ipvs-æ¨¡å¼" class="headerlink" title="ç¡®è®¤ kube-proxy å¯ç”¨äº† ipvs æ¨¡å¼"></a>ç¡®è®¤ kube-proxy å¯ç”¨äº† ipvs æ¨¡å¼</h3><div class="hljs"><pre><code class="hljs bash"> kubectl get configmaps kube-proxy -n kube-system -o yaml
...
    iptables:
      masqueradeAll: <span class="hljs-literal">false</span>
      masqueradeBit: null
      minSyncPeriod: 0s
      syncPeriod: 0s
    ipvs:
      excludeCIDRs: null
      minSyncPeriod: 5s
      scheduler: wlc
      strictARP: <span class="hljs-literal">false</span>
      syncPeriod: 30s
      tcpFinTimeout: 0s
      tcpTimeout: 0s
      udpTimeout: 0s
    kind: KubeProxyConfiguration
    metricsBindAddress: <span class="hljs-string">""</span>
    mode: ipvs
...</code></pre></div><h3 id="æŸ¥çœ‹-ipvs-è½¬å‘æƒ…å†µ"><a href="#æŸ¥çœ‹-ipvs-è½¬å‘æƒ…å†µ" class="headerlink" title="æŸ¥çœ‹ ipvs è½¬å‘æƒ…å†µ"></a>æŸ¥çœ‹ ipvs è½¬å‘æƒ…å†µ</h3><div class="hljs"><pre><code class="hljs bash"> ipvsadm -Ln
IP Virtual Server version 1.2.1 (size=4096)
Prot LocalAddress:Port Scheduler Flags
  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn
TCP  10.96.0.1:443 wlc
  -&gt; 10.10.34.92:8443             Masq    1      0          0
  -&gt; 10.10.34.93:8443             Masq    1      0          0
  -&gt; 10.10.34.94:8443             Masq    1      0          0
TCP  10.96.0.10:53 wlc
TCP  10.96.0.10:9153 wlc
UDP  10.96.0.10:53 wlc</code></pre></div><h3 id="æŸ¥çœ‹ç½‘å¡ä¿¡æ¯"><a href="#æŸ¥çœ‹ç½‘å¡ä¿¡æ¯" class="headerlink" title="æŸ¥çœ‹ç½‘å¡ä¿¡æ¯"></a>æŸ¥çœ‹ç½‘å¡ä¿¡æ¯</h3><div class="hljs"><pre><code class="hljs bash"> ip addr
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000
    link/ether fa:16:3e:cf:28:7f brd ff:ff:ff:ff:ff:ff
    inet 10.10.34.92/24 brd 10.10.34.255 scope global eth0
       valid_lft forever preferred_lft forever
    inet6 fe80::f816:3eff:fecf:287f/64 scope link
       valid_lft forever preferred_lft forever
3: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default
    link/ether 02:42:81:5a:e2:7c brd ff:ff:ff:ff:ff:ff
    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0
       valid_lft forever preferred_lft forever
    inet6 fe80::42:81ff:fe5a:e27c/64 scope link
       valid_lft forever preferred_lft forever
6: tunl0@NONE: &lt;NOARP,UP,LOWER_UP&gt; mtu 1440 qdisc noqueue state UNKNOWN group default qlen 1000
    link/ipip 0.0.0.0 brd 0.0.0.0
46: kube-ipvs0: &lt;BROADCAST,NOARP&gt; mtu 1500 qdisc noop state DOWN group default
    link/ether 6a:10:8f:81:3e:61 brd ff:ff:ff:ff:ff:ff
    inet 10.96.0.10/32 brd 10.96.0.10 scope global kube-ipvs0
       valid_lft forever preferred_lft forever
    inet 10.96.0.1/32 brd 10.96.0.1 scope global kube-ipvs0
       valid_lft forever preferred_lft forever</code></pre></div><h3 id="æ›´æ–°-etcd-é›†ç¾¤é…ç½®"><a href="#æ›´æ–°-etcd-é›†ç¾¤é…ç½®" class="headerlink" title="æ›´æ–° etcd é›†ç¾¤é…ç½®"></a>æ›´æ–° etcd é›†ç¾¤é…ç½®</h3><div class="hljs"><pre><code class="hljs bash">ansible master -m shell -a <span class="hljs-string">'sed -i "/--initial-cluster=/c\    - --initial-cluster=ukm01=https://10.10.34.92:2380,ukm02=https://10.10.34.93:2380,ukm03=https://10.10.34.94:2380" /etc/kubernetes/manifests/etcd.yaml'</span>

apiserver é»˜è®¤è®¿é—®æœ¬åœ°çš„ etcd èŠ‚ç‚¹ï¼Œå¦‚æœéœ€è¦è®¿é—®é›†ç¾¤æ‰€æœ‰èŠ‚ç‚¹å¯ä»¥ä¿®æ”¹é…ç½®ã€‚
ansible master -m shell -a <span class="hljs-string">'sed -i "/- --etcd-servers/c\    - --etcd-servers=https://10.10.34.92:2379,https://10.10.34.93:2379,https://10.10.34.94:2379" /etc/kubernetes/manifests/kube-apiserver.yaml'</span></code></pre></div><h3 id="æŸ¥çœ‹-etcd-æˆå‘˜çŠ¶æ€"><a href="#æŸ¥çœ‹-etcd-æˆå‘˜çŠ¶æ€" class="headerlink" title="æŸ¥çœ‹ etcd æˆå‘˜çŠ¶æ€"></a>æŸ¥çœ‹ etcd æˆå‘˜çŠ¶æ€</h3><p>æˆå‘˜ç®¡ç†å‘½ä»¤ï¼š</p><ul><li>add - æ·»åŠ é›†ç¾¤æˆå‘˜</li><li>list - æŸ¥çœ‹é›†ç¾¤æˆå‘˜ä¿¡æ¯</li><li>promote - æå‡é›†ç¾¤æˆå‘˜æƒé™</li><li>remove - ä»é›†ç¾¤ä¸­åˆ é™¤æˆå‘˜ID</li><li>update - æ›´æ–°é›†ç¾¤æˆå‘˜ä¿¡æ¯</li></ul><div class="hljs"><pre><code class="hljs bash"> kubectl <span class="hljs-built_in">exec</span> -n kube-system -it $(kubectl get pod  -n kube-system -l component=etcd -o jsonpath=<span class="hljs-string">'&#123;.items[0].metadata.name&#125;'</span>) sh

 æˆ–è€…ä¸‹è½½ etcdctl
 curl -L -O https://github.com/etcd-io/etcd/releases/download/v3.4.3/etcd-v3.4.3-linux-amd64.tar.gz
 tar xzvf etcd-v3.4.3-linux-amd64.tar.gz
 mv etcd-v3.4.3-linux-amd64/etcd* /usr/<span class="hljs-built_in">local</span>/bin/

 ETCDCTL=3 etcdctl --write-out=table \
  --cert /etc/kubernetes/pki/etcd/peer.crt \
  --key /etc/kubernetes/pki/etcd/peer.key \
  --cacert /etc/kubernetes/pki/etcd/ca.crt \
  --endpoints https://ukm01:2379,https://ukm02:2379,https://ukm03:2379 \
  member list

+------------------+---------+-------+--------------------------+--------------------------+------------+
|        ID        | STATUS  | NAME  |        PEER ADDRS        |       CLIENT ADDRS       | IS LEARNER |
+------------------+---------+-------+--------------------------+--------------------------+------------+
| 7a212ff0c04f1e82 | started | ukm02 | https://10.10.34.93:2380 | https://10.10.34.93:2379 |      <span class="hljs-literal">false</span> |
| ae758756c0c6b09c | started | ukm01 | https://10.10.34.92:2380 | https://10.10.34.92:2379 |      <span class="hljs-literal">false</span> |
| ff90415307bdc341 | started | ukm03 | https://10.10.34.94:2380 | https://10.10.34.94:2379 |      <span class="hljs-literal">false</span> |
+------------------+---------+-------+--------------------------+--------------------------+------------+</code></pre></div><h3 id="éªŒè¯-etcd-é›†ç¾¤çŠ¶æ€"><a href="#éªŒè¯-etcd-é›†ç¾¤çŠ¶æ€" class="headerlink" title="éªŒè¯ etcd é›†ç¾¤çŠ¶æ€"></a>éªŒè¯ etcd é›†ç¾¤çŠ¶æ€</h3><div class="hljs"><pre><code class="hljs bash"> ETCDCTL=3 etcdctl --cluster --write-out=table \
  --cert /etc/kubernetes/pki/etcd/peer.crt \
  --key /etc/kubernetes/pki/etcd/peer.key \
  --cacert /etc/kubernetes/pki/etcd/ca.crt \
  --endpoints https://ukm01:2379,https://ukm02:2379,https://ukm03:2379 \
  endpoint status

+--------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+
|         ENDPOINT         |        ID        | VERSION | DB SIZE | IS LEADER | IS LEARNER | RAFT TERM | RAFT INDEX | RAFT APPLIED INDEX | ERRORS |
+--------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+
| https://10.10.34.94:2379 | 4677521bc1465d7e |   3.4.3 |  1.5 MB |     <span class="hljs-literal">false</span> |      <span class="hljs-literal">false</span> |         9 |       1671 |               1671 |        |
| https://10.10.34.92:2379 | ae758756c0c6b09c |   3.4.3 |  1.6 MB |     <span class="hljs-literal">false</span> |      <span class="hljs-literal">false</span> |         9 |       1671 |               1671 |        |
| https://10.10.34.93:2379 | ff3c0a769521e2c2 |   3.4.3 |  1.5 MB |      <span class="hljs-literal">true</span> |      <span class="hljs-literal">false</span> |         9 |       1671 |               1671 |        |
+--------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+</code></pre></div><h3 id="æŸ¥çœ‹-etcd-èŠ‚ç‚¹å¥åº·çŠ¶å†µ"><a href="#æŸ¥çœ‹-etcd-èŠ‚ç‚¹å¥åº·çŠ¶å†µ" class="headerlink" title="æŸ¥çœ‹ etcd èŠ‚ç‚¹å¥åº·çŠ¶å†µ"></a>æŸ¥çœ‹ etcd èŠ‚ç‚¹å¥åº·çŠ¶å†µ</h3><div class="hljs"><pre><code class="hljs bash"> ETCDCTL=3 etcdctl --cluster --write-out=table \
  --cert /etc/kubernetes/pki/etcd/peer.crt \
  --key /etc/kubernetes/pki/etcd/peer.key \
  --cacert /etc/kubernetes/pki/etcd/ca.crt \
  --endpoints https://ukm01:2379,https://ukm02:2379,https://ukm03:2379 \
  endpoint health

+--------------------------+--------+-------------+-------+
|         ENDPOINT         | HEALTH |    TOOK     | ERROR |
+--------------------------+--------+-------------+-------+
| https://10.10.34.93:2379 |   <span class="hljs-literal">true</span> | 18.384799ms |       |
| https://10.10.34.94:2379 |   <span class="hljs-literal">true</span> | 18.649393ms |       |
| https://10.10.34.92:2379 |   <span class="hljs-literal">true</span> | 18.831792ms |       |
+--------------------------+--------+-------------+-------+</code></pre></div><h3 id="å¢åŠ -node-èŠ‚ç‚¹"><a href="#å¢åŠ -node-èŠ‚ç‚¹" class="headerlink" title="å¢åŠ  node èŠ‚ç‚¹"></a>å¢åŠ  node èŠ‚ç‚¹</h3><p>åœ¨ uki01 uki02 uki03 ukn01 ukn02 ukn03 ä¸Šæ‰§è¡Œ</p><div class="hljs"><pre><code class="hljs bash">ansible infra:worker -m shell -a <span class="hljs-string">'kubeadm join 10.10.34.89:8443 \</span>
<span class="hljs-string">   --token 7nf8wp.cefgemzgn5xcdmln \</span>
<span class="hljs-string">   --discovery-token-ca-cert-hash sha256:36b328e0052c7f8e7cac826d70b21bef0cdc4e0505fddc8200c52b8b01605da3'</span></code></pre></div><h2 id="SDN"><a href="#SDN" class="headerlink" title="SDN"></a><strong>SDN</strong></h2><h3 id="å®‰è£…-calico"><a href="#å®‰è£…-calico" class="headerlink" title="å®‰è£… calico"></a>å®‰è£… calico</h3><div class="hljs"><pre><code class="hljs bash">curl -L https://docs.projectcalico.org/manifests/calico.yaml -o calico.yaml

kubectl apply -f calico.yaml</code></pre></div><h3 id="æŸ¥çœ‹æœåŠ¡çŠ¶æ€"><a href="#æŸ¥çœ‹æœåŠ¡çŠ¶æ€" class="headerlink" title="æŸ¥çœ‹æœåŠ¡çŠ¶æ€"></a>æŸ¥çœ‹æœåŠ¡çŠ¶æ€</h3><ul><li>node èŠ‚ç‚¹å¤„äº Ready çŠ¶æ€</li><li>æ¯ä¸ªèŠ‚ç‚¹ä¸Šéƒ½æœ‰ä¸€ä¸ª podï¼šcalico-node</li></ul><div class="hljs"><pre><code class="hljs bash"> kubectl get nodes
NAME    STATUS   ROLES    AGE     VERSION
uki01   Ready    infra    5m      v1.17.3
uki02   Ready    infra    5m      v1.17.3
uki03   Ready    infra    5m      v1.17.3
ukm01   Ready    master   8m      v1.17.3
ukm02   Ready    master   8m      v1.17.3
ukm03   Ready    master   8m      v1.17.3
ukn01   Ready    worker   5m      v1.17.3
ukn02   Ready    worker   5m      v1.17.3
ukn03   Ready    worker   5m      v1.17.3

 watch kubectl get pods -n kube-system -o wide
NAME                                       READY   STATUS    RESTARTS   AGE   IP                NODE    NOMINATED NODE   READINESS GATES
...
calico-kube-controllers-5b644bc49c-7xjzr   1/1     Running   0          30s   192.168.144.138   uki01   &lt;none&gt;           &lt;none&gt;
calico-node-57rns                          1/1     Running   0          30s   10.10.34.98       ukn01   &lt;none&gt;           &lt;none&gt;
calico-node-6p8z7                          1/1     Running   0          30s   10.10.34.100      ukn03   &lt;none&gt;           &lt;none&gt;
calico-node-77jwm                          1/1     Running   0          30s   172.17.0.1        ukn02   &lt;none&gt;           &lt;none&gt;
calico-node-c4gxf                          1/1     Running   0          30s   10.10.34.95       uki01   &lt;none&gt;           &lt;none&gt;
calico-node-gdb5j                          1/1     Running   0          30s   10.10.34.96       uki02   &lt;none&gt;           &lt;none&gt;
calico-node-gmzmf                          1/1     Running   0          30s   10.10.34.93       ukm02   &lt;none&gt;           &lt;none&gt;
calico-node-jdd2f                          1/1     Running   0          30s   10.10.34.97       uki03   &lt;none&gt;           &lt;none&gt;
calico-node-mrr49                          1/1     Running   0          30s   10.10.34.92       ukm01   &lt;none&gt;           &lt;none&gt;
calico-node-w5b7r                          1/1     Running   0          30s   10.10.34.94       ukm03   &lt;none&gt;           &lt;none&gt;
...

 kubectl get ippool -o wide
NAME                  AGE
default-ipv4-ippool   2m</code></pre></div><h3 id="éªŒè¯-calico"><a href="#éªŒè¯-calico" class="headerlink" title="éªŒè¯ calico"></a>éªŒè¯ calico</h3><div class="hljs"><pre><code class="hljs bash"> ä¸‹è½½ calicoctl
 curl -L -o /usr/<span class="hljs-built_in">local</span>/bin/calicoctl https://github.com/projectcalico/calicoctl/releases/download/v3.11.2/calicoctl-linux-amd64
 chmod +x /usr/<span class="hljs-built_in">local</span>/bin/calicoctl

 ä½¿ç”¨ kubernetes api å­˜å‚¨æ•°æ®
 mkdir -p /etc/calico
 cat &gt; /etc/calico/calicoctl.cfg &lt;&lt;EOF
apiVersion: projectcalico.org/v3
kind: CalicoAPIConfig
metadata:
spec:
  datastoreType: kubernetes
  kubeconfig: /etc/kubernetes/admin.conf   ä½¿ç”¨ admin é…ç½®
  k8sAPIEndpoint: https://10.10.34.89:8443
  k8sCertFile: /etc/kubernetes/pki/apiserver-kubelet-client.crt
  k8sKeyFile: /etc/kubernetes/pki/apiserver-kubelet-client.key
  k8sCAFile: /etc/kubernetes/pki/ca.crt
EOF

 ä½¿ç”¨ç‹¬ç«‹çš„ etcd å­˜å‚¨æ•°æ®
 mkdir -p /etc/calico
 cat &gt; /etc/calico/calicoctl.cfg &lt;&lt;EOF
apiVersion: projectcalico.org/v3
kind: CalicoAPIConfig
metadata:
spec:
  datastoreType: etcdv3
  etcdEndpoints: https://10.10.34.92:2379,https://10.10.34.93:2379,https://10.10.34.94:2379
  etcdKeyFile: /etc/kubernetes/pki/etcd/peer.key
  etcdCertFile: /etc/kubernetes/pki/etcd/peer.crt
  etcdCACertFile: /etc/kubernetes/pki/etcd/ca.crt
EOF

 æŸ¥çœ‹ node
 calicoctl node status
Calico process is running.

IPv4 BGP status
+--------------+-------------------+-------+------------+-------------+
| PEER ADDRESS |     PEER TYPE     | STATE |   SINCE    |    INFO     |
+--------------+-------------------+-------+------------+-------------+
| 10.10.34.95  | node-to-node mesh | up    | 2020-04-11 | Established |
| 10.10.34.96  | node-to-node mesh | up    | 2020-04-11 | Established |
| 10.10.34.97  | node-to-node mesh | up    | 2020-04-11 | Established |
| 10.10.34.93  | node-to-node mesh | up    | 2020-04-11 | Established |
| 10.10.34.94  | node-to-node mesh | up    | 2020-04-11 | Established |
| 10.10.34.98  | node-to-node mesh | up    | 2020-04-11 | Established |
| 10.10.34.99  | node-to-node mesh | up    | 2020-04-11 | Established |
| 10.10.34.100 | node-to-node mesh | up    | 2020-04-11 | Established |
+--------------+-------------------+-------+------------+-------------+

IPv6 BGP status
No IPv6 peers found.


 calicoctl get node -o wide
NAME    ASN       IPV4              IPV6
uki01   (64512)   10.10.34.95/24
uki02   (64512)   10.10.34.96/24
uki03   (64512)   10.10.34.97/24
ukm01   (64512)   10.10.34.92/24
ukm02   (64512)   10.10.34.93/24
ukm03   (64512)   10.10.34.94/24
ukn01   (64512)   10.10.34.98/24
ukn02   (64512)   10.10.34.99/24
ukn03   (64512)   10.10.34.100/24

 æŸ¥çœ‹ ippool
 calicoctl get ippool -o wide
NAME                  CIDR             NAT    IPIPMODE   VXLANMODE   DISABLED   SELECTOR
default-ipv4-ippool   192.168.0.0/16   <span class="hljs-literal">true</span>   Always     Never       <span class="hljs-literal">false</span>      all()

 æŸ¥çœ‹ ip çŠ¶æ€
 calicoctl ipam show
+----------+----------------+-----------+------------+--------------+
| GROUPING |      CIDR      | IPS TOTAL | IPS IN USE |   IPS FREE   |
+----------+----------------+-----------+------------+--------------+
| IP Pool  | 192.168.0.0/16 |     65536 | 5  (0%)    | 65531 (100%) |
+----------+----------------+-----------+------------+--------------+

 æŸ¥çœ‹å·²åˆ†é…çš„æœåŠ¡èŠ‚ç‚¹ä¿¡æ¯
 calicoctl get workloadendpoints -o wide -n kube-system
NAMESPACE     NAME                                                          WORKLOAD                                   NODE    NETWORKS             INTERFACE         PROFILES                                                  NATS
kube-system   ukn02-k8s-calico--kube--controllers--75d56dfc47--xfdp9-eth0   calico-kube-controllers-75d56dfc47-xfdp9   ukn02   192.168.33.65/32     calif1d8798ea15   kns.kube-system,ksa.kube-system.calico-kube-controllers
kube-system   uki02-k8s-coredns--546565776c--mkx9n-eth0                     coredns-546565776c-mkx9n                   uki02   192.168.225.1/32     calib399f7859db   kns.kube-system,ksa.kube-system.coredns
kube-system   ukn03-k8s-coredns--546565776c--v9wgw-eth0                     coredns-546565776c-v9wgw                   ukn03   192.168.188.129/32   cali4fffc74a7b2   kns.kube-system,ksa.kube-system.coredns</code></pre></div><h3 id="calico-ç½‘ç»œèµ„æº"><a href="#calico-ç½‘ç»œèµ„æº" class="headerlink" title="calico ç½‘ç»œèµ„æº"></a>calico ç½‘ç»œèµ„æº</h3><p>å®˜æ–¹æ–‡æ¡£ï¼š <code>https://docs.projectcalico.org/reference/resources/overview</code></p><ul><li>BGPConfiguration</li></ul><div class="hljs"><pre><code class="hljs yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">projectcalico.org/v3</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">BGPConfiguration</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">default</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">logSeverityScreen:</span> <span class="hljs-string">Info</span>
  <span class="hljs-attr">nodeToNodeMeshEnabled:</span> <span class="hljs-literal">true</span>
  <span class="hljs-attr">asNumber:</span> <span class="hljs-number">63400</span>
  <span class="hljs-attr">serviceClusterIPs:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">cidr:</span> <span class="hljs-number">10.96</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span><span class="hljs-string">/12</span>
  <span class="hljs-attr">serviceExternalIPs:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">cidr:</span> <span class="hljs-number">104.244</span><span class="hljs-number">.42</span><span class="hljs-number">.129</span><span class="hljs-string">/32</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">cidr:</span> <span class="hljs-number">172.217</span><span class="hljs-number">.3</span><span class="hljs-number">.0</span><span class="hljs-string">/24</span></code></pre></div><ul><li>BGPPeer</li></ul><div class="hljs"><pre><code class="hljs yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">projectcalico.org/v3</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">BGPPeer</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">some.name</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">node:</span> <span class="hljs-string">rack1-host1</span>
  <span class="hljs-attr">peerIP:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.1</span>
  <span class="hljs-attr">asNumber:</span> <span class="hljs-number">63400</span></code></pre></div><ul><li>FelixConfiguration</li></ul><div class="hljs"><pre><code class="hljs yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">projectcalico.org/v3</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">FelixConfiguration</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">default</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">ipv6Support:</span> <span class="hljs-literal">false</span>
  <span class="hljs-attr">ipipMTU:</span> <span class="hljs-number">1400</span>
  <span class="hljs-attr">chainInsertMode:</span> <span class="hljs-string">Append</span></code></pre></div><ul><li>GlobalNetworkPolicy</li></ul><div class="hljs"><pre><code class="hljs yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">projectcalico.org/v3</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">GlobalNetworkPolicy</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">allow-tcp-6379</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">selector:</span> <span class="hljs-string">role</span> <span class="hljs-string">==</span> <span class="hljs-string">'database'</span>
  <span class="hljs-attr">types:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">Ingress</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">Egress</span>
  <span class="hljs-attr">ingress:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">action:</span> <span class="hljs-string">Allow</span>
    <span class="hljs-attr">metadata:</span>
      <span class="hljs-attr">annotations:</span>
        <span class="hljs-attr">from:</span> <span class="hljs-string">frontend</span>
        <span class="hljs-attr">to:</span> <span class="hljs-string">database</span>
    <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span>
    <span class="hljs-attr">source:</span>
      <span class="hljs-attr">selector:</span> <span class="hljs-string">role</span> <span class="hljs-string">==</span> <span class="hljs-string">'frontend'</span>
    <span class="hljs-attr">destination:</span>
      <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-number">6379</span>
  <span class="hljs-attr">egress:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">action:</span> <span class="hljs-string">Allow</span></code></pre></div><ul><li>GlobalNetworkSet</li></ul><div class="hljs"><pre><code class="hljs yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">projectcalico.org/v3</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">GlobalNetworkSet</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">a-name-for-the-set</span>
  <span class="hljs-attr">labels:</span>
    <span class="hljs-attr">role:</span> <span class="hljs-string">external-database</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">nets:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-number">198.51</span><span class="hljs-number">.100</span><span class="hljs-number">.0</span><span class="hljs-string">/28</span>
  <span class="hljs-bullet">-</span> <span class="hljs-number">203.0</span><span class="hljs-number">.113</span><span class="hljs-number">.0</span><span class="hljs-string">/24</span></code></pre></div><ul><li>HostEndpoint</li></ul><div class="hljs"><pre><code class="hljs yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">projectcalico.org/v3</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">HostEndpoint</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">some.name</span>
  <span class="hljs-attr">labels:</span>
    <span class="hljs-attr">type:</span> <span class="hljs-string">production</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">interfaceName:</span> <span class="hljs-string">eth0</span>
  <span class="hljs-attr">node:</span> <span class="hljs-string">myhost</span>
  <span class="hljs-attr">expectedIPs:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-number">192.168</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>
  <span class="hljs-bullet">-</span> <span class="hljs-number">192.168</span><span class="hljs-number">.0</span><span class="hljs-number">.2</span>
  <span class="hljs-attr">profiles:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">profile1</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">profile2</span>
  <span class="hljs-attr">ports:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">some-port</span>
    <span class="hljs-attr">port:</span> <span class="hljs-number">1234</span>
    <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">another-port</span>
    <span class="hljs-attr">port:</span> <span class="hljs-number">5432</span>
    <span class="hljs-attr">protocol:</span> <span class="hljs-string">UDP</span></code></pre></div><ul><li>IPPool</li></ul><div class="hljs"><pre><code class="hljs yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">projectcalico.org/v3</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">IPPool</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">my.ippool-1</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">cidr:</span> <span class="hljs-number">10.1</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span><span class="hljs-string">/16</span>
  <span class="hljs-attr">ipipMode:</span> <span class="hljs-string">CrossSubnet</span>
  <span class="hljs-attr">natOutgoing:</span> <span class="hljs-literal">true</span>
  <span class="hljs-attr">disabled:</span> <span class="hljs-literal">false</span>
  <span class="hljs-attr">nodeSelector:</span> <span class="hljs-string">all()</span></code></pre></div><ul><li>NetworkPolicy</li></ul><div class="hljs"><pre><code class="hljs yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">projectcalico.org/v3</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">NetworkPolicy</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">allow-tcp-6379</span>
  <span class="hljs-attr">namespace:</span> <span class="hljs-string">production</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">selector:</span> <span class="hljs-string">role</span> <span class="hljs-string">==</span> <span class="hljs-string">'database'</span>
  <span class="hljs-attr">types:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">Ingress</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">Egress</span>
  <span class="hljs-attr">ingress:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">action:</span> <span class="hljs-string">Allow</span>
    <span class="hljs-attr">metadata:</span>
      <span class="hljs-attr">annotations:</span>
        <span class="hljs-attr">from:</span> <span class="hljs-string">frontend</span>
        <span class="hljs-attr">to:</span> <span class="hljs-string">database</span>
    <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span>
    <span class="hljs-attr">source:</span>
      <span class="hljs-attr">selector:</span> <span class="hljs-string">role</span> <span class="hljs-string">==</span> <span class="hljs-string">'frontend'</span>
    <span class="hljs-attr">destination:</span>
      <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-number">6379</span>
  <span class="hljs-attr">egress:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">action:</span> <span class="hljs-string">Allow</span></code></pre></div><ul><li>NetworkSet</li></ul><div class="hljs"><pre><code class="hljs yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">projectcalico.org/v3</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">NetworkSet</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">external-database</span>
  <span class="hljs-attr">namespace:</span> <span class="hljs-string">staging</span>
  <span class="hljs-attr">labels:</span>
    <span class="hljs-attr">role:</span> <span class="hljs-string">db</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">nets:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-number">198.51</span><span class="hljs-number">.100</span><span class="hljs-number">.0</span><span class="hljs-string">/28</span>
  <span class="hljs-bullet">-</span> <span class="hljs-number">203.0</span><span class="hljs-number">.113</span><span class="hljs-number">.0</span><span class="hljs-string">/24</span></code></pre></div><ul><li>Node</li></ul><div class="hljs"><pre><code class="hljs yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">projectcalico.org/v3</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Node</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">node-hostname</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">bgp:</span>
    <span class="hljs-attr">asNumber:</span> <span class="hljs-number">64512</span>
    <span class="hljs-attr">ipv4Address:</span> <span class="hljs-number">10.244</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><span class="hljs-string">/24</span>
    <span class="hljs-attr">ipv6Address:</span> <span class="hljs-number">2001</span><span class="hljs-string">:db8:85a3::8a2e:370:7334/120</span>
    <span class="hljs-attr">ipv4IPIPTunnelAddr:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span></code></pre></div><ul><li>Profile</li></ul><div class="hljs"><pre><code class="hljs yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">projectcalico.org/v3</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Profile</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">dev-apps</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">ingress:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">action:</span> <span class="hljs-string">Deny</span>
    <span class="hljs-attr">source:</span>
      <span class="hljs-attr">nets:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-number">10.0</span><span class="hljs-number">.20</span><span class="hljs-number">.0</span><span class="hljs-string">/24</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">action:</span> <span class="hljs-string">Allow</span>
    <span class="hljs-attr">source:</span>
      <span class="hljs-attr">selector:</span> <span class="hljs-string">stage</span> <span class="hljs-string">==</span> <span class="hljs-string">'development'</span>
  <span class="hljs-attr">egress:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">action:</span> <span class="hljs-string">Allow</span>
  <span class="hljs-attr">labelsToApply:</span>
    <span class="hljs-attr">stage:</span> <span class="hljs-string">development</span></code></pre></div><ul><li>WorkloadEndpoint</li></ul><div class="hljs"><pre><code class="hljs yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">projectcalico.org/v3</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">WorkloadEndpoint</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">node1-k8s-my--nginx--b1337a-eth0</span>
  <span class="hljs-attr">namespace:</span> <span class="hljs-string">default</span>
  <span class="hljs-attr">labels:</span>
    <span class="hljs-attr">app:</span> <span class="hljs-string">frontend</span>
    <span class="hljs-attr">projectcalico.org/namespace:</span> <span class="hljs-string">default</span>
    <span class="hljs-attr">projectcalico.org/orchestrator:</span> <span class="hljs-string">k8s</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">node:</span> <span class="hljs-string">node1</span>
  <span class="hljs-attr">orchestrator:</span> <span class="hljs-string">k8s</span>
  <span class="hljs-attr">endpoint:</span> <span class="hljs-string">eth0</span>
  <span class="hljs-attr">containerID:</span> <span class="hljs-number">1337495556942031415926535</span>
  <span class="hljs-attr">pod:</span> <span class="hljs-string">my-nginx-b1337a</span>
  <span class="hljs-attr">endpoint:</span> <span class="hljs-string">eth0</span>
  <span class="hljs-attr">interfaceName:</span> <span class="hljs-string">cali0ef24ba</span>
  <span class="hljs-attr">mac:</span> <span class="hljs-string">ca:fe:1d:52:bb:e9</span>
  <span class="hljs-attr">ipNetworks:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-number">192.168</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span><span class="hljs-string">/32</span>
  <span class="hljs-attr">profiles:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">profile1</span>
  <span class="hljs-attr">ports:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">some-port</span>
    <span class="hljs-attr">port:</span> <span class="hljs-number">1234</span>
    <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">another-port</span>
    <span class="hljs-attr">port:</span> <span class="hljs-number">5432</span>
    <span class="hljs-attr">protocol:</span> <span class="hljs-string">UDP</span></code></pre></div><h3 id="å¸è½½-calico"><a href="#å¸è½½-calico" class="headerlink" title="å¸è½½ calico"></a>å¸è½½ calico</h3><div class="hljs"><pre><code class="hljs bash">kubectl delete -f calico.yaml</code></pre></div><h3 id="åˆ é™¤-calico-é…ç½®"><a href="#åˆ é™¤-calico-é…ç½®" class="headerlink" title="åˆ é™¤ calico é…ç½®"></a>åˆ é™¤ calico é…ç½®</h3><div class="hljs"><pre><code class="hljs bash">ansible ins -m shell -a <span class="hljs-string">'rm -rf /etc/cni /opt/cni/ /var/lib/calico/'</span></code></pre></div><h2 id="é›†ç¾¤æ ¡éªŒ"><a href="#é›†ç¾¤æ ¡éªŒ" class="headerlink" title="é›†ç¾¤æ ¡éªŒ"></a>é›†ç¾¤æ ¡éªŒ</h2><h3 id="æŸ¥çœ‹é›†ç¾¤ä¿¡æ¯"><a href="#æŸ¥çœ‹é›†ç¾¤ä¿¡æ¯" class="headerlink" title="æŸ¥çœ‹é›†ç¾¤ä¿¡æ¯"></a>æŸ¥çœ‹é›†ç¾¤ä¿¡æ¯</h3><div class="hljs"><pre><code class="hljs bash"> kubectl config get-clusters
NAME
shenzhen

 kubectl cluster-info
Kubernetes master is running at https://10.10.34.89:8443
KubeDNS is running at https://10.10.34.89:8443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy</code></pre></div><h3 id="æŸ¥çœ‹-namespace"><a href="#æŸ¥çœ‹-namespace" class="headerlink" title="æŸ¥çœ‹ namespace"></a>æŸ¥çœ‹ namespace</h3><div class="hljs"><pre><code class="hljs bash"> kubectl get namespaces
NAME              STATUS   AGE
default           Active   15m
kube-node-lease   Active   15m
kube-public       Active   15m
kube-system       Active   15m</code></pre></div><h3 id="æŸ¥çœ‹èŠ‚ç‚¹çŠ¶æ€"><a href="#æŸ¥çœ‹èŠ‚ç‚¹çŠ¶æ€" class="headerlink" title="æŸ¥çœ‹èŠ‚ç‚¹çŠ¶æ€"></a>æŸ¥çœ‹èŠ‚ç‚¹çŠ¶æ€</h3><div class="hljs"><pre><code class="hljs bash"> kubectl get nodes
NAME    STATUS     ROLES    AGE    VERSION
uki01   NotReady   &lt;none&gt;   7m     v1.17.3
uki02   NotReady   &lt;none&gt;   7m    v1.17.3
uki03   NotReady   &lt;none&gt;   7m    v1.17.3
ukm01   NotReady   master   10m    v1.17.3
ukm02   NotReady   master   14m    v1.17.3
ukm03   NotReady   master   13m    v1.17.3
ukn01   NotReady   &lt;none&gt;   7m     v1.17.3
ukn02   NotReady   &lt;none&gt;   7m     v1.17.3
ukn03   NotReady   &lt;none&gt;   7m     v1.17.3</code></pre></div><h3 id="æ·»åŠ -infra-æ ‡ç­¾"><a href="#æ·»åŠ -infra-æ ‡ç­¾" class="headerlink" title="æ·»åŠ  infra æ ‡ç­¾"></a>æ·»åŠ  infra æ ‡ç­¾</h3><div class="hljs"><pre><code class="hljs bash"> kubectl label node uki01 uki02 uki03 node-role.kubernetes.io/infra=<span class="hljs-literal">true</span>
node/uki01 labeled
node/uki02 labeled
node/uki03 labeled

 kubectl get nodes -l node-role.kubernetes.io/infra
NAME    STATUS      ROLES   AGE   VERSION
uki01   NotReady    infra   8m    v1.17.3
uki02   NotReady    infra   8m    v1.17.3
uki03   NotReady    infra   8m    v1.17.3</code></pre></div><h3 id="æ·»åŠ -worker-æ ‡ç­¾"><a href="#æ·»åŠ -worker-æ ‡ç­¾" class="headerlink" title="æ·»åŠ  worker æ ‡ç­¾"></a>æ·»åŠ  worker æ ‡ç­¾</h3><div class="hljs"><pre><code class="hljs bash"> kubectl label node ukn01 ukn02 ukn03 node-role.kubernetes.io/worker=<span class="hljs-literal">true</span>
node/ukn01 labeled
node/ukn02 labeled
node/ukn03 labeled

 kubectl get nodes -l node-role.kubernetes.io/worker
NAME    STATUS      ROLES    AGE   VERSION
ukn01   NotReady    worker   8m    v1.17.3
ukn02   NotReady    worker   8m    v1.17.3
ukn03   NotReady    worker   8m    v1.17.3</code></pre></div><h3 id="æŸ¥çœ‹æ‰€æœ‰èŠ‚ç‚¹æ ‡ç­¾"><a href="#æŸ¥çœ‹æ‰€æœ‰èŠ‚ç‚¹æ ‡ç­¾" class="headerlink" title="æŸ¥çœ‹æ‰€æœ‰èŠ‚ç‚¹æ ‡ç­¾"></a>æŸ¥çœ‹æ‰€æœ‰èŠ‚ç‚¹æ ‡ç­¾</h3><div class="hljs"><pre><code class="hljs bash"> kubectl get nodes --show-labels
NAME    STATUS     ROLES    AGE     VERSION   LABELS
uki01   NotReady   infra    10m     v1.17.3   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=uki01,kubernetes.io/os=linux,node-role.kubernetes.io/infra=<span class="hljs-literal">true</span>
uki02   NotReady   infra    10m     v1.17.3   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=uki02,kubernetes.io/os=linux,node-role.kubernetes.io/infra=<span class="hljs-literal">true</span>
uki03   NotReady   infra    10m     v1.17.3   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=uki03,kubernetes.io/os=linux,node-role.kubernetes.io/infra=<span class="hljs-literal">true</span>
ukm01   NotReady   master   19m     v1.17.3   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=ukm01,kubernetes.io/os=linux,node-role.kubernetes.io/master=
ukm02   NotReady   master   17m     v1.17.3   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=ukm02,kubernetes.io/os=linux,node-role.kubernetes.io/master=
ukm03   NotReady   master   15m      v1.17.3   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=ukm03,kubernetes.io/os=linux,node-role.kubernetes.io/master=
ukn01   NotReady   worker   10m     v1.17.3   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=ukn01,kubernetes.io/os=linux,node-role.kubernetes.io/worker=<span class="hljs-literal">true</span>
ukn02   NotReady   worker   10m     v1.17.3   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=ukn02,kubernetes.io/os=linux,node-role.kubernetes.io/worker=<span class="hljs-literal">true</span>
ukn03   NotReady   worker   10m     v1.17.3   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=ukn03,kubernetes.io/os=linux,node-role.kubernetes.io/worker=<span class="hljs-literal">true</span></code></pre></div><h3 id="åˆ é™¤èŠ‚ç‚¹æ ‡ç­¾"><a href="#åˆ é™¤èŠ‚ç‚¹æ ‡ç­¾" class="headerlink" title="åˆ é™¤èŠ‚ç‚¹æ ‡ç­¾"></a>åˆ é™¤èŠ‚ç‚¹æ ‡ç­¾</h3><div class="hljs"><pre><code class="hljs bash">kubectl label node uki01 uki02 uki03 node-role.kubernetes.io/infra-</code></pre></div><h3 id="kubectl-ç®€ä»‹"><a href="#kubectl-ç®€ä»‹" class="headerlink" title="kubectl ç®€ä»‹"></a>kubectl ç®€ä»‹</h3><div class="hljs"><pre><code class="hljs docs">åŸºç¡€å‘½ä»¤:
  create        ä»æ–‡ä»¶æˆ– stdin åˆ›å»ºèµ„æº
  expose        ä¸º deploymentã€pod åˆ›å»º Service
  run           ä½¿ç”¨ image å»åˆ›å»ºä¸€ä¸ªæœåŠ¡
  set           æ›´æ–°resource ,æ¯”å¦‚æ›´æ–°envç¯å¢ƒå˜é‡ï¼Œimageï¼Œresources èµ„æºé™åˆ¶ï¼Œselector  subjectç­‰ã€‚

ç®¡ç†å‘½ä»¤:
  explain       æŸ¥çœ‹èµ„æºå®šä¹‰ï¼ˆæ–‡æ¡£ï¼‰ã€‚å¦‚ kubectl explain replicaset
  get           æœ€åŸºæœ¬çš„å¯¹è±¡æŸ¥è¯¢å‘½ä»¤ã€‚å¦‚ kubectl get nodes&#x2F;pods&#x2F;deploy&#x2F;rs&#x2F;ns&#x2F;secretç­‰ç­‰ï¼Œ åŠ -o wideæŸ¥çœ‹è¯¦ç»†ä¿¡æ¯ï¼Œ-o yaml æˆ–-o json è¾“å‡ºå…·ä½“æ ¼å¼ã€‚
  edit          ç¼–è¾‘èµ„æºé…ç½®ï¼Œå®Œæˆå¯¹è±¡çš„æ›´æ–°ã€‚
  delete        åˆ é™¤æŒ‡å®šèµ„æºï¼Œæ”¯æŒæ–‡ä»¶åã€èµ„æºåã€label selectorã€‚

éƒ¨ç½²å‘½ä»¤:
  rollout       Deployment, Daemonsetçš„å‡çº§è¿‡ç¨‹ç®¡ç†ï¼ˆæŸ¥çœ‹çŠ¶æ€statusã€æ“ä½œå†å²historyã€æš‚åœå‡çº§ã€æ¢å¤å‡çº§ã€å›æ»šç­‰ï¼‰
  scale         ä¿®æ”¹Deployment, ReplicaSet, Replication Controller, Jobçš„å®ä¾‹æ•°,å®ç°ä¸€ä¸ªå‰¯æœ¬é›†çš„æ‰‹å·¥æ‰©å±•
  autoscale     ä¸ºDeploy, RS, RCé…ç½®è‡ªåŠ¨ä¼¸ç¼©è§„åˆ™ï¼ˆä¾èµ–heapsterå’Œhpaï¼‰

é›†ç¾¤ç®¡ç†å‘½ä»¤:
  certificate   ä¿®æ”¹è¯ä¹¦èµ„æº
  cluster-info  æŸ¥çœ‹é›†ç¾¤ä¿¡æ¯
  top           æŸ¥çœ‹èµ„æºå ç”¨ç‡ (CPU&#x2F;Memory&#x2F;Storage)
  cordon        æ ‡è®°èŠ‚ç‚¹ä¸ºä¸å¯è°ƒåº¦çŠ¶æ€
  uncordon      æ ‡è®°èŠ‚ç‚¹ä¸ºå¯è°ƒåº¦çŠ¶æ€
  drain         é©±é€èŠ‚ç‚¹ä¸Šçš„ pod ï¼Œå‡†å¤‡ä¸‹çº¿ç»´æŠ¤
  taint         è®¾ç½®èŠ‚ç‚¹æ±¡ç‚¹éš”ç¦»æ ‡è®°

æ•…éšœè¯Šæ–­å‘½ä»¤:
  describe      æŸ¥çœ‹èµ„æºè¯¦æƒ…
  logs          æŸ¥çœ‹ pod å†…å®¹å™¨çš„æ—¥å¿—
  attach        Attach åˆ° pod å†…çš„ä¸€ä¸ªå®¹å™¨
  exec          è¿›å…¥æŒ‡å®šå®¹å™¨æ‰§è¡Œå‘½ä»¤
  port-forward  ä¸º pod åˆ›å»ºæœ¬åœ°ç«¯å£æ˜ å°„
  proxy         ä¸º Kubernetes API server åˆ›å»ºä»£ç†
  cp            å®¹å™¨å†…å¤–&#x2F;å®¹å™¨é—´æ–‡ä»¶æ‹·è´
  auth          æˆæƒæ ¡éªŒ

é«˜çº§å‘½ä»¤:
  diff          æ¯”è¾ƒå½“å‰ç‰ˆæœ¬å’Œè¦éƒ¨ç½²çš„ç‰ˆæœ¬
  apply         ä»æ–‡ä»¶æˆ–stdinåˆ›å»º&#x2F;æ›´æ–°èµ„æº
  patch         ä½¿ç”¨strategic merge patchè¯­æ³•æ›´æ–°å¯¹è±¡çš„æŸäº›å­—æ®µ
  replace       ä»æ–‡ä»¶æˆ–stdinæ›´æ–°èµ„æº
  wait          å®éªŒåŠŸèƒ½ï¼šç­‰å¾…ä¸€ç§æˆ–å¤šç§èµ„æºçš„ç‰¹å®šæ¡ä»¶ã€‚
  convert       åœ¨ä¸åŒAPIç‰ˆæœ¬ä¹‹é—´è½¬æ¢å¯¹è±¡å®šä¹‰
  kustomize     ä»æŒ‡å®šç›®å½•æˆ–è¿œç¨‹URLæ„å»ºKustomizationç›®æ ‡ã€‚

é…ç½®å‘½ä»¤:
  label         ç»™èµ„æºè®¾ç½®label
  annotate      ç»™èµ„æºè®¾ç½®annotation
  completion    è·å–shellè‡ªåŠ¨è¡¥å…¨è„šæœ¬ (bash or zsh)

å…¶ä»–å‘½ä»¤:
  alpha         Alphaä¸­åŠŸèƒ½çš„å‘½ä»¤
  api-resources æ‰“å°å½“å‰ kubernetes API æ‰€æ”¯æŒçš„å‘½ä»¤èµ„æº
  api-versions  æ‰“å°å½“å‰ kubernetes API æ‰€æ”¯æŒçš„ api æ¥å£ä»¥åŠç‰ˆæœ¬ä¿¡æ¯
  config        ä¿®æ”¹kubectlé…ç½®ï¼ˆkubeconfigæ–‡ä»¶ï¼‰ï¼Œå¦‚contextã€‚
  plugin        æä¾›ç”¨äºä¸æ’ä»¶äº¤äº’çš„æ’ä»¶ç¨‹åºã€‚
  version       æ‰“å°å½“å‰ kubernetes çš„æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ç‰ˆæœ¬</code></pre></div><h3 id="è°ƒåº¦ç­–ç•¥-Scheduling-Policies"><a href="#è°ƒåº¦ç­–ç•¥-Scheduling-Policies" class="headerlink" title="è°ƒåº¦ç­–ç•¥ Scheduling Policies"></a>è°ƒåº¦ç­–ç•¥ Scheduling Policies</h3><p>kube-scheduler ç»™ä¸€ä¸ª pod åšè°ƒåº¦é€‰æ‹©åŒ…å«ä¸¤ä¸ªæ­¥éª¤ï¼š</p><ul><li><p>è¿‡æ»¤ Filtering<br>è¿‡æ»¤ç­–ç•¥ä¼šæ£€æŸ¥å€™é€‰ Node æ˜¯å¦æ»¡è¶³ Pod çš„åˆ›å»ºéœ€æ±‚ï¼›<br>åœ¨è¿‡æ»¤ä¹‹åå¾—å‡ºä¸€ä¸ª Node åˆ—è¡¨ï¼Œé‡Œé¢åŒ…å«äº†æ‰€æœ‰å¯è°ƒåº¦èŠ‚ç‚¹ï¼›<br>å¦‚æœä¸ºç©ºï¼Œä»£è¡¨è¿™ä¸ª Pod ä¸å¯è°ƒåº¦ã€‚</p></li><li><p>æ‰“åˆ† Scoring<br>æ ¹æ®å½“å‰å¯ç”¨çš„æ‰“åˆ†è§„åˆ™ï¼Œè°ƒåº¦å™¨ä¼šç»™æ¯ä¸€ä¸ªå¯è°ƒåº¦èŠ‚ç‚¹è¿›è¡Œæ‰“åˆ†ã€‚</p></li></ul><p><strong><em>è¿‡æ»¤ç­–ç•¥</em></strong></p><ul><li>PodFitsHostPortsï¼šæ£€æŸ¥ Pod è¯·æ±‚çš„ç«¯å£æ˜¯å¦ç©ºé—²ï¼ˆç½‘ç»œåè®®ç±»å‹ï¼‰ã€‚</li><li>PodFitsHostï¼šæ£€æŸ¥ Pod æ˜¯å¦é€šè¿‡å…¶ä¸»æœºåæŒ‡å®šäº†ç‰¹å®šçš„ Nodeã€‚</li><li>PodFitsResourcesï¼šæ£€æŸ¥èŠ‚ç‚¹ç©ºé—²èµ„æºï¼ˆä¾‹å¦‚ CPU å’Œå†…å­˜ï¼‰æ˜¯å¦æ»¡è¶³ Pod çš„è¦æ±‚ã€‚</li><li>PodMatchNodeSelectorï¼šæ£€æŸ¥ Pod label æ˜¯å¦ä¸ Node label åŒ¹é…ã€‚</li><li>NoVolumeZoneConflictï¼šæ£€æŸ¥ Volume å­˜å‚¨å·æ˜¯å¦å¯ç”¨ã€‚</li><li>NoDiskConflictï¼šæ£€æŸ¥èŠ‚ç‚¹ Disk ç£ç›˜æ˜¯å¦å†²çªã€‚</li><li>MaxCSIVolumeCountï¼šæ£€æŸ¥èŠ‚ç‚¹æŒ‚è½½çš„ CSI å·æ˜¯å¦è¶…å‡ºæœ€å¤§é™åˆ¶ã€‚</li><li>CheckNodeMemoryPressureï¼šèŠ‚ç‚¹æ­£åœ¨æŠ¥å‘Šå†…å­˜å‹åŠ›ï¼Œå¹¶ä¸”æ²¡æœ‰é…ç½®çš„å¼‚å¸¸ï¼Œåˆ™ä¸ä¼šåœ¨æ­¤å¤„å®‰æ’ Podã€‚</li><li>CheckNodePIDPressureï¼šèŠ‚ç‚¹æ­£åœ¨æŠ¥å‘Šè¿›ç¨‹ PID ç¨€ç¼ºï¼Œå¹¶ä¸”æ²¡æœ‰é…ç½®çš„å¼‚å¸¸ï¼Œåˆ™ä¸ä¼šåœ¨æ­¤å¤„å®‰æ’ Podã€‚</li><li>CheckNodeDiskPressureï¼šèŠ‚ç‚¹æ­£åœ¨æŠ¥å‘Šå­˜å‚¨å‹åŠ›ï¼Œå¹¶ä¸”æ²¡æœ‰é…ç½®çš„å¼‚å¸¸ï¼Œåˆ™ä¸ä¼šåœ¨æ­¤å¤„å®‰æ’Podã€‚</li><li>CheckNodeConditionï¼šæ£€æŸ¥èŠ‚ç‚¹çš„æ–‡ä»¶ç³»ç»Ÿã€ç½‘ç»œçŠ¶æ€æˆ–è€… kubelet æ˜¯å¦å‡†å¤‡å¥½è¿è¡Œ Podã€‚</li><li>PodToleratesNodeTaintsï¼šæ£€æŸ¥ Pod çš„ Tolerates æ˜¯å¦å¯ä»¥å®¹å¿èŠ‚ç‚¹çš„ Taintsã€‚</li><li>CheckVolumeBindingï¼šæ£€æŸ¥ PVC çŠ¶æ€æ˜¯å¦æ»¡è¶³ Pod åˆ›å»ºéœ€æ±‚ã€‚</li></ul><p><strong><em>æ‰“åˆ†ç­–ç•¥</em></strong></p><ul><li>SelectorSpreadPriorityï¼šå°†å±äºåŒä¸€ StatefulSetã€ ReplicaSet æˆ– Service çš„ Pod åˆ†æ•£åœ¨ä¸åŒçš„ä¸»æœº ã€‚</li><li>InterPodAffinityPriorityï¼šæ ¹æ® Pod äº²å’Œæ¡ç›®æ‰“åˆ†ï¼ŒåŒ¹é…åˆ°ç»™å®šèŠ‚ç‚¹çš„æ¡ç›®æƒé‡ç›¸åŠ ï¼Œç»“æœå€¼è¶Šå¤§çš„èŠ‚ç‚¹å¾—åˆ†è¶Šé«˜ã€‚</li><li>LeastRequestedPriorityï¼šè®¡ç®—Podséœ€è¦çš„CPUå’Œå†…å­˜åœ¨å½“å‰èŠ‚ç‚¹å¯ç”¨èµ„æºçš„ç™¾åˆ†æ¯”ï¼Œå…·æœ‰æœ€å°ç™¾åˆ†æ¯”çš„èŠ‚ç‚¹å°±æ˜¯æœ€ä¼˜ã€‚</li><li>MostRequestedPriorityï¼šé€‚ç”¨åŠ¨æ€ä¼¸ç¼©é›†ç¾¤ç¯å¢ƒï¼Œä¼šä¼˜å…ˆè°ƒåº¦podåˆ°ä½¿ç”¨ç‡æœ€é«˜çš„ä¸»æœºèŠ‚ç‚¹ã€‚å½“ä¼¸ç¼©é›†ç¾¤æ—¶ï¼Œå°±ä¼šè…¾å‡ºç©ºé—²æœºå™¨ï¼Œä»è€Œå¯ä»¥åœæœºå¤„ç†ã€‚</li><li>RequestedToCapacityRatioPriorityï¼šä¸ºèŠ‚ç‚¹ä¸Šæ¯ä¸ªèµ„æºå ç”¨æ¯”ä¾‹è®¾å®šå¾—åˆ†å€¼ï¼Œç»™èµ„æºæ‰“åˆ†å‡½æ•°åœ¨æ‰“åˆ†æ—¶ä½¿ç”¨ã€‚</li><li>BalancedResourceAllocationï¼šä¼˜é€‰é‚£äº›ä½¿å¾—èµ„æºåˆ©ç”¨ç‡æ›´ä¸ºå‡è¡¡çš„èŠ‚ç‚¹ã€‚</li><li>NodePreferAvoidPodsPriorityï¼šæ ¹æ®èŠ‚ç‚¹æ˜¯å¦åŒ…å« scheduler.alpha.kubernetes.io/preferAvoidPods æ¥è®¡ç®—å…¶ä¼˜å…ˆçº§ï¼Œå°†ä¸¤ä¸ªä¸åŒ Pod è¿è¡Œåœ¨ä¸åŒçš„èŠ‚ç‚¹ä¸Šã€‚</li><li>NodeAffinityPriorityï¼šåŸºäº PreferredDuringSchedulingIgnoredDuringExecution æ¥è¿›è¡ŒèŠ‚ç‚¹äº²å’Œè°ƒåº¦ã€‚</li><li>TaintTolerationPriorityï¼šåŸºäº Pod ä¸­å¯¹èŠ‚ç‚¹çš„æ±¡ç‚¹å®¹å¿ç¨‹åº¦è¿›è¡Œä¼˜å…ˆçº§è¯„ä¼°ï¼Œè¿™ä¸ªç­–ç•¥èƒ½å¤Ÿè°ƒæ•´å¾…é€‰èŠ‚ç‚¹çš„æ’åã€‚</li><li>ImageLocalityPriorityï¼šå·²ç»æ‹¥æœ‰ Pod éœ€è¦çš„ image çš„èŠ‚ç‚¹ä¼šæœ‰è¾ƒé«˜çš„ä¼˜å…ˆçº§ã€‚</li><li>ServiceSpreadingPriorityï¼šç¡®ä¿å½’å±äºåŒä¸€ç»™ Service çš„ Pod è°ƒåº¦åˆ°ä¸åŒçš„èŠ‚ç‚¹ä¸Šï¼Œç¡®ä¿èŠ‚ç‚¹å®•æœºä¹‹å Service ä¹Ÿå…·æœ‰å¾ˆå¼ºå®¹ç¾èƒ½åŠ›ã€‚</li><li>EqualPriorityï¼šå°†æ‰€æœ‰çš„ Node è®¾ç½®æˆç›¸åŒçš„æƒé‡ä¸º 1ã€‚</li><li>EvenPodsSpreadPriorityï¼šå®ç°é¦–é€‰çš„Podæ‹“æ‰‘æ‰©å±•çº¦æŸã€‚</li></ul><h3 id="è°ƒåº¦é…ç½®-Scheduling-Profiles"><a href="#è°ƒåº¦é…ç½®-Scheduling-Profiles" class="headerlink" title="è°ƒåº¦é…ç½® Scheduling Profiles"></a>è°ƒåº¦é…ç½® Scheduling Profiles</h3><p>å®˜æ–¹æ–‡æ¡£ <code>https://kubernetes.io/docs/concepts/scheduling-eviction/scheduling-framework/</code></p><p>æ¯æ¬¡è°ƒåº¦ä¸€ä¸ªPodçš„å°è¯•éƒ½åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼Œè°ƒåº¦å‘¨æœŸ Scheduling Cycle å’Œ ç»‘å®šå‘¨æœŸ Binding Cycleã€‚</p><ul><li>è°ƒåº¦å‘¨æœŸä¸ºPodé€‰æ‹©ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¹¶ä¸”ç»‘å®šå‘¨æœŸå°†è¯¥å†³å®šåº”ç”¨äºé›†ç¾¤ã€‚è°ƒåº¦å‘¨æœŸå’Œç»‘å®šå‘¨æœŸä¸€èµ·è¢«ç§°ä¸ºâ€œè°ƒåº¦ä¸Šä¸‹æ–‡â€ã€‚</li><li>è°ƒåº¦å‘¨æœŸæ˜¯ä¸²è¡Œè¿è¡Œçš„ï¼Œè€Œç»‘å®šå‘¨æœŸå¯èƒ½æ˜¯åŒæ—¶è¿è¡Œçš„ã€‚</li><li>å¦‚æœç¡®å®šPodä¸å¯è°ƒåº¦æˆ–å­˜åœ¨å†…éƒ¨é”™è¯¯ï¼Œåˆ™å¯ä»¥ä¸­æ­¢è°ƒåº¦æˆ–ç»‘å®šå‘¨æœŸã€‚Podå°†è¿”å›é˜Ÿåˆ—å¹¶é‡è¯•ã€‚</li></ul><p><strong><em>æ‰©å±•ç‚¹ Extension points</em></strong></p><p>QueueSort - å¯¹ Pod çš„å¾…è°ƒåº¦é˜Ÿåˆ—è¿›è¡Œæ’åºï¼Œæ¯”è¾ƒä¸¤ä¸ª Pod è°æ›´ä¼˜å…ˆè°ƒåº¦ï¼ŒåŒä¸€æ—¶é—´ç‚¹åªèƒ½æœ‰ä¸€ä¸ª QueueSort æ’ä»¶ç”Ÿæ•ˆã€‚</p><p>è°ƒåº¦å‘¨æœŸ Scheduling Cycle</p><ul><li>PreFilter - å¯¹ Pod æ¡ä»¶ä¿¡æ¯è¿›è¡Œé¢„å¤„ç†ï¼Œå¦‚æœ PreFilter è¿”å›äº† error åˆ™è°ƒåº¦è¿‡ç¨‹ç»ˆæ­¢ã€‚</li><li>Filter - æ ‡è®°ä¸ç¬¦åˆè°ƒåº¦æ¡ä»¶çš„</li><li>PreScore - å¯¹ Pod è¿›è¡Œé¢„è¯„åˆ†ï¼Œä¸º Score æ’ä»¶ä½¿ç”¨æä¾›å¯å…±äº«çš„çŠ¶æ€ã€‚å¦‚æœPreScoreæ’ä»¶è¿”å›é”™è¯¯ï¼Œåˆ™è°ƒåº¦å‘¨æœŸå°†ä¸­æ­¢ã€‚</li><li>Score - å¯¹ç¬¦åˆè¿‡æ»¤æ¡ä»¶çš„èŠ‚ç‚¹è¿›è¡Œè®¡åˆ†æ’åï¼Œåœ¨ NormalizeScore é˜¶æ®µä¹‹åï¼Œè°ƒåº¦ç¨‹åºå°†æ ¹æ®æƒé‡åˆå¹¶æ‰€æœ‰çš„èŠ‚ç‚¹åˆ†å€¼ã€‚</li><li>NormalizeScore - åœ¨è°ƒåº¦ç¨‹åºè®¡ç®—èŠ‚ç‚¹çš„æœ€ç»ˆæ’åä¹‹å‰ä¿®æ”¹åˆ†æ•°ã€‚</li><li>Reserve - åœ¨ç¬¦åˆæ¡ä»¶çš„èŠ‚ç‚¹ä¸Šä¸º Pod ä¿ç•™èµ„æºã€‚</li><li>Permit - ç”¨äºé˜»æ­¢æˆ–è€…å»¶è¿Ÿ Pod ä¸èŠ‚ç‚¹çš„ç»‘å®šã€‚<ul><li>approve - æ‰¹å‡†</li><li>deny - æ‹’ç»</li><li>wait - ç­‰å¾…</li></ul></li></ul><p>ç»‘å®šå‘¨æœŸ Binding Cycle</p><ul><li>PreBind - ç”¨äºæ‰§è¡Œç»‘å®š Pod ä¹‹å‰æ‰€éœ€çš„ä»»ä½•å·¥ä½œã€‚å¦‚æœä»»ä½• PreBind æ’ä»¶è¿”å›é”™è¯¯ï¼Œåˆ™ Pod è¢«æ‹’ç»å¹¶è¿”å›åˆ°è°ƒåº¦é˜Ÿåˆ—ã€‚</li><li>Bind - ç”¨äº Pod ç»‘å®šã€‚å¦‚æœç»‘å®šæ’ä»¶é€‰æ‹©å¤„ç† Podï¼Œåˆ™ä¼šè·³è¿‡å…¶ä½™çš„ç»‘å®šæ’ä»¶ã€‚</li><li>PostBind - æˆåŠŸç»‘å®šPodåï¼Œå°†è°ƒç”¨åç»‘å®šæ’ä»¶ã€‚ç»‘å®šå‘¨æœŸåˆ°æ­¤ç»“æŸï¼Œå¯ä»¥ç”¨æ¥æ¸…ç†å…³è”çš„èµ„æºã€‚</li></ul><p>Unreserve - å¦‚æœèŠ‚ç‚¹ä¸º Pod é¢„ç•™äº†èµ„æºï¼ŒPod åˆåœ¨è¢«ç»‘å®šè¿‡ç¨‹ä¸­è¢«æ‹’ç»ç»‘å®šï¼Œåˆ™æ‰§è¡Œ unreserve é‡Šæ”¾ä¸º Pod é¢„ç•™çš„èµ„æºã€‚</p><p><strong><em>è°ƒåº¦æ’ä»¶ Scheduling plugins</em></strong></p><p>é»˜è®¤æƒ…å†µä¸‹å¯ç”¨ä»¥ä¸‹æ’ä»¶ï¼Œå®ç°è¿™äº›æ‰©å±•ç‚¹ä¸­çš„ä¸€ä¸ªæˆ–å¤šä¸ªï¼š</p><ul><li>DefaultTopologySpreadï¼šåŸºäº Serviceã€ReplicaSets å’Œ StatefulSets åˆ†æ•£éƒ¨ç½²ã€‚æ‰©å±•ç‚¹ï¼šPreScoreï¼Œ Scoreã€‚</li><li>ImageLocalityï¼šå€¾å‘äºå·²ç»å…·æœ‰ Pod è¿è¡Œçš„ image çš„èŠ‚ç‚¹ã€‚æ‰©å±•ç‚¹ï¼šScoreã€‚</li><li>TaintTolerationï¼šå®æ–½æ±¡ç‚¹å’Œå®½å®¹ã€‚æ‰©å±•ç‚¹ï¼šFilterï¼ŒPrescoreï¼ŒScoreã€‚</li><li>NodeNameï¼šPod é…ç½®çš„èŠ‚ç‚¹ä¸èŠ‚ç‚¹æ˜¯å¦åŒ¹é…ã€‚æ‰©å±•ç‚¹ï¼šFilterã€‚</li><li>NodePortsï¼šèŠ‚ç‚¹ç«¯å£æ˜¯å¦è¢«å ç”¨ã€‚æ‰©å±•ç‚¹ï¼šPreFilterï¼ŒFilterã€‚</li><li>NodePreferAvoidPodsï¼šæ ¹æ®èŠ‚ç‚¹ annotation è¿›è¡Œè¯„åˆ† scheduler.alpha.kubernetes.io/preferAvoidPodsã€‚æ‰©å±•ç‚¹ï¼šScoreã€‚</li><li>NodeAffinityï¼šèŠ‚ç‚¹çš„äº²å’Œä¸åäº²å’Œã€‚æ‰©å±•ç‚¹ï¼šFilterï¼ŒScoreã€‚</li><li>PodTopologySpreadï¼šå®ç° Pod æ‹“æ‰‘ä¼ æ’­ã€‚æ‰©å±•ç‚¹ï¼šPreFilterï¼ŒFilterï¼ŒPreScoreï¼ŒScoreã€‚</li><li>NodeUnschedulableï¼šè¿‡æ»¤æ‰ .spec.unschedulable ä¸º true çš„èŠ‚ç‚¹ã€‚æ‰©å±•ç‚¹ï¼šFilterã€‚</li><li>NodeResourcesFitï¼šæ£€æŸ¥èŠ‚ç‚¹æ˜¯å¦å…·æœ‰ Pod è¯·æ±‚çš„èµ„æºã€‚æ‰©å±•ç‚¹ï¼šPreFilterï¼ŒFilterã€‚</li><li>NodeResourcesBallancedAllocationï¼šä½¿ç”¨èµ„æºåˆ©ç”¨å‡è¡¡çš„èŠ‚ç‚¹ã€‚æ‰©å±•ç‚¹ï¼šScoreã€‚</li><li>NodeResourcesLeastAllocatedï¼šä½¿ç”¨èµ„æºåˆ†é…å°‘çš„èŠ‚ç‚¹ã€‚æ‰©å±•ç‚¹ï¼šScoreã€‚</li><li>VolumeBindingï¼šèŠ‚ç‚¹æ˜¯å¦å…·æœ‰æˆ–å¯ä»¥ç»‘å®šæ‰€è¯·æ±‚å·ã€‚æ‰©å±•ç‚¹ï¼šFilterã€‚</li><li>VolumeRestrictionsï¼šèŠ‚ç‚¹æŒ‚è½½çš„å·æ˜¯å¦æ»¡è¶³é™åˆ¶æ¡ä»¶ã€‚æ‰©å±•ç‚¹ï¼šFilterã€‚</li><li>VolumeZoneï¼šæ£€æŸ¥å·æ˜¯å¦æ»¡è¶³ä»»ä½•åŒºåŸŸè¦æ±‚ã€‚æ‰©å±•ç‚¹ï¼šFilterã€‚</li><li>NodeVolumeLimitsï¼šæ£€æŸ¥èŠ‚ç‚¹æ˜¯å¦å¯ä»¥ç¬¦åˆ CSI é™åˆ¶ã€‚æ‰©å±•ç‚¹ï¼šFilterã€‚</li><li>EBSLimitsï¼šæ£€æŸ¥èŠ‚ç‚¹æ˜¯å¦æ»¡è¶³ AWS EBS é™åˆ¶ã€‚æ‰©å±•ç‚¹ï¼šFilterã€‚</li><li>GCEPDLimitsï¼šæ£€æŸ¥èŠ‚ç‚¹æ˜¯å¦æ»¡è¶³ GCP-PD é™åˆ¶ã€‚æ‰©å±•ç‚¹ï¼šFilterã€‚</li><li>AzureDiskLimitsï¼šæ£€æŸ¥èŠ‚ç‚¹æ˜¯å¦æ»¡è¶³ Azure Disk é™åˆ¶ã€‚æ‰©å±•ç‚¹ï¼šFilterã€‚</li><li>InterPodAffinityï¼šåŸºäº Pod äº²å’Œä¸åäº²å’Œã€‚æ‰©å±•ç‚¹ï¼šPreFilterï¼ŒFilterï¼ŒPreScoreï¼ŒScoreã€‚</li><li>PrioritySortï¼šåŸºäºé»˜è®¤ä¼˜å…ˆçº§çš„æ’åºã€‚æ‰©å±•ç‚¹ï¼šQueueSortã€‚</li><li>DefaultBinderï¼šåŸºäºé»˜è®¤çš„ç»‘å®šæœºåˆ¶ã€‚æ‰©å±•ç‚¹ï¼šBindã€‚</li></ul><p>æ‚¨è¿˜å¯ä»¥é€šè¿‡ç»„ä»¶é…ç½®APIå¯ç”¨ä»¥ä¸‹é»˜è®¤æœªå¯ç”¨çš„æ’ä»¶ï¼š</p><ul><li>NodeResourcesMostAllocatedï¼šå€¾å‘äºèµ„æºåˆ†é…é«˜çš„èŠ‚ç‚¹ã€‚æ‰©å±•ç‚¹ï¼šScoreã€‚</li><li>RequestedToCapacityRatioï¼šåŸºäºèŠ‚ç‚¹çš„èµ„æºå¯ç”¨æ€§æ¯”ä¾‹ã€‚æ‰©å±•ç‚¹ï¼šScoreã€‚</li><li>NodeResourceLimitsï¼šæ”¯æŒæ»¡è¶³ Pod èµ„æºé™åˆ¶çš„èŠ‚ç‚¹ã€‚æ‰©å±•ç‚¹ï¼šPreScoreï¼ŒScoreã€‚</li><li>CinderVolumeï¼šæ£€æŸ¥èŠ‚ç‚¹æ˜¯å¦å¯ä»¥æ»¡è¶³ OpenStack Cinder é™åˆ¶ã€‚æ‰©å±•ç‚¹ï¼šFilterã€‚</li><li>NodeLabelï¼šæ ¹æ®èŠ‚ç‚¹çš„ label è¿›è¡Œè¯„åˆ†ã€‚æ‰©å±•ç‚¹ï¼šFilterï¼ŒScoreã€‚</li><li>ServiceAffinityï¼šæ£€æŸ¥ Service label åŒ¹é…çš„èŠ‚ç‚¹ï¼Œè¯¥æ’ä»¶æœ‰åˆ©äºåœ¨èŠ‚ç‚¹ä¹‹é—´éƒ¨ç½²æœåŠ¡ã€‚æ‰©å±•ç‚¹ï¼šPreFilterï¼ŒFilterï¼ŒScoreã€‚</li></ul><h3 id="äº²å’Œ-Affinity-ä¸-åäº²å’Œ-Anti-Affinity"><a href="#äº²å’Œ-Affinity-ä¸-åäº²å’Œ-Anti-Affinity" class="headerlink" title="äº²å’Œ Affinity ä¸ åäº²å’Œ Anti-Affinity"></a>äº²å’Œ Affinity ä¸ åäº²å’Œ Anti-Affinity</h3><h4 id="äº²å’Œè§„åˆ™"><a href="#äº²å’Œè§„åˆ™" class="headerlink" title="äº²å’Œè§„åˆ™"></a>äº²å’Œè§„åˆ™</h4><ul><li><p>requiredDuringSchedulingRequiredDuringExecution<br>è¯¥è§„åˆ™è¿˜æœªæ­£å¼ä¸Šçº¿ï¼›<br>åœ¨è°ƒåº¦æœŸé—´å¿…é¡»æ»¡è¶³äº²å’Œæˆ–è€…åäº²å’Œè§„åˆ™ï¼Œå¦‚æœä¸èƒ½æ»¡è¶³è§„åˆ™ï¼Œåˆ™ pod ä¸èƒ½è¢«è°ƒåº¦åˆ°å¯¹åº”çš„ä¸»æœºä¸Š;<br>åœ¨ä¹‹åçš„è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œç³»ç»Ÿä¼šæŒç»­ç›‘è§„åˆ™æ˜¯å¦æ»¡è¶³ã€‚</p></li><li><p>RequiredDuringSchedulingIgnoredDuringExecution<br>åœ¨è°ƒåº¦æœŸé—´å¿…é¡»æ»¡è¶³äº²å’Œæˆ–è€…åäº²å’Œè§„åˆ™ï¼Œå¦‚æœä¸èƒ½æ»¡è¶³è§„åˆ™ï¼Œåˆ™ pod ä¸èƒ½è¢«è°ƒåº¦åˆ°å¯¹åº”çš„ä¸»æœºä¸Š;<br>åœ¨ä¹‹åçš„è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œç³»ç»Ÿä¸å†æ£€æŸ¥è¿™äº›è§„åˆ™æ˜¯å¦æ»¡è¶³ã€‚</p></li><li><p>PreferredDuringSchedulingIgnoredDuringExecution<br>åœ¨è°ƒåº¦æœŸé—´å°½é‡æ»¡è¶³äº²å’Œæˆ–è€…åäº²å’Œè§„åˆ™ï¼Œå¦‚æœä¸èƒ½æ»¡è¶³è§„åˆ™ï¼Œpod ä¹Ÿæœ‰å¯èƒ½è¢«è°ƒåº¦åˆ°å¯¹åº”çš„ä¸»æœºä¸Šï¼›<br>åœ¨ä¹‹åçš„è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œç³»ç»Ÿä¸å†æ£€æŸ¥è¿™äº›è§„åˆ™æ˜¯å¦æ»¡è¶³ã€‚</p></li></ul><h4 id="nodeAffinity"><a href="#nodeAffinity" class="headerlink" title="nodeAffinity"></a>nodeAffinity</h4><p>nodeAffinity - èŠ‚ç‚¹äº²å’Œï¼Œä½¿ç”¨åœºæ™¯ ï¼š</p><ul><li>å°†æœåŠ¡çš„æ‰€æœ‰Podéƒ¨ç½²åˆ°æŒ‡å®šçš„ç¬¦åˆæ ‡ç­¾è§„åˆ™çš„ä¸»æœºä¸Šã€‚</li><li>å°†æœåŠ¡çš„æ‰€æœ‰Podéƒ¨ç½²åˆ°é™¤éƒ¨åˆ†ä¸»æœºå¤–çš„å…¶ä»–ä¸»æœºä¸Šã€‚</li><li>æ”¯æŒçš„æ“ä½œç¬¦ï¼š Inï¼ŒNotInï¼ŒExistsï¼ŒDoesNotExistï¼ŒGtï¼ŒLtã€‚</li></ul><p>èŠ‚ç‚¹äº²å’Œï¼š</p><div class="hljs"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">with-node-affinity</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">affinity:</span>
    <span class="hljs-attr">nodeAffinity:</span>
      <span class="hljs-attr">requiredDuringSchedulingIgnoredDuringExecution:</span>
        <span class="hljs-attr">nodeSelectorTerms:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">matchExpressions:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-attr">key:</span> <span class="hljs-string">kubernetes.io/e2e-az-name</span>
            <span class="hljs-attr">operator:</span> <span class="hljs-string">In</span>
            <span class="hljs-attr">values:</span>
            <span class="hljs-bullet">-</span> <span class="hljs-string">e2e-az1</span>
            <span class="hljs-bullet">-</span> <span class="hljs-string">e2e-az2</span>
      <span class="hljs-attr">preferredDuringSchedulingIgnoredDuringExecution:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">weight:</span> <span class="hljs-number">1</span>
        <span class="hljs-attr">preference:</span>
          <span class="hljs-attr">matchExpressions:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-attr">key:</span> <span class="hljs-string">another-node-label-key</span>
            <span class="hljs-attr">operator:</span> <span class="hljs-string">In</span>
            <span class="hljs-attr">values:</span>
            <span class="hljs-bullet">-</span> <span class="hljs-string">another-node-label-value</span>
  <span class="hljs-attr">containers:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">with-node-affinity</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">k8s.gcr.io/pause:2.0</span></code></pre></div><h4 id="podAffinity-ä¸-podAntiAffinity"><a href="#podAffinity-ä¸-podAntiAffinity" class="headerlink" title="podAffinity ä¸ podAntiAffinity"></a>podAffinity ä¸ podAntiAffinity</h4><p>æ³¨æ„ï¼š<br>Pod é—´äº²å’Œä¸åäº²å’Œéœ€è¦å¤§é‡çš„å¤„ç†ï¼Œè¿™å¯èƒ½ä¼šæ˜¾è‘—å‡æ…¢å¤§è§„æ¨¡é›†ç¾¤ä¸­çš„è°ƒåº¦ã€‚æˆ‘ä»¬ä¸å»ºè®®åœ¨è¶…è¿‡æ•°ç™¾ä¸ªèŠ‚ç‚¹çš„é›†ç¾¤ä¸­ä½¿ç”¨å®ƒä»¬ã€‚</p><p>podAffinity - pod äº²å’Œï¼Œä½¿ç”¨åœºæ™¯ ï¼š</p><ul><li>å°†æŸä¸€ç‰¹å®šçš„ pod éƒ¨ç½²åœ¨åŒä¸€æ‹“æ‰‘åŸŸä¸­ï¼Œä¸ç”¨æŒ‡å®šå…·ä½“çš„æ‹“æ‰‘åŸŸã€‚</li><li>ä¸ºäº†å‡å°‘å…³è”çš„2ä¸ªæœåŠ¡ä¹‹é—´çš„ç½‘ç»œå»¶è¿Ÿï¼ˆæˆ–å…¶å®ƒåŸå› ï¼‰ï¼Œå°†ä»–ä»¬éƒ¨ç½²åœ¨åŒä¸€æ‹“æ‰‘åŸŸä¸­ã€‚</li><li>æ”¯æŒçš„æ“ä½œç¬¦ï¼š Inï¼ŒNotInï¼ŒExistsï¼ŒDoesNotExistã€‚</li></ul><p>podAntiAffinity - pod åäº²å’Œï¼Œä½¿ç”¨åœºæ™¯ ï¼š</p><ul><li>å°†ä¸€ä¸ªæœåŠ¡çš„ pod åˆ†æ•£åœ¨ä¸åŒçš„ä¸»æœºæˆ–è€…æ‹“æ‰‘åŸŸä¸­ï¼Œæé«˜æœåŠ¡æœ¬èº«çš„ç¨³å®šæ€§ã€‚</li><li>ä¸ºæŸä¸€ä¸ª pod æä¾›èŠ‚ç‚¹çš„èµ„æºç‹¬å æƒé™ã€‚</li><li>æŠŠå¯èƒ½ä¼šç›¸äº’å½±å“çš„ pod åˆ†æ•£åœ¨ä¸åŒçš„ä¸»æœºä¸Šã€‚</li><li>æ”¯æŒçš„æ“ä½œç¬¦ï¼š Inï¼ŒNotInï¼ŒExistsï¼ŒDoesNotExistã€‚</li></ul><p>pod äº²å’Œä¸åäº²å’Œï¼š</p><div class="hljs"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">with-pod-affinity</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">affinity:</span>
    <span class="hljs-attr">podAffinity:</span>
      <span class="hljs-attr">requiredDuringSchedulingIgnoredDuringExecution:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">labelSelector:</span>
          <span class="hljs-attr">matchExpressions:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-attr">key:</span> <span class="hljs-string">security</span>
            <span class="hljs-attr">operator:</span> <span class="hljs-string">In</span>
            <span class="hljs-attr">values:</span>
            <span class="hljs-bullet">-</span> <span class="hljs-string">S1</span>
        <span class="hljs-attr">topologyKey:</span> <span class="hljs-string">failure-domain.beta.kubernetes.io/zone</span>
    <span class="hljs-attr">podAntiAffinity:</span>
      <span class="hljs-attr">preferredDuringSchedulingIgnoredDuringExecution:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">weight:</span> <span class="hljs-number">100</span>
        <span class="hljs-attr">podAffinityTerm:</span>
          <span class="hljs-attr">labelSelector:</span>
            <span class="hljs-attr">matchExpressions:</span>
            <span class="hljs-bullet">-</span> <span class="hljs-attr">key:</span> <span class="hljs-string">security</span>
              <span class="hljs-attr">operator:</span> <span class="hljs-string">In</span>
              <span class="hljs-attr">values:</span>
              <span class="hljs-bullet">-</span> <span class="hljs-string">S2</span>
          <span class="hljs-attr">topologyKey:</span> <span class="hljs-string">failure-domain.beta.kubernetes.io/zone</span>
  <span class="hljs-attr">containers:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">with-pod-affinity</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">k8s.gcr.io/pause:2.0</span></code></pre></div><h3 id="æ±¡ç‚¹é©±é€-Taint"><a href="#æ±¡ç‚¹é©±é€-Taint" class="headerlink" title="æ±¡ç‚¹é©±é€ Taint"></a>æ±¡ç‚¹é©±é€ Taint</h3><ul><li>NoScheduleï¼šè¡¨ç¤ºk8så°†ä¸ä¼šå°†Podè°ƒåº¦åˆ°å…·æœ‰è¯¥æ±¡ç‚¹çš„Nodeä¸Š</li><li>PreferNoScheduleï¼šè¡¨ç¤ºk8så°†å°½é‡é¿å…å°†Podè°ƒåº¦åˆ°å…·æœ‰è¯¥æ±¡ç‚¹çš„Nodeä¸Š</li><li>NoExecuteï¼šè¡¨ç¤ºk8så°†ä¸ä¼šå°†Podè°ƒåº¦åˆ°å…·æœ‰è¯¥æ±¡ç‚¹çš„Nodeä¸Šï¼ŒåŒæ—¶ä¼šå°†Nodeä¸Šå·²ç»å­˜åœ¨çš„Podé©±é€å‡ºå»</li></ul><div class="hljs"><pre><code class="hljs bash">åˆ é™¤æ±¡ç‚¹ï¼Œå¼€å¯ master èŠ‚ç‚¹ pod è°ƒåº¦åŠŸèƒ½ã€‚
kubectl taint node ukm03 node-role.kubernetes.io/master=:NoSchedule-

æ·»åŠ æ±¡ç‚¹ï¼Œå…³é—­ master èŠ‚ç‚¹ pod è°ƒåº¦åŠŸèƒ½ã€‚
kubectl taint node ukm03 node-role.kubernetes.io/master=:NoSchedule</code></pre></div><h3 id="å®¹å¿-Toleration"><a href="#å®¹å¿-Toleration" class="headerlink" title="å®¹å¿ Toleration"></a>å®¹å¿ Toleration</h3><p>è®¾ç½®äº†æ±¡ç‚¹çš„èŠ‚ç‚¹ï¼ŒPod å°†åœ¨ä¸€å®šç¨‹åº¦ä¸Šä¸ä¼šè¢«è°ƒåº¦åˆ°èŠ‚ç‚¹ä¸Šã€‚ é€šè¿‡è®¾ç½® pod å®¹å¿(Toleration)ï¼Œå°† pod è°ƒåº¦åˆ°å­˜åœ¨æ±¡ç‚¹çš„Nodeä¸Šã€‚é€šè¿‡åœ¨Podçš„specä¸­è®¾ç½®tolerationså­—æ®µï¼Œç»™Podè®¾ç½®ä¸Šå®¹å¿ç‚¹ï¼š</p><div class="hljs"><pre><code class="hljs yaml"><span class="hljs-attr">tolerations:</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">key:</span> <span class="hljs-string">"key1"</span>
  <span class="hljs-attr">operator:</span> <span class="hljs-string">"Equal"</span>
  <span class="hljs-attr">value:</span> <span class="hljs-string">"value1"</span>
  <span class="hljs-attr">effect:</span> <span class="hljs-string">"NoSchedule"</span>
  <span class="hljs-attr">tolerationSeconds:</span> <span class="hljs-number">3600</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">key:</span> <span class="hljs-string">"key1"</span>
  <span class="hljs-attr">operator:</span> <span class="hljs-string">"Equal"</span>
  <span class="hljs-attr">value:</span> <span class="hljs-string">"value1"</span>
  <span class="hljs-attr">effect:</span> <span class="hljs-string">"NoExecute"</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">key:</span> <span class="hljs-string">"key2"</span>
  <span class="hljs-attr">operator:</span> <span class="hljs-string">"Exists"</span>
  <span class="hljs-attr">effect:</span> <span class="hljs-string">"NoSchedule"</span></code></pre></div><ul><li>keyã€vauleã€effectè¦ä¸Nodeä¸Šè®¾ç½®çš„taintä¿æŒä¸€è‡´ã€‚</li><li>å½“ä¸æŒ‡å®škeyå€¼æ—¶ï¼Œè¡¨ç¤ºå®¹å¿æ‰€æœ‰çš„æ±¡ç‚¹keyï¼›å½“ä¸æŒ‡å®šeffectå€¼æ—¶ï¼Œè¡¨ç¤ºå®¹å¿æ‰€æœ‰çš„æ±¡ç‚¹ä½œç”¨ã€‚</li><li>operatorçš„å€¼ä¸ºExistså°†ä¼šå¿½ç•¥valueå€¼ã€‚</li><li>tolerationSecondsç”¨äºæè¿°å½“Podéœ€è¦è¢«é©±é€æ—¶å¯ä»¥åœ¨Podä¸Šç»§ç»­ä¿ç•™è¿è¡Œçš„æ—¶é—´ã€‚</li></ul><h3 id="create-å’Œ-apply"><a href="#create-å’Œ-apply" class="headerlink" title="create å’Œ apply"></a>create å’Œ apply</h3><p>kubectl create å‘½ä»¤å¯åˆ›å»ºæ–°èµ„æºã€‚ å› æ­¤å†æ¬¡è¿è¡Œè¯¥å‘½ä»¤ï¼Œåˆ™ä¼šæŠ›å‡ºé”™è¯¯ï¼Œå› ä¸ºèµ„æºåç§°åœ¨åç§°ç©ºé—´ä¸­åº”è¯¥æ˜¯å”¯ä¸€çš„ã€‚</p><div class="hljs"><pre><code class="hljs bash"> kubectl create -f test.yml
pod/myapp-pod created

 kubectl create -f test.yml
Error from server (AlreadyExists): error when creating <span class="hljs-string">"pod.xml"</span>: pods <span class="hljs-string">"myapp-pod"</span> already exists</code></pre></div><p>kubectl apply å‘½ä»¤å°†é…ç½®åº”ç”¨äºèµ„æºã€‚ å¦‚æœèµ„æºä¸åœ¨é‚£é‡Œï¼Œé‚£ä¹ˆå®ƒå°†è¢«åˆ›å»ºã€‚ apply å‘½ä»¤å¯ä»¥äºŒæ¬¡è¿è¡Œï¼Œå› ä¸ºå®ƒåªæ˜¯åº”ç”¨é…ç½®ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œé…ç½®æ²¡æœ‰æ”¹å˜, æ‰€ä»¥ pod æ²¡æœ‰æ”¹å˜ã€‚</p><div class="hljs"><pre><code class="hljs bash"> kubectl apply -f test.yml
pod/myapp-pod created

 kubectl apply -f test.yml
pod/myapp-pod unchanged</code></pre></div><h3 id="kubernetes-æ§åˆ¶å™¨"><a href="#kubernetes-æ§åˆ¶å™¨" class="headerlink" title="kubernetes æ§åˆ¶å™¨"></a><strong>kubernetes æ§åˆ¶å™¨</strong></h3><h4 id="ReplicationController"><a href="#ReplicationController" class="headerlink" title="ReplicationController"></a>ReplicationController</h4><ul><li>ç¡®ä¿åœ¨ä»»ä½•æ—¶å€™éƒ½æœ‰ç‰¹å®šæ•°é‡çš„ pod å‰¯æœ¬å¤„äºè¿è¡ŒçŠ¶æ€ï¼›</li><li>ç±»ä¼¼äºè¿›ç¨‹ç®¡ç†å™¨ï¼Œ ReplicationController ç›‘æ§è·¨å¤šä¸ªèŠ‚ç‚¹çš„å¤šä¸ª podï¼›</li><li>é€šå¸¸ç¼©å†™ä¸º rc ï¼Œé€šè¿‡ replicas æ§åˆ¶å‰¯æœ¬çš„æ•°é‡ã€‚</li></ul><div class="hljs"><pre><code class="hljs yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">ReplicationController</span>
<span class="hljs-attr">metadata:</span>
<span class="hljs-string">...</span></code></pre></div><h4 id="ReplicaSet"><a href="#ReplicaSet" class="headerlink" title="ReplicaSet"></a>ReplicaSet</h4><ul><li>ReplicaSet æ˜¯ä¸‹ä¸€ä»£çš„ ReplicationControllerï¼›</li><li>ReplicaSet å’Œ ReplicationController çš„å”¯ä¸€åŒºåˆ«æ˜¯é€‰æ‹©å™¨çš„æ”¯æŒï¼ŒReplicaSet æ”¯æŒæ–°çš„åŸºäºé›†åˆçš„é€‰æ‹©å™¨éœ€æ±‚ï¼Œè€Œ Replication Controller ä»…æ”¯æŒåŸºäºç›¸ç­‰é€‰æ‹©å™¨çš„éœ€æ±‚ã€‚</li><li>é€šå¸¸ç¼©å†™ä¸º rs ã€‚</li></ul><div class="hljs"><pre><code class="hljs yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">ReplicaSet</span>
<span class="hljs-attr">metadata:</span>
<span class="hljs-string">...</span></code></pre></div><h4 id="Deployment"><a href="#Deployment" class="headerlink" title="Deployment"></a>Deployment</h4><ul><li>Deployment ç®¡ç†å’Œæè¿° Pods å’Œ ReplicaSets éƒ¨ç½²æ–¹å¼ï¼›</li><li>æ¸…ç†è¾ƒæ—§çš„ã€ä¸å†éœ€è¦çš„ ReplicaSets ã€‚</li><li>å¦‚æœ Deployment çš„å½“å‰çŠ¶æ€ä¸ç¨³å®šï¼Œå›æ»šåˆ°è¾ƒæ—©çš„ Deployment ç‰ˆæœ¬ã€‚</li></ul><div class="hljs"><pre><code class="hljs yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span>
<span class="hljs-attr">metadata:</span>
<span class="hljs-string">...</span></code></pre></div><h4 id="StatefulSet"><a href="#StatefulSet" class="headerlink" title="StatefulSet"></a>StatefulSet</h4><ul><li>æ˜¯ç”¨æ¥ç®¡ç†æœ‰çŠ¶æ€åº”ç”¨çš„å¯¹è±¡ï¼›</li><li>ç¨³å®šçš„ã€å”¯ä¸€çš„ç½‘ç»œæ ‡è¯†ç¬¦ï¼›</li><li>ç¨³å®šçš„ã€æŒä¹…çš„å­˜å‚¨ï¼›</li><li>æœ‰åºçš„ã€ä¼˜é›…çš„éƒ¨ç½²å’Œç¼©æ”¾ï¼›</li><li>æœ‰åºçš„ã€è‡ªåŠ¨çš„æ»šåŠ¨æ›´æ–°ã€‚</li></ul><div class="hljs"><pre><code class="hljs yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">StatefulSet</span>
<span class="hljs-attr">metadata:</span>
<span class="hljs-string">...</span></code></pre></div><h4 id="DaemonSet"><a href="#DaemonSet" class="headerlink" title="DaemonSet"></a>DaemonSet</h4><ul><li>DaemonSet ç¡®ä¿å…¨éƒ¨æˆ–è€…æŸä¸ª label çš„èŠ‚ç‚¹ä¸Šè¿è¡Œä¸€ä¸ª Pod çš„å®ä¾‹ï¼›</li><li>åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œé›†ç¾¤å­˜å‚¨ DaemonSetï¼Œä¾‹å¦‚ glusterdã€cephï¼›</li><li>åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œæ—¥å¿—æ”¶é›† DaemonSetï¼Œä¾‹å¦‚ fluentdã€logstashï¼›</li><li>åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œç›‘æ§ DaemonSetï¼Œä¾‹å¦‚ Prometheus Node Exporterï¼›</li><li>åœ¨æ¯ä¸ª infra èŠ‚ç‚¹ä¸Šé¢è¿è¡Œä¸€ä¸ª ingress æœåŠ¡ã€‚</li></ul><div class="hljs"><pre><code class="hljs yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">DaemonSet</span>
<span class="hljs-attr">metadata:</span>
<span class="hljs-string">...</span></code></pre></div><h4 id="Job"><a href="#Job" class="headerlink" title="Job"></a>Job</h4><ul><li>Jobè´Ÿè´£å¤„ç†ä»»åŠ¡ï¼Œå³ä»…æ‰§è¡Œä¸€æ¬¡çš„ä»»åŠ¡ï¼Œå®ƒä¿è¯æ‰¹å¤„ç†ä»»åŠ¡çš„ä¸€ä¸ªæˆ–å¤šä¸ªPodæˆåŠŸç»“æŸ;</li><li>è¿è¡Œç¤ºä¾‹ä½œä¸š</li><li>ç¼–å†™å·¥ä½œè§„èŒƒ</li><li>å¤„ç†Podå’Œå®¹å™¨æ•…éšœ</li><li>ä½œä¸šç»ˆæ­¢å’Œæ¸…ç†</li><li>è‡ªåŠ¨æ¸…ç†å®Œæˆçš„ä½œä¸š</li><li>CronJob</li></ul><div class="hljs"><pre><code class="hljs yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">batch/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Job</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">pi</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">template:</span>
    <span class="hljs-attr">spec:</span>
      <span class="hljs-attr">containers:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">pi</span>
        <span class="hljs-attr">image:</span> <span class="hljs-string">perl</span>
        <span class="hljs-attr">command:</span> <span class="hljs-string">["perl",</span>  <span class="hljs-string">"-Mbignum=bpi"</span><span class="hljs-string">,</span> <span class="hljs-string">"-wle"</span><span class="hljs-string">,</span> <span class="hljs-string">"print bpi(2000)"</span><span class="hljs-string">]</span>
      <span class="hljs-attr">restartPolicy:</span> <span class="hljs-string">Never</span>
  <span class="hljs-attr">backoffLimit:</span> <span class="hljs-number">4</span></code></pre></div><h4 id="CronJob"><a href="#CronJob" class="headerlink" title="CronJob"></a>CronJob</h4><ul><li>æ‰§è¡ŒåŸºäºæ—¶é—´è°ƒåº¦çš„ä»»åŠ¡ï¼Œç±»ä¼¼äº linux ç³»ç»Ÿçš„ crontab ä»»åŠ¡ã€‚</li></ul><div class="hljs"><pre><code class="hljs yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">batch/v1beta1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">CronJob</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">hello</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">schedule:</span> <span class="hljs-string">"*/1 * * * *"</span>
  <span class="hljs-attr">jobTemplate:</span>
    <span class="hljs-attr">spec:</span>
      <span class="hljs-attr">template:</span>
        <span class="hljs-attr">spec:</span>
          <span class="hljs-attr">containers:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">hello</span>
            <span class="hljs-attr">image:</span> <span class="hljs-string">busybox</span>
            <span class="hljs-attr">args:</span>
            <span class="hljs-bullet">-</span> <span class="hljs-string">/bin/sh</span>
            <span class="hljs-bullet">-</span> <span class="hljs-string">-c</span>
            <span class="hljs-bullet">-</span> <span class="hljs-string">date;</span> <span class="hljs-string">echo</span> <span class="hljs-string">Hello</span> <span class="hljs-string">from</span> <span class="hljs-string">the</span> <span class="hljs-string">Kubernetes</span> <span class="hljs-string">cluster</span>
          <span class="hljs-attr">restartPolicy:</span> <span class="hljs-string">OnFailure</span></code></pre></div><h3 id="å¤‡ä»½-images"><a href="#å¤‡ä»½-images" class="headerlink" title="å¤‡ä»½ images"></a>å¤‡ä»½ images</h3><div class="hljs"><pre><code class="hljs bash"> cat images.sh
!/bin/bash

imagePath=<span class="hljs-string">"/root/images"</span>
mkdir -p <span class="hljs-variable">$&#123;imagePath&#125;</span>

<span class="hljs-function"><span class="hljs-title">save_images</span></span>() &#123;
    docker images|awk <span class="hljs-string">'!/REPOSITORY/ &amp;&amp; !/&lt;none&gt;/ &amp;&amp; !/docker-registry.default.svc/ &amp;&amp; !/jenkins/&#123;print $1,$2&#125;'</span> &gt; /tmp/images.list
    <span class="hljs-keyword">while</span> <span class="hljs-built_in">read</span> Name Version
    <span class="hljs-keyword">do</span>
        fileName=$(<span class="hljs-built_in">echo</span> <span class="hljs-variable">$Name</span> | awk -F\/ <span class="hljs-string">'&#123;print $NF&#125;'</span>)
        <span class="hljs-keyword">if</span> [ ! -f <span class="hljs-string">"<span class="hljs-variable">$&#123;imagePath&#125;</span>/<span class="hljs-variable">$&#123;fileName&#125;</span>_<span class="hljs-variable">$&#123;Version&#125;</span>.tgz"</span> ];<span class="hljs-keyword">then</span>
            <span class="hljs-built_in">echo</span> <span class="hljs-string">"save image <span class="hljs-variable">$Name</span>:<span class="hljs-variable">$Version</span>"</span>
            docker save <span class="hljs-variable">$Name</span>:<span class="hljs-variable">$Version</span> | gzip &gt; <span class="hljs-variable">$&#123;imagePath&#125;</span>/<span class="hljs-variable">$&#123;fileName&#125;</span>_<span class="hljs-variable">$&#123;Version&#125;</span>.tgz
        <span class="hljs-keyword">fi</span>
    <span class="hljs-keyword">done</span> &lt; /tmp/images.list
&#125;

<span class="hljs-function"><span class="hljs-title">load_images</span></span>() &#123;
    <span class="hljs-keyword">for</span> images <span class="hljs-keyword">in</span> $(ls <span class="hljs-variable">$&#123;imagePath&#125;</span>/*.tgz)
    <span class="hljs-keyword">do</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"load image <span class="hljs-variable">$images</span>"</span>
        docker load &lt; <span class="hljs-variable">$images</span>
    <span class="hljs-keyword">done</span>
&#125;

<span class="hljs-function"><span class="hljs-title">push_images</span></span>() &#123;
    newRegistry=<span class="hljs-string">"https://docker-registry-default.pase-hrx-stg1.zhi-niao.com/"</span>

    docker images|awk <span class="hljs-string">'!/REPOSITORY/ &amp;&amp; !/&lt;none&gt;/&#123;print $1,$2&#125;'</span> &gt; /tmp/images.list
    <span class="hljs-keyword">while</span> <span class="hljs-built_in">read</span> Name Version
    <span class="hljs-keyword">do</span>
        fileName=$(<span class="hljs-built_in">echo</span> <span class="hljs-variable">$Name</span> | awk -F/ <span class="hljs-string">'sub($1,"")'</span>)
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$&#123;Name&#125;</span>:<span class="hljs-variable">$&#123;Version&#125;</span> | new tag | <span class="hljs-variable">$&#123;newRegistry&#125;</span><span class="hljs-variable">$&#123;fileName&#125;</span>:<span class="hljs-variable">$&#123;Version&#125;</span>"</span>
        docker tag <span class="hljs-variable">$&#123;Name&#125;</span>:<span class="hljs-variable">$&#123;Version&#125;</span> <span class="hljs-variable">$&#123;newRegistry&#125;</span><span class="hljs-variable">$&#123;fileName&#125;</span>:<span class="hljs-variable">$&#123;Version&#125;</span>
        docker push <span class="hljs-variable">$&#123;newRegistry&#125;</span><span class="hljs-variable">$&#123;fileName&#125;</span>:<span class="hljs-variable">$&#123;Version&#125;</span>
        docker rmi <span class="hljs-variable">$&#123;newRegistry&#125;</span><span class="hljs-variable">$&#123;fileName&#125;</span>:<span class="hljs-variable">$&#123;Version&#125;</span>
    <span class="hljs-keyword">done</span> &lt; /tmp/images.list
&#125;

<span class="hljs-keyword">case</span> <span class="hljs-variable">$1</span> <span class="hljs-keyword">in</span>
    save|s)
        save_images
        ;;
    load|l)
        load_images
        ;;
    push|p)
        push_images
        ;;
    *)
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"Usage: <span class="hljs-variable">$0</span> &#123;save|load&#125;"</span>
        ;;
<span class="hljs-keyword">esac</span>

 åˆ†å‘ images.sh
 ansible master:worker:infra -m copy -a <span class="hljs-string">'src=images.sh dest=/root/images.sh mode=0755'</span>

 ansible master:worker:infra -m shell -a <span class="hljs-string">'./images.sh save'</span>
 <span class="hljs-keyword">for</span> host <span class="hljs-keyword">in</span> ukm02 ukm03 uki01 uki02 uki03 ukn01 ukn02 ukn03;<span class="hljs-keyword">do</span> rsync -vzrtopg --progress -e ssh <span class="hljs-variable">$&#123;host&#125;</span>:/root/images/* /root/images/;<span class="hljs-keyword">done</span></code></pre></div><h3 id="åˆ‡æ¢-namespace"><a href="#åˆ‡æ¢-namespace" class="headerlink" title="åˆ‡æ¢ namespace"></a>åˆ‡æ¢ namespace</h3><div class="hljs"><pre><code class="hljs bash">kubectl config <span class="hljs-built_in">set</span>-context --current --namespace=kube-system</code></pre></div><h3 id="è·å–åŠ å…¥é›†ç¾¤-token"><a href="#è·å–åŠ å…¥é›†ç¾¤-token" class="headerlink" title="è·å–åŠ å…¥é›†ç¾¤ token"></a>è·å–åŠ å…¥é›†ç¾¤ token</h3><div class="hljs"><pre><code class="hljs bash"> kubeadm token list
TOKEN                     TTL         EXPIRES                     USAGES                   DESCRIPTION                                                EXTRA GROUPS
gnc91d.aav2px3kb3021uxl   8h          2020-02-20T20:20:00+08:00   authentication,signing   The default bootstrap token generated by <span class="hljs-string">'kubeadm init'</span>.   system:bootstrappers:kubeadm:default-node-token</code></pre></div><h3 id="è·å–åŠ å…¥é›†ç¾¤-token-hash"><a href="#è·å–åŠ å…¥é›†ç¾¤-token-hash" class="headerlink" title="è·å–åŠ å…¥é›†ç¾¤ token hash"></a>è·å–åŠ å…¥é›†ç¾¤ token hash</h3><div class="hljs"><pre><code class="hljs bash"> openssl x509 -pubkey -<span class="hljs-keyword">in</span> /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2&gt;/dev/null | openssl dgst -sha256 -hex | sed <span class="hljs-string">'s/^.* //'</span>
ae56bc3c9cabaaf04878be16436348419a0772342d5cc71c371fb5a79157b5a8</code></pre></div><h3 id="é‡æ–°ç”Ÿæˆ-kubeadm-certs"><a href="#é‡æ–°ç”Ÿæˆ-kubeadm-certs" class="headerlink" title="é‡æ–°ç”Ÿæˆ kubeadm-certs"></a>é‡æ–°ç”Ÿæˆ kubeadm-certs</h3><ul><li>kubeadm-certs å¯†é’¥å’Œè§£å¯†å¯†é’¥ä¼šåœ¨ä¸¤ä¸ªå°æ—¶åå¤±æ•ˆ</li></ul><div class="hljs"><pre><code class="hljs bash"> kubeadm init phase upload-certs --upload-certs
[upload-certs] Storing the certificates <span class="hljs-keyword">in</span> Secret <span class="hljs-string">"kubeadm-certs"</span> <span class="hljs-keyword">in</span> the <span class="hljs-string">"kube-system"</span> Namespace
[upload-certs] Using certificate key:
4379fa5fdc142d5e98d01a290b8490fc9a169e2a4c3a94695ec3745573b22fb3</code></pre></div><h3 id="æŸ¥çœ‹-kubernetes-è¯ä¹¦çŠ¶æ€"><a href="#æŸ¥çœ‹-kubernetes-è¯ä¹¦çŠ¶æ€" class="headerlink" title="æŸ¥çœ‹ kubernetes è¯ä¹¦çŠ¶æ€"></a>æŸ¥çœ‹ kubernetes è¯ä¹¦çŠ¶æ€</h3><div class="hljs"><pre><code class="hljs bash"> kubeadm alpha certs check-expiration
[check-expiration] Reading configuration from the cluster...
[check-expiration] FYI: You can look at this config file with <span class="hljs-string">'kubectl -n kube-system get cm kubeadm-config -oyaml'</span>

CERTIFICATE                EXPIRES                  RESIDUAL TIME   CERTIFICATE AUTHORITY   EXTERNALLY MANAGED
admin.conf                 Apr 22, 2021 09:03 UTC   364d                                    no
apiserver                  Apr 22, 2021 09:03 UTC   364d            ca                      no
apiserver-etcd-client      Apr 22, 2021 09:03 UTC   364d            etcd-ca                 no
apiserver-kubelet-client   Apr 22, 2021 09:03 UTC   364d            ca                      no
controller-manager.conf    Apr 22, 2021 09:03 UTC   364d                                    no
etcd-healthcheck-client    Apr 22, 2021 09:03 UTC   364d            etcd-ca                 no
etcd-peer                  Apr 22, 2021 09:03 UTC   364d            etcd-ca                 no
etcd-server                Apr 22, 2021 09:03 UTC   364d            etcd-ca                 no
front-proxy-client         Apr 22, 2021 09:03 UTC   364d            front-proxy-ca          no
scheduler.conf             Apr 22, 2021 09:03 UTC   364d                                    no

CERTIFICATE AUTHORITY   EXPIRES                  RESIDUAL TIME   EXTERNALLY MANAGED
ca                      Apr 14, 2030 11:18 UTC   9y              no
etcd-ca                 Apr 14, 2030 11:18 UTC   9y              no
front-proxy-ca          Apr 14, 2030 11:18 UTC   9y              no</code></pre></div><h3 id="é‡æ–°ç­¾å‘æ‰€æœ‰-kubernetes-è¯ä¹¦"><a href="#é‡æ–°ç­¾å‘æ‰€æœ‰-kubernetes-è¯ä¹¦" class="headerlink" title="é‡æ–°ç­¾å‘æ‰€æœ‰ kubernetes è¯ä¹¦"></a>é‡æ–°ç­¾å‘æ‰€æœ‰ kubernetes è¯ä¹¦</h3><div class="hljs"><pre><code class="hljs bash"> kubeadm alpha certs renew all
[renew] Reading configuration from the cluster...
[renew] FYI: You can look at this config file with <span class="hljs-string">'kubectl -n kube-system get cm kubeadm-config -oyaml'</span>

certificate embedded <span class="hljs-keyword">in</span> the kubeconfig file <span class="hljs-keyword">for</span> the admin to use and <span class="hljs-keyword">for</span> kubeadm itself renewed
certificate <span class="hljs-keyword">for</span> serving the Kubernetes API renewed
certificate the apiserver uses to access etcd renewed
certificate <span class="hljs-keyword">for</span> the API server to connect to kubelet renewed
certificate embedded <span class="hljs-keyword">in</span> the kubeconfig file <span class="hljs-keyword">for</span> the controller manager to use renewed
certificate <span class="hljs-keyword">for</span> liveness probes to healthcheck etcd renewed
certificate <span class="hljs-keyword">for</span> etcd nodes to communicate with each other renewed
certificate <span class="hljs-keyword">for</span> serving etcd renewed
certificate <span class="hljs-keyword">for</span> the front proxy client renewed
certificate embedded <span class="hljs-keyword">in</span> the kubeconfig file <span class="hljs-keyword">for</span> the scheduler manager to use renewed</code></pre></div><h3 id="æ›´æ–°è¯ä¹¦ç­¾å"><a href="#æ›´æ–°è¯ä¹¦ç­¾å" class="headerlink" title="æ›´æ–°è¯ä¹¦ç­¾å"></a>æ›´æ–°è¯ä¹¦ç­¾å</h3><div class="hljs"><pre><code class="hljs bash"> åˆ›å»ºæ›´æ–°é…ç½®
 cat &gt; ca-sign.yaml &lt;&lt;EOF
apiVersion: kubeadm.k8s.io/v1beta2
kind: ClusterConfiguration
apiServer:
  certSANs:
  - <span class="hljs-string">"10.10.34.89"</span>
  - <span class="hljs-string">"10.10.34.92"</span>
  - <span class="hljs-string">"10.10.34.93"</span>
  - <span class="hljs-string">"10.10.34.94"</span>
  - <span class="hljs-string">"113.108.71.77"</span>
  - <span class="hljs-string">"kubernetes"</span>
  - <span class="hljs-string">"kubernetes.default"</span>
  - <span class="hljs-string">"kubernetes.default.svc"</span>
  - <span class="hljs-string">"kubernetes.default.svc.cluster"</span>
  - <span class="hljs-string">"kubernetes.default.svc.cluster.local"</span>
controllerManager:
  extraArgs:
    cluster-signing-cert-file: /etc/kubernetes/pki/ca.crt
    cluster-signing-key-file: /etc/kubernetes/pki/ca.key
EOF

 æ›´æ–° kubernetes é…ç½®
 kubeadm config upload from-file --config=ca-sign.yaml

 ç¡®è®¤æ›´æ–°é…ç½®ç”Ÿæ•ˆ
 kubeadm config view
apiServer:
  certSANs:
  - 10.10.34.89
  - 10.10.34.92
  - 10.10.34.93
  - 10.10.34.94
  - 113.108.71.77
  - kubernetes
  - kubernetes.default
  - kubernetes.default.svc
  - kubernetes.default.svc.cluster
  - kubernetes.default.svc.cluster.local
  timeoutForControlPlane: 4m0s
apiVersion: kubeadm.k8s.io/v1beta2
certificatesDir: /etc/kubernetes/pki
clusterName: kubernetes
controllerManager:
  extraArgs:
    cluster-signing-cert-file: /etc/kubernetes/pki/ca.crt
    cluster-signing-key-file: /etc/kubernetes/pki/ca.key
dns:
  <span class="hljs-built_in">type</span>: CoreDNS
etcd:
  <span class="hljs-built_in">local</span>:
    dataDir: /var/lib/etcd
imageRepository: k8s.gcr.io
kind: ClusterConfiguration
kubernetesVersion: v1.18.2
networking:
  dnsDomain: cluster.local
  serviceSubnet: 10.96.0.0/12
scheduler: &#123;&#125;

 åˆ é™¤åŸ apiserver è¯ä¹¦
 rm -rf /etc/kubernetes/pki/apiserver.*

 é‡æ–°ç”Ÿæˆ apiserver è¯ä¹¦
 kubeadm init phase certs apiserver --config=ca-sign.yaml
W0429 15:59:26.534066   10196 configset.go:202] WARNING: kubeadm cannot validate component configs <span class="hljs-keyword">for</span> API groups [kubelet.config.k8s.io kubeproxy.config.k8s.io]
[certs] Generating <span class="hljs-string">"apiserver"</span> certificate and key
[certs] apiserver serving cert is signed <span class="hljs-keyword">for</span> DNS names [ukm01 kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.cluster.local ukm01 ukm02 ukm03 kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.cluster kubernetes.default.svc.cluster.local] and IPs [10.96.0.1 10.10.34.92 10.10.34.89 10.10.34.92 10.10.34.93 10.10.34.94 113.108.71.77]


 ç¡®è®¤ apiserver è¯ä¹¦æ›´æ–°æƒ…å†µ
 openssl x509 -text -noout -<span class="hljs-keyword">in</span> /etc/kubernetes/pki/apiserver.crt
...
        X509v3 extensions:
            X509v3 Key Usage: critical
                Digital Signature, Key Encipherment
            X509v3 Extended Key Usage:
                TLS Web Server Authentication
            X509v3 Subject Alternative Name:
                DNS:ukm01, DNS:kubernetes, DNS:kubernetes.default, DNS:kubernetes.default.svc, DNS:kubernetes.default.svc.cluster.local, DNS:ukm01, DNS:ukm02, DNS:ukm03, DNS:kubernetes, DNS:kubernetes.default, DNS:kubernetes.default.svc, DNS:kubernetes.default.svc.cluster, DNS:kubernetes.default.svc.cluster.local, IP Address:10.96.0.1, IP Address:10.10.34.92, IP Address:10.10.34.89, IP Address:10.10.34.92, IP Address:10.10.34.93, IP Address:10.10.34.94, IP Address:113.108.71.77
...

 æ›´æ–°æ‰€æœ‰è¯ä¹¦
 kubeadm alpha certs renew all --config=ca-sign.yaml
W0429 15:50:57.792294    2944 configset.go:202] WARNING: kubeadm cannot validate component configs <span class="hljs-keyword">for</span> API groups [kubelet.config.k8s.io kubeproxy.config.k8s.io]
certificate embedded <span class="hljs-keyword">in</span> the kubeconfig file <span class="hljs-keyword">for</span> the admin to use and <span class="hljs-keyword">for</span> kubeadm itself renewed
certificate <span class="hljs-keyword">for</span> serving the Kubernetes API renewed
certificate the apiserver uses to access etcd renewed
certificate <span class="hljs-keyword">for</span> the API server to connect to kubelet renewed
certificate embedded <span class="hljs-keyword">in</span> the kubeconfig file <span class="hljs-keyword">for</span> the controller manager to use renewed
certificate <span class="hljs-keyword">for</span> liveness probes to healthcheck etcd renewed
certificate <span class="hljs-keyword">for</span> etcd nodes to communicate with each other renewed
certificate <span class="hljs-keyword">for</span> serving etcd renewed
certificate <span class="hljs-keyword">for</span> the front proxy client renewed
certificate embedded <span class="hljs-keyword">in</span> the kubeconfig file <span class="hljs-keyword">for</span> the scheduler manager to use renewed

 é€šè¿‡ api æ›´æ–°æ‰€æœ‰è¯ä¹¦ï¼Œéœ€è¦æ‰§è¡Œç¡®è®¤å‘½ä»¤ã€‚
 kubeadm alpha certs renew all --use-api --config=ca-sign.yaml &amp;
...
[certs] Certificate request <span class="hljs-string">"kubeadm-cert-kubernetes-admin-8pvf8"</span> created
...

 æ‰¹å‡†æ›´æ–°
 kubectl get csr | awk <span class="hljs-string">'!/Approved/ &amp;&amp; !/NAME/&#123;print "kubectl certificate approve "$1&#125;'</span> | bash
...
certificatesigningrequest.certificates.k8s.io/kubeadm-cert-kubernetes-admin-8pvf8 approved
...

 æŸ¥çœ‹è¯ä¹¦æ›´æ–°çŠ¶æ€
 kubectl get csr
NAME                                                AGE     SIGNERNAME                     REQUESTOR          CONDITION
kubeadm-cert-front-proxy-client-tq62p               101s    kubernetes.io/legacy-unknown   kubernetes-admin   Approved,Issued
kubeadm-cert-kube-apiserver-etcd-client-rnnjn       2m15s   kubernetes.io/legacy-unknown   kubernetes-admin   Approved,Issued
kubeadm-cert-kube-apiserver-fk62g                   2m16s   kubernetes.io/legacy-unknown   kubernetes-admin   Approved,Issued
kubeadm-cert-kube-apiserver-kubelet-client-5cmpv    2m11s   kubernetes.io/legacy-unknown   kubernetes-admin   Approved,Issued
kubeadm-cert-kube-etcd-healthcheck-client-7lcw9     118s    kubernetes.io/legacy-unknown   kubernetes-admin   Approved,Issued
kubeadm-cert-kubernetes-admin-8pvf8                 3m24s   kubernetes.io/legacy-unknown   kubernetes-admin   Approved,Issued
kubeadm-cert-system:kube-controller-manager-bgsmt   2m8s    kubernetes.io/legacy-unknown   kubernetes-admin   Approved,Issued
kubeadm-cert-system:kube-scheduler-dhj6b            96s     kubernetes.io/legacy-unknown   kubernetes-admin   Approved,Issued
kubeadm-cert-ukm01-2bwbg                            115s    kubernetes.io/legacy-unknown   kubernetes-admin   Approved,Issued
kubeadm-cert-ukm01-ftrgn                            104s    kubernetes.io/legacy-unknown   kubernetes-admin   Approved,Issued</code></pre></div><h2 id="å¸è½½-kubernetes-é›†ç¾¤"><a href="#å¸è½½-kubernetes-é›†ç¾¤" class="headerlink" title="å¸è½½ kubernetes é›†ç¾¤"></a><strong>å¸è½½ kubernetes é›†ç¾¤</strong></h2><h3 id="å…ˆéš”ç¦»å†åˆ é™¤èŠ‚ç‚¹"><a href="#å…ˆéš”ç¦»å†åˆ é™¤èŠ‚ç‚¹" class="headerlink" title="å…ˆéš”ç¦»å†åˆ é™¤èŠ‚ç‚¹"></a>å…ˆéš”ç¦»å†åˆ é™¤èŠ‚ç‚¹</h3><div class="hljs"><pre><code class="hljs bash">kubectl drain uki01 uki02 uki03 ukm01 ukm02 ukm03 ukn01 ukn02 ukn03 --delete-local-data --force --ignore-daemonsets

kubectl delete node uki01 uki02 uki03 ukm01 ukm02 ukm03 ukn01 ukn02 ukn03</code></pre></div><h3 id="é‡ç½®èŠ‚ç‚¹çŠ¶æ€"><a href="#é‡ç½®èŠ‚ç‚¹çŠ¶æ€" class="headerlink" title="é‡ç½®èŠ‚ç‚¹çŠ¶æ€"></a>é‡ç½®èŠ‚ç‚¹çŠ¶æ€</h3><div class="hljs"><pre><code class="hljs bash">ansible ins -m shell -a <span class="hljs-string">'kubeadm reset --force'</span>

ansible ins -m shell -a <span class="hljs-string">'rm -rf /etc/cni /opt/cni/ /var/lib/calico/ ~/.kube/'</span></code></pre></div><h2 id="kubernetes-é›†ç¾¤å‡çº§"><a href="#kubernetes-é›†ç¾¤å‡çº§" class="headerlink" title="kubernetes é›†ç¾¤å‡çº§"></a><strong>kubernetes é›†ç¾¤å‡çº§</strong></h2><h3 id="æ£€æŸ¥-kubeadm-å¯ç”¨ç‰ˆæœ¬"><a href="#æ£€æŸ¥-kubeadm-å¯ç”¨ç‰ˆæœ¬" class="headerlink" title="æ£€æŸ¥ kubeadm å¯ç”¨ç‰ˆæœ¬"></a>æ£€æŸ¥ kubeadm å¯ç”¨ç‰ˆæœ¬</h3><div class="hljs"><pre><code class="hljs bash">apt update &amp;&amp; apt-cache policy kubeadm</code></pre></div><h3 id="å‡çº§-kubeadm"><a href="#å‡çº§-kubeadm" class="headerlink" title="å‡çº§ kubeadm"></a>å‡çº§ kubeadm</h3><p>å»ºè®®ä¸€å°ä¸€å°å‡çº§ï¼Œæ‰¹é‡æ“ä½œå­˜åœ¨æ— æ³•é¢„ä¼°çš„é”™è¯¯ã€‚</p><div class="hljs"><pre><code class="hljs bash">apt-mark unhold kubeadm &amp;&amp; \
 apt-get update &amp;&amp; apt-get install -y kubeadm=1.18.0-00 &amp;&amp; \
 apt-mark hold kubeadm

æˆ–è€…
apt-get update &amp;&amp; \
 apt-get install -y --allow-change-held-packages kubeadm=1.18.0-00</code></pre></div><h3 id="éªŒè¯-kubeadm-ç‰ˆæœ¬"><a href="#éªŒè¯-kubeadm-ç‰ˆæœ¬" class="headerlink" title="éªŒè¯ kubeadm ç‰ˆæœ¬"></a>éªŒè¯ kubeadm ç‰ˆæœ¬</h3><div class="hljs"><pre><code class="hljs bash"> kubeadm version
kubeadm version: &amp;version.Info&#123;Major:<span class="hljs-string">"1"</span>, Minor:<span class="hljs-string">"18"</span>, GitVersion:<span class="hljs-string">"v1.18.0"</span>, GitCommit:<span class="hljs-string">"9e991415386e4cf155a24b1da15becaa390438d8"</span>, GitTreeState:<span class="hljs-string">"clean"</span>, BuildDate:<span class="hljs-string">"2020-03-25T14:56:30Z"</span>, GoVersion:<span class="hljs-string">"go1.13.8"</span>, Compiler:<span class="hljs-string">"gc"</span>, Platform:<span class="hljs-string">"linux/amd64"</span>&#125;</code></pre></div><h3 id="éš”ç¦»-ukm01"><a href="#éš”ç¦»-ukm01" class="headerlink" title="éš”ç¦» ukm01"></a>éš”ç¦» ukm01</h3><div class="hljs"><pre><code class="hljs bash"> kubectl drain ukm01 --ignore-daemonsets
node/ukm01 cordoned
node/ukm01 drained</code></pre></div><h3 id="æŸ¥çœ‹å¯å‡çº§ç‰ˆæœ¬"><a href="#æŸ¥çœ‹å¯å‡çº§ç‰ˆæœ¬" class="headerlink" title="æŸ¥çœ‹å¯å‡çº§ç‰ˆæœ¬"></a>æŸ¥çœ‹å¯å‡çº§ç‰ˆæœ¬</h3><div class="hljs"><pre><code class="hljs bash"> kubeadm upgrade plan
[upgrade/config] Making sure the configuration is correct:
[upgrade/config] Reading configuration from the cluster...
[upgrade/config] FYI: You can look at this config file with <span class="hljs-string">'kubectl -n kube-system get cm kubeadm-config -oyaml'</span>
[preflight] Running pre-flight checks.
[upgrade] Running cluster health checks
[upgrade] Fetching available versions to upgrade to
[upgrade/versions] Cluster version: v1.17.3
[upgrade/versions] kubeadm version: v1.18.0
[upgrade/versions] Latest stable version: v1.18.0
[upgrade/versions] Latest stable version: v1.18.0
[upgrade/versions] Latest version <span class="hljs-keyword">in</span> the v1.17 series: v1.17.4
[upgrade/versions] Latest version <span class="hljs-keyword">in</span> the v1.17 series: v1.17.4

Components that must be upgraded manually after you have upgraded the control plane with <span class="hljs-string">'kubeadm upgrade apply'</span>:
COMPONENT   CURRENT       AVAILABLE
Kubelet     9 x v1.17.3   v1.17.4

Upgrade to the latest version <span class="hljs-keyword">in</span> the v1.17 series:

COMPONENT            CURRENT   AVAILABLE
API Server           v1.17.3   v1.17.4
Controller Manager   v1.17.3   v1.17.4
Scheduler            v1.17.3   v1.17.4
Kube Proxy           v1.17.3   v1.17.4
CoreDNS              1.6.5     1.6.7
Etcd                 3.4.3     3.4.3-0

You can now apply the upgrade by executing the following <span class="hljs-built_in">command</span>:

  kubeadm upgrade apply v1.17.4

_____________________________________________________________________

Components that must be upgraded manually after you have upgraded the control plane with <span class="hljs-string">'kubeadm upgrade apply'</span>:
COMPONENT   CURRENT       AVAILABLE
Kubelet     9 x v1.17.3   v1.18.0

Upgrade to the latest stable version:

COMPONENT            CURRENT   AVAILABLE
API Server           v1.17.3   v1.18.0
Controller Manager   v1.17.3   v1.18.0
Scheduler            v1.17.3   v1.18.0
Kube Proxy           v1.17.3   v1.18.0
CoreDNS              1.6.5     1.6.7
Etcd                 3.4.3     3.4.3-0

You can now apply the upgrade by executing the following <span class="hljs-built_in">command</span>:

  kubeadm upgrade apply v1.18.0

_____________________________________________________________________</code></pre></div><h3 id="å‡çº§-kubernetes"><a href="#å‡çº§-kubernetes" class="headerlink" title="å‡çº§ kubernetes"></a>å‡çº§ kubernetes</h3><div class="hljs"><pre><code class="hljs bash"> kubeadm upgrade apply v1.18.0
[upgrade/config] Making sure the configuration is correct:
[upgrade/config] Reading configuration from the cluster...
[upgrade/config] FYI: You can look at this config file with <span class="hljs-string">'kubectl -n kube-system get cm kubeadm-config -oyaml'</span>
[preflight] Running pre-flight checks.
[upgrade] Running cluster health checks
[upgrade/version] You have chosen to change the cluster version to <span class="hljs-string">"v1.18.0"</span>
[upgrade/versions] Cluster version: v1.17.3
[upgrade/versions] kubeadm version: v1.18.0
[upgrade/confirm] Are you sure you want to proceed with the upgrade? [y/N]: y
[upgrade/prepull] Will prepull images <span class="hljs-keyword">for</span> components [kube-apiserver kube-controller-manager kube-scheduler etcd]
[upgrade/prepull] Prepulling image <span class="hljs-keyword">for</span> component etcd.
[upgrade/prepull] Prepulling image <span class="hljs-keyword">for</span> component kube-apiserver.
[upgrade/prepull] Prepulling image <span class="hljs-keyword">for</span> component kube-controller-manager.
[upgrade/prepull] Prepulling image <span class="hljs-keyword">for</span> component kube-scheduler.
[apiclient] Found 0 Pods <span class="hljs-keyword">for</span> label selector k8s-app=upgrade-prepull-etcd
[apiclient] Found 3 Pods <span class="hljs-keyword">for</span> label selector k8s-app=upgrade-prepull-kube-controller-manager
[apiclient] Found 3 Pods <span class="hljs-keyword">for</span> label selector k8s-app=upgrade-prepull-kube-apiserver
[apiclient] Found 0 Pods <span class="hljs-keyword">for</span> label selector k8s-app=upgrade-prepull-kube-scheduler
[apiclient] Found 3 Pods <span class="hljs-keyword">for</span> label selector k8s-app=upgrade-prepull-etcd
[apiclient] Found 3 Pods <span class="hljs-keyword">for</span> label selector k8s-app=upgrade-prepull-kube-scheduler
[upgrade/prepull] Prepulled image <span class="hljs-keyword">for</span> component etcd.
[upgrade/prepull] Prepulled image <span class="hljs-keyword">for</span> component kube-scheduler.
[apiclient] Error getting Pods with label selector <span class="hljs-string">"k8s-app=upgrade-prepull-kube-apiserver"</span> [etcdserver: request timed out]
[apiclient] Error getting Pods with label selector <span class="hljs-string">"k8s-app=upgrade-prepull-kube-controller-manager"</span> [etcdserver: request timed out]
[upgrade/prepull] Prepulled image <span class="hljs-keyword">for</span> component kube-controller-manager.
[upgrade/prepull] Prepulled image <span class="hljs-keyword">for</span> component kube-apiserver.
[upgrade/prepull] Successfully prepulled the images <span class="hljs-keyword">for</span> all the control plane components
[upgrade/apply] Upgrading your Static Pod-hosted control plane to version <span class="hljs-string">"v1.18.0"</span>...
Static pod: kube-apiserver-ukm01 <span class="hljs-built_in">hash</span>: 7e7a0d385fce06636ac0fc223274d299
Static pod: kube-controller-manager-ukm01 <span class="hljs-built_in">hash</span>: fdad41767b3b13675192402b9a840a5c
Static pod: kube-scheduler-ukm01 <span class="hljs-built_in">hash</span>: 703c43ab97818f969f780a2cbf4d24b7
[upgrade/etcd] Upgrading to TLS <span class="hljs-keyword">for</span> etcd
[upgrade/etcd] Non fatal issue encountered during upgrade: the desired etcd version <span class="hljs-keyword">for</span> this Kubernetes version <span class="hljs-string">"v1.18.0"</span> is <span class="hljs-string">"3.4.3-0"</span>, but the current etcd version is <span class="hljs-string">"3.4.3"</span>. Won<span class="hljs-string">'t downgrade etcd, instead just continue</span>
<span class="hljs-string">[upgrade/staticpods] Writing new Static Pod manifests to "/etc/kubernetes/tmp/kubeadm-upgraded-manifests739015179"</span>
<span class="hljs-string">W0403 09:40:19.888673   21690 manifests.go:225] the default kube-apiserver authorization-mode is "Node,RBAC"; using "Node,RBAC"</span>
<span class="hljs-string">[upgrade/staticpods] Preparing for "kube-apiserver" upgrade</span>
<span class="hljs-string">[upgrade/staticpods] Renewing apiserver certificate</span>
<span class="hljs-string">[upgrade/staticpods] Renewing apiserver-kubelet-client certificate</span>
<span class="hljs-string">[upgrade/staticpods] Renewing front-proxy-client certificate</span>
<span class="hljs-string">[upgrade/staticpods] Renewing apiserver-etcd-client certificate</span>
<span class="hljs-string">[upgrade/staticpods] Moved new manifest to "/etc/kubernetes/manifests/kube-apiserver.yaml" and backed up old manifest to "/etc/kubernetes/tmp/kubeadm-backup-manifests-2020-04-03-09-40-18/kube-apiserver.yaml"</span>
<span class="hljs-string">[upgrade/staticpods] Waiting for the kubelet to restart the component</span>
<span class="hljs-string">[upgrade/staticpods] This might take a minute or longer depending on the component/version gap (timeout 5m0s)</span>
<span class="hljs-string">Static pod: kube-apiserver-ukm01 hash: 7e7a0d385fce06636ac0fc223274d299</span>
<span class="hljs-string">Static pod: kube-apiserver-ukm01 hash: 7e7a0d385fce06636ac0fc223274d299</span>
<span class="hljs-string">Static pod: kube-apiserver-ukm01 hash: 7e7a0d385fce06636ac0fc223274d299</span>
<span class="hljs-string">Static pod: kube-apiserver-ukm01 hash: 7e7a0d385fce06636ac0fc223274d299</span>
<span class="hljs-string">Static pod: kube-apiserver-ukm01 hash: 7e7a0d385fce06636ac0fc223274d299</span>
<span class="hljs-string">Static pod: kube-apiserver-ukm01 hash: 7e7a0d385fce06636ac0fc223274d299</span>
<span class="hljs-string">Static pod: kube-apiserver-ukm01 hash: f9ef3245bc9735275ed5508f8bbea7e1</span>
<span class="hljs-string">[apiclient] Found 3 Pods for label selector component=kube-apiserver</span>
<span class="hljs-string">[upgrade/staticpods] Component "kube-apiserver" upgraded successfully!</span>
<span class="hljs-string">[upgrade/staticpods] Preparing for "kube-controller-manager" upgrade</span>
<span class="hljs-string">[upgrade/staticpods] Renewing controller-manager.conf certificate</span>
<span class="hljs-string">[upgrade/staticpods] Moved new manifest to "/etc/kubernetes/manifests/kube-controller-manager.yaml" and backed up old manifest to "/etc/kubernetes/tmp/kubeadm-backup-manifests-2020-04-03-09-40-18/kube-controller-manager.yaml"</span>
<span class="hljs-string">[upgrade/staticpods] Waiting for the kubelet to restart the component</span>
<span class="hljs-string">[upgrade/staticpods] This might take a minute or longer depending on the component/version gap (timeout 5m0s)</span>
<span class="hljs-string">Static pod: kube-controller-manager-ukm01 hash: fdad41767b3b13675192402b9a840a5c</span>
<span class="hljs-string">Static pod: kube-controller-manager-ukm01 hash: 24e6dad5d81a4c5257a7b29861a48543</span>
<span class="hljs-string">[apiclient] Found 3 Pods for label selector component=kube-controller-manager</span>
<span class="hljs-string">[upgrade/staticpods] Component "kube-controller-manager" upgraded successfully!</span>
<span class="hljs-string">[upgrade/staticpods] Preparing for "kube-scheduler" upgrade</span>
<span class="hljs-string">[upgrade/staticpods] Renewing scheduler.conf certificate</span>
<span class="hljs-string">[upgrade/staticpods] Moved new manifest to "/etc/kubernetes/manifests/kube-scheduler.yaml" and backed up old manifest to "/etc/kubernetes/tmp/kubeadm-backup-manifests-2020-04-03-09-40-18/kube-scheduler.yaml"</span>
<span class="hljs-string">[upgrade/staticpods] Waiting for the kubelet to restart the component</span>
<span class="hljs-string">[upgrade/staticpods] This might take a minute or longer depending on the component/version gap (timeout 5m0s)</span>
<span class="hljs-string">Static pod: kube-scheduler-ukm01 hash: 703c43ab97818f969f780a2cbf4d24b7</span>
<span class="hljs-string">Static pod: kube-scheduler-ukm01 hash: b10b96b094242086df7de02b74f10de2</span>
<span class="hljs-string">[apiclient] Found 3 Pods for label selector component=kube-scheduler</span>
<span class="hljs-string">[upgrade/staticpods] Component "kube-scheduler" upgraded successfully!</span>
<span class="hljs-string">[upload-config] Storing the configuration used in ConfigMap "kubeadm-config" in the "kube-system" Namespace</span>
<span class="hljs-string">[kubelet] Creating a ConfigMap "kubelet-config-1.18" in namespace kube-system with the configuration for the kubelets in the cluster</span>
<span class="hljs-string">[kubelet-start] Downloading configuration for the kubelet from the "kubelet-config-1.18" ConfigMap in the kube-system namespace</span>
<span class="hljs-string">[kubelet-start] Writing kubelet configuration to file "/var/lib/kubelet/config.yaml"</span>
<span class="hljs-string">[bootstrap-token] configured RBAC rules to allow Node Bootstrap tokens to post CSRs in order for nodes to get long term certificate credentials</span>
<span class="hljs-string">[bootstrap-token] configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node Bootstrap Token</span>
<span class="hljs-string">[bootstrap-token] configured RBAC rules to allow certificate rotation for all node client certificates in the cluster</span>
<span class="hljs-string">[addons] Applied essential addon: CoreDNS</span>
<span class="hljs-string">[addons] Applied essential addon: kube-proxy</span>
<span class="hljs-string"></span>
<span class="hljs-string">[upgrade/successful] SUCCESS! Your cluster was upgraded to "v1.18.0". Enjoy!</span>
<span class="hljs-string"></span>
<span class="hljs-string">[upgrade/kubelet] Now that your control plane is upgraded, please proceed with upgrading your kubelets if you haven'</span>t already <span class="hljs-keyword">done</span> so.</code></pre></div><h3 id="å–æ¶ˆéš”ç¦»"><a href="#å–æ¶ˆéš”ç¦»" class="headerlink" title="å–æ¶ˆéš”ç¦»"></a>å–æ¶ˆéš”ç¦»</h3><div class="hljs"><pre><code class="hljs bash"> kubectl uncordon ukm01
node/ukm01 uncordoned</code></pre></div><h3 id="å‡çº§-kubectl-å’Œ-kubelet"><a href="#å‡çº§-kubectl-å’Œ-kubelet" class="headerlink" title="å‡çº§ kubectl å’Œ kubelet"></a>å‡çº§ kubectl å’Œ kubelet</h3><div class="hljs"><pre><code class="hljs bash">apt-mark unhold kubelet kubectl &amp;&amp; \
 apt-get update &amp;&amp; apt-get install -y kubelet=1.18.0-00 kubectl=1.18.0-00 &amp;&amp; \
 apt-mark hold kubelet kubectl

æˆ–è€…
apt-get update &amp;&amp; \
 apt-get install -y --allow-change-held-packages kubelet=1.18.0-00 kubectl=1.18.0-00</code></pre></div><h3 id="å‡çº§å…¶ä»–masterèŠ‚ç‚¹-kubeadm"><a href="#å‡çº§å…¶ä»–masterèŠ‚ç‚¹-kubeadm" class="headerlink" title="å‡çº§å…¶ä»–masterèŠ‚ç‚¹ kubeadm"></a>å‡çº§å…¶ä»–masterèŠ‚ç‚¹ kubeadm</h3><div class="hljs"><pre><code class="hljs bash">ansible master:\!ans -m shell -a <span class="hljs-string">'apt-mark unhold kubeadm &amp;&amp; apt-get update &amp;&amp; apt-get install -y kubeadm=1.18.0-00 &amp;&amp; apt-mark hold kubeadm'</span>
ansible master:\!ans -m shell -a <span class="hljs-string">'apt-mark unhold kubelet kubectl &amp;&amp; apt-get update &amp;&amp; apt-get install -y kubelet=1.18.0-00 kubectl=1.18.0-00 &amp;&amp; apt-mark hold kubelet kubectl'</span>
ansible master:\!ans -m shell -a <span class="hljs-string">'kubeadm version'</span></code></pre></div><h3 id="å‡çº§-master-èŠ‚ç‚¹-kubernetes"><a href="#å‡çº§-master-èŠ‚ç‚¹-kubernetes" class="headerlink" title="å‡çº§ master èŠ‚ç‚¹ kubernetes"></a>å‡çº§ master èŠ‚ç‚¹ kubernetes</h3><div class="hljs"><pre><code class="hljs bash">kubectl drain ukm02 --ignore-daemonsets
ssh ukm02
kubeadm upgrade node
<span class="hljs-built_in">exit</span>
kubectl uncordon ukm02</code></pre></div><h3 id="å‡çº§-master-èŠ‚ç‚¹-kubectl-å’Œ-kubelet"><a href="#å‡çº§-master-èŠ‚ç‚¹-kubectl-å’Œ-kubelet" class="headerlink" title="å‡çº§ master èŠ‚ç‚¹ kubectl å’Œ kubelet"></a>å‡çº§ master èŠ‚ç‚¹ kubectl å’Œ kubelet</h3><div class="hljs"><pre><code class="hljs bash">ansible master -m shell -a <span class="hljs-string">'apt-mark unhold kubelet kubectl &amp;&amp; apt-get update &amp;&amp; apt-get install -y kubelet=1.18.0-00 kubectl=1.18.0-00 &amp;&amp; apt-mark hold kubelet kubectl'</span></code></pre></div><h3 id="é‡å¯-master-èŠ‚ç‚¹-kubelet"><a href="#é‡å¯-master-èŠ‚ç‚¹-kubelet" class="headerlink" title="é‡å¯ master èŠ‚ç‚¹ kubelet"></a>é‡å¯ master èŠ‚ç‚¹ kubelet</h3><div class="hljs"><pre><code class="hljs bash">ansible master -m shell -a <span class="hljs-string">'systemctl restart kubelet'</span></code></pre></div><h3 id="ç¡®è®¤å‡çº§æˆåŠŸ"><a href="#ç¡®è®¤å‡çº§æˆåŠŸ" class="headerlink" title="ç¡®è®¤å‡çº§æˆåŠŸ"></a>ç¡®è®¤å‡çº§æˆåŠŸ</h3><div class="hljs"><pre><code class="hljs bash"> kubectl get nodes
NAME    STATUS   ROLES    AGE   VERSION
uki01   Ready    infra    8d    v1.17.3
uki02   Ready    infra    8d    v1.17.3
uki03   Ready    infra    8d    v1.17.3
ukm01   Ready    master   8d    v1.18.0
ukm02   Ready    master   8d    v1.18.0
ukm03   Ready    master   8d    v1.18.0
ukn01   Ready    worker   8d    v1.17.3
ukn02   Ready    worker   8d    v1.17.3
ukn03   Ready    worker   8d    v1.17.3</code></pre></div><h3 id="å‡çº§-infra-å’Œ-worker-èŠ‚ç‚¹-kubeadm"><a href="#å‡çº§-infra-å’Œ-worker-èŠ‚ç‚¹-kubeadm" class="headerlink" title="å‡çº§ infra å’Œ worker èŠ‚ç‚¹ kubeadm"></a>å‡çº§ infra å’Œ worker èŠ‚ç‚¹ kubeadm</h3><div class="hljs"><pre><code class="hljs bash">ansible infra:worker -m shell -a <span class="hljs-string">'apt-mark unhold kubeadm &amp;&amp; apt-get update &amp;&amp; apt-get install -y kubeadm=1.18.0-00 &amp;&amp; apt-mark hold kubeadm'</span></code></pre></div><h3 id="å‡çº§-infra-å’Œ-worker-èŠ‚ç‚¹-kubernetes"><a href="#å‡çº§-infra-å’Œ-worker-èŠ‚ç‚¹-kubernetes" class="headerlink" title="å‡çº§ infra å’Œ worker èŠ‚ç‚¹ kubernetes"></a>å‡çº§ infra å’Œ worker èŠ‚ç‚¹ kubernetes</h3><div class="hljs"><pre><code class="hljs bash">kubectl drain uki01 --ignore-daemonsets
ssh uki01
kubeadm upgrade node
<span class="hljs-built_in">exit</span>
kubectl uncordon uki01</code></pre></div><h3 id="å‡çº§-infra-å’Œ-worker-èŠ‚ç‚¹-kubectl-å’Œ-kubelet"><a href="#å‡çº§-infra-å’Œ-worker-èŠ‚ç‚¹-kubectl-å’Œ-kubelet" class="headerlink" title="å‡çº§ infra å’Œ worker èŠ‚ç‚¹ kubectl å’Œ kubelet"></a>å‡çº§ infra å’Œ worker èŠ‚ç‚¹ kubectl å’Œ kubelet</h3><div class="hljs"><pre><code class="hljs bash">ansible infra:worker -m shell -a <span class="hljs-string">'apt-mark unhold kubelet kubectl &amp;&amp; apt-get update &amp;&amp; apt-get install -y kubelet=1.18.0-00 kubectl=1.18.0-00 &amp;&amp; apt-mark hold kubelet kubectl'</span></code></pre></div><h3 id="é‡å¯-infra-å’Œ-worker-èŠ‚ç‚¹-kubelet"><a href="#é‡å¯-infra-å’Œ-worker-èŠ‚ç‚¹-kubelet" class="headerlink" title="é‡å¯ infra å’Œ worker èŠ‚ç‚¹ kubelet"></a>é‡å¯ infra å’Œ worker èŠ‚ç‚¹ kubelet</h3><div class="hljs"><pre><code class="hljs bash">ansible infra:worker -m shell -a <span class="hljs-string">'systemctl restart kubelet'</span></code></pre></div><h3 id="æ£€æŸ¥-kubernetes-å‡çº§çŠ¶æ€"><a href="#æ£€æŸ¥-kubernetes-å‡çº§çŠ¶æ€" class="headerlink" title="æ£€æŸ¥ kubernetes å‡çº§çŠ¶æ€"></a>æ£€æŸ¥ kubernetes å‡çº§çŠ¶æ€</h3><div class="hljs"><pre><code class="hljs bash"> kubectl get nodes
NAME    STATUS   ROLES    AGE   VERSION
uki01   Ready    infra    8d    v1.18.0
uki02   Ready    infra    8d    v1.18.0
uki03   Ready    infra    8d    v1.18.0
ukm01   Ready    master   8d    v1.18.0
ukm02   Ready    master   8d    v1.18.0
ukm03   Ready    master   8d    v1.18.0
ukn01   Ready    worker   8d    v1.18.0
ukn02   Ready    worker   8d    v1.18.0
ukn03   Ready    worker   8d    v1.18.0</code></pre></div><h2 id="å®‰è£…-router"><a href="#å®‰è£…-router" class="headerlink" title="å®‰è£… router"></a><strong>å®‰è£… router</strong></h2><p>router æ˜¯ openshift å¼€æºçš„ ingress æœåŠ¡ï¼Œrouter æœåŠ¡é»˜è®¤å®‰è£…åœ¨ default namespace ä¸‹é¢ã€‚</p><h3 id="é…ç½®-rbac-æ–‡ä»¶"><a href="#é…ç½®-rbac-æ–‡ä»¶" class="headerlink" title="é…ç½® rbac æ–‡ä»¶"></a>é…ç½® rbac æ–‡ä»¶</h3><div class="hljs"><pre><code class="hljs bash"> cat &gt; router/rbac.yaml  &lt;&lt;EOF
---
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: ClusterRole
metadata:
  name: openshift-router
  namespace: default
rules:
- apiGroups: [<span class="hljs-string">""</span>]
  resources: [<span class="hljs-string">"namespaces"</span>, <span class="hljs-string">"services"</span>, <span class="hljs-string">"endpoints"</span>]
  verbs: [<span class="hljs-string">"get"</span>, <span class="hljs-string">"list"</span>, <span class="hljs-string">"watch"</span>]
- apiGroups: [<span class="hljs-string">"route.openshift.io"</span>]
  resources: [<span class="hljs-string">"routes"</span>]
  verbs: [<span class="hljs-string">"list"</span>, <span class="hljs-string">"watch"</span>]
- apiGroups: [<span class="hljs-string">"route.openshift.io"</span>]
  resources: [<span class="hljs-string">"routes/status"</span>]
  verbs: [<span class="hljs-string">"get"</span>, <span class="hljs-string">"patch"</span>, <span class="hljs-string">"update"</span>]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: openshift-router
roleRef:
  apiGroup: <span class="hljs-string">""</span>
  kind: ClusterRole
  name: openshift-router
subjects:
- kind: ServiceAccount
  namespace: default
  name: router

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: openshift-router-auth-delegator
roleRef:
  apiGroup: <span class="hljs-string">""</span>
  kind: ClusterRole
  name: system:auth-delegator
subjects:
- kind: ServiceAccount
  namespace: default
  name: router
EOF</code></pre></div><h3 id="é…ç½®-serviceaccount-æ–‡ä»¶"><a href="#é…ç½®-serviceaccount-æ–‡ä»¶" class="headerlink" title="é…ç½® serviceaccount æ–‡ä»¶"></a>é…ç½® serviceaccount æ–‡ä»¶</h3><div class="hljs"><pre><code class="hljs bash"> cat &gt; router/serviceaccount.yaml  &lt;&lt;EOF
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: router
  namespace: default
EOF</code></pre></div><h3 id="é…ç½®-crd-æ–‡ä»¶"><a href="#é…ç½®-crd-æ–‡ä»¶" class="headerlink" title="é…ç½® crd æ–‡ä»¶"></a>é…ç½® crd æ–‡ä»¶</h3><div class="hljs"><pre><code class="hljs bash"> cat &gt; router/crd.yaml  &lt;&lt;EOF
---
apiVersion: apiextensions.k8s.io/v1beta1
kind: CustomResourceDefinition
metadata:
   name must match the spec fields below, and be <span class="hljs-keyword">in</span> the form: &lt;plural&gt;.&lt;group&gt;
  name: routes.route.openshift.io
  namespace: default
spec:
   group name to use <span class="hljs-keyword">for</span> REST API: /apis/&lt;group&gt;/&lt;version&gt;
  group: route.openshift.io
   list of versions supported by this CustomResourceDefinition
  versions:
    - name: v1
       Each version can be enabled/disabled by Served flag.
      served: <span class="hljs-literal">true</span>
       One and only one version must be marked as the storage version.
      storage: <span class="hljs-literal">true</span>
   either Namespaced or Cluster
  scope: Namespaced
  subresources:
     <span class="hljs-built_in">enable</span> spec/status
    status: &#123;&#125;
  names:
     plural name to be used <span class="hljs-keyword">in</span> the URL: /apis/&lt;group&gt;/&lt;version&gt;/&lt;plural&gt;
    plural: routes
     singular name to be used as an <span class="hljs-built_in">alias</span> on the CLI and <span class="hljs-keyword">for</span> display
    singular: route
     kind is normally the CamelCased singular <span class="hljs-built_in">type</span>. Your resource manifests use this.
    kind: Route
  additionalPrinterColumns:
  - name: Host
    <span class="hljs-built_in">type</span>: string
    JSONPath: .status.ingress[0].host
  - name: Admitted
    <span class="hljs-built_in">type</span>: string
    JSONPath: .status.ingress[0].conditions[?(@.<span class="hljs-built_in">type</span>==<span class="hljs-string">"Admitted"</span>)].status
  - name: Service
    <span class="hljs-built_in">type</span>: string
    JSONPath: .spec.to.name
  - name: TLS
    <span class="hljs-built_in">type</span>: string
    JSONPath: .spec.tls.type
EOF</code></pre></div><h3 id="é…ç½®-router-å®‰è£…æ–‡ä»¶"><a href="#é…ç½®-router-å®‰è£…æ–‡ä»¶" class="headerlink" title="é…ç½® router å®‰è£…æ–‡ä»¶"></a>é…ç½® router å®‰è£…æ–‡ä»¶</h3><div class="hljs"><pre><code class="hljs bash"> cat &gt; router/deployment.yaml  &lt;&lt;EOF
---
apiVersion: apps/v1
kind: DaemonSet  Deployment DaemonSet
metadata:
  name: router
  namespace: default
  labels:
    k8s-app: router
spec:
  replicas: 3  å¦‚æœæ˜¯ DaemonSetï¼Œå¯ä»¥ä¸è®¾ç½®å‰¯æœ¬æ•°é‡ã€‚
  selector:
    matchLabels:
      k8s-app: router
  template:
    metadata:
      labels:
        k8s-app: router
    spec:
      serviceAccountName: router
      nodeSelector:
        node-role.kubernetes.io/infra: <span class="hljs-string">"true"</span>
      containers:
      - env:
        - name: ROUTER_LISTEN_ADDR
          value: 0.0.0.0:1936
        - name: ROUTER_METRICS_TYPE
          value: haproxy
        - name: ROUTER_SERVICE_HTTPS_PORT
          value: <span class="hljs-string">"443"</span>
        - name: ROUTER_SERVICE_HTTP_PORT
          value: <span class="hljs-string">"80"</span>
        - name: ROUTER_THREADS
          value: <span class="hljs-string">"4"</span>
        image: openshift/origin-haproxy-router:v4.0.0
        imagePullPolicy: IfNotPresent
        livenessProbe:
          httpGet:
            host: localhost
            path: /healthz
            port: 1936
          initialDelaySeconds: 10
        name: router
        ports:
        - containerPort: 80
        - containerPort: 443
        - containerPort: 1936
          name: stats
          protocol: TCP
        readinessProbe:
          httpGet:
            host: localhost
            path: healthz/ready
            port: 1936
          initialDelaySeconds: 10
        resources:
          requests:
            cpu: 100m
            memory: 256Mi
      hostNetwork: <span class="hljs-literal">true</span>
EOF</code></pre></div><h3 id="å®‰è£…-router-æœåŠ¡"><a href="#å®‰è£…-router-æœåŠ¡" class="headerlink" title="å®‰è£… router æœåŠ¡"></a>å®‰è£… router æœåŠ¡</h3><div class="hljs"><pre><code class="hljs bash">kubectl apply -f router/serviceaccount.yaml

kubectl apply -f router/rbac.yaml

kubectl apply -f router/deployment.yaml

kubectl apply -f router/crd.yaml</code></pre></div><h3 id="æ£€æŸ¥ç«¯å£ç›‘å¬"><a href="#æ£€æŸ¥ç«¯å£ç›‘å¬" class="headerlink" title="æ£€æŸ¥ç«¯å£ç›‘å¬"></a>æ£€æŸ¥ç«¯å£ç›‘å¬</h3><p>load blance é…ç½® TCP 80/443/1936 ç«¯å£è½¬å‘åˆ° infra èŠ‚ç‚¹æœåŠ¡å™¨ã€‚</p><div class="hljs"><pre><code class="hljs bash">ansible infra -m shell -a <span class="hljs-string">'netstat -lntp|grep -E "80|443|1936"'</span></code></pre></div><h3 id="æ ¡éªŒ-route-æœåŠ¡"><a href="#æ ¡éªŒ-route-æœåŠ¡" class="headerlink" title="æ ¡éªŒ route æœåŠ¡"></a>æ ¡éªŒ route æœåŠ¡</h3><p>å®‰è£…nginx</p><div class="hljs"><pre><code class="hljs bash">kubectl create deployment nginx --image nginx:alpine
kubectl expose deployment nginx --port=80</code></pre></div><h3 id="åˆ›å»º-nginx-route"><a href="#åˆ›å»º-nginx-route" class="headerlink" title="åˆ›å»º nginx route"></a>åˆ›å»º nginx route</h3><div class="hljs"><pre><code class="hljs bash"> kubectl apply -f - &lt;&lt;EOF
---
apiVersion: route.openshift.io/v1
kind: Route
metadata:
  name: nginx
  labels:
    app: nginx
spec:
  host: test.mokr.cn
  to:
    kind: Service
    name: nginx
    weight: 100
  wildcardPolicy: None
EOF</code></pre></div><h3 id="è®¿é—®éªŒè¯"><a href="#è®¿é—®éªŒè¯" class="headerlink" title="è®¿é—®éªŒè¯"></a>è®¿é—®éªŒè¯</h3><div class="hljs"><pre><code class="hljs bash"> curl -ik http://test.mokr.cn --resolve <span class="hljs-string">'test.mokr.cn:80:10.10.34.89'</span>
HTTP/1.1 200 OK
Server: nginx/1.17.9
Date: Tue, 24 Mar 2020 07:01:43 GMT
Content-Type: text/html
Content-Length: 612
Last-Modified: Tue, 03 Mar 2020 17:36:53 GMT
ETag: <span class="hljs-string">"5e5e95b5-264"</span>
Accept-Ranges: bytes
Set-Cookie: 3bc5f7a8aec67b74b33e81d956f57cb9=5ffd533ac952a924e0ec8b6f1c601703; path=/; HttpOnly
Cache-control: private

&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
&lt;title&gt;Welcome to nginx!&lt;/title&gt;
&lt;style&gt;
    body &#123;
        width: 35em;
        margin: 0 auto;
        font-family: Tahoma, Verdana, Arial, sans-serif;
    &#125;
&lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;
&lt;p&gt;If you see this page, the nginx web server is successfully installed and
working. Further configuration is required.&lt;/p&gt;

&lt;p&gt;For online documentation and support please refer to
&lt;a href=<span class="hljs-string">"http://nginx.org/"</span>&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;
Commercial support is available at
&lt;a href=<span class="hljs-string">"http://nginx.com/"</span>&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;em&gt;Thank you <span class="hljs-keyword">for</span> using nginx.&lt;/em&gt;&lt;/p&gt;
&lt;/body&gt;
&lt;/html&gt;

 æˆ–è€…
 curl -ik http://10.10.34.89 -H <span class="hljs-string">'Host: test.mokr.cn'</span> -v</code></pre></div><h3 id="åˆ é™¤-router"><a href="#åˆ é™¤-router" class="headerlink" title="åˆ é™¤ router"></a>åˆ é™¤ router</h3><div class="hljs"><pre><code class="hljs bash">kubectl delete -f router.yaml</code></pre></div><h2 id="å®‰è£…-kubernetes-dashboard-2-0"><a href="#å®‰è£…-kubernetes-dashboard-2-0" class="headerlink" title="å®‰è£… kubernetes dashboard 2.0"></a><strong>å®‰è£… kubernetes dashboard 2.0</strong></h2><div class="hljs"><pre><code class="hljs bash">curl -L https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.0-beta4/aio/deploy/recommended.yaml -o kubernetes-dashboard.yaml</code></pre></div><h3 id="ç­¾å‘-https-è®¿é—®è¯ä¹¦"><a href="#ç­¾å‘-https-è®¿é—®è¯ä¹¦" class="headerlink" title="ç­¾å‘ https è®¿é—®è¯ä¹¦"></a>ç­¾å‘ https è®¿é—®è¯ä¹¦</h3><ul><li>Canâ€™t load /root/.rnd into RNG</li></ul><div class="hljs"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> /root
openssl rand -writerand .rnd</code></pre></div><h3 id="dashboard-å¤šåŸŸåé…ç½®"><a href="#dashboard-å¤šåŸŸåé…ç½®" class="headerlink" title="dashboard å¤šåŸŸåé…ç½®"></a>dashboard å¤šåŸŸåé…ç½®</h3><div class="hljs"><pre><code class="hljs bash"> mkdir -p /certs

 cp /etc/ssl/openssl.cnf /certs
 vim /certs/openssl.cnf
...
[ req_distinguished_name ]
countryName                     = Country Name (2 letter code)
countryName_default             = CN
countryName_min                 = 2
countryName_max                 = 2
stateOrProvinceName             = State or Province Name (full name)
stateOrProvinceName_default     = GuangDong
localityName                    = Locality Name (eg, city)
localityName_default            = ShenZhen
0.organizationName              = Organization Name (eg, company)
0.organizationName_default      = MOKR Ltd
organizationalUnitName          = Organizational Unit Name (eg, section)
organizationalUnitName_default  = OPS
commonName                      = Common Name (e.g. server FQDN or YOUR name)
commonName_max                  = 64
emailAddress                    = Email Address
emailAddress_max                = 64
emailAddress_default            = seanzhau@gmail.com

[ v3_req ]
basicConstraints = CA:FALSE
keyUsage = nonRepudiation, digitalSignature, keyEncipherment
subjectAltName = @alt_names

[alt_names]
DNS.1 = dashboard.mokr.cn
DNS.2 = kubernetes-dashboard.kubernetes-dashboard.svc
DNS.3 = kubernetes-dashboard.kubernetes-dashboard.svc.cluster.local
IP.1 = 10.104.71.164
IP.2 = 10.10.34.89
...</code></pre></div><h3 id="ç­¾å‘-dashboard-å¯†é’¥"><a href="#ç­¾å‘-dashboard-å¯†é’¥" class="headerlink" title="ç­¾å‘ dashboard å¯†é’¥"></a>ç­¾å‘ dashboard å¯†é’¥</h3><div class="hljs"><pre><code class="hljs bash">openssl req -nodes -newkey rsa:2048 \
 -keyout /certs/dashboard.key \
 -out /certs/dashboard.csr \
 -subj <span class="hljs-string">"/C=CN/ST=GuangDong/L=ShenZhen/O=Mokr LTD/OU=OPS"</span> \
 -config /certs/openssl.cnf \
 -extensions v3_req</code></pre></div><h3 id="ç­¾å‘-dashboard-è¯ä¹¦"><a href="#ç­¾å‘-dashboard-è¯ä¹¦" class="headerlink" title="ç­¾å‘ dashboard è¯ä¹¦"></a>ç­¾å‘ dashboard è¯ä¹¦</h3><div class="hljs"><pre><code class="hljs bash">ç§é’¥ç­¾å‘
openssl x509 -req -sha256 -days 365 \
 -<span class="hljs-keyword">in</span> /certs/dashboard.csr \
 -signkey /certs/dashboard.key \
 -out /certs/dashboard.crt \
 -extfile /certs/openssl.cnf \
 -extensions v3_req

ca ç­¾å‘
openssl x509 -req -days 365 \
 -<span class="hljs-keyword">in</span> /certs/dashboard.csr \
 -CA /etc/kubernetes/pki/ca.crt \
 -CAkey /etc/kubernetes/pki/ca.key \
 -CAcreateserial \
 -out /certs/dashboard.crt \
 -extfile /certs/openssl.cnf \
 -extensions v3_req</code></pre></div><h3 id="éªŒè¯-dashboard-è¯ä¹¦"><a href="#éªŒè¯-dashboard-è¯ä¹¦" class="headerlink" title="éªŒè¯ dashboard è¯ä¹¦"></a>éªŒè¯ dashboard è¯ä¹¦</h3><div class="hljs"><pre><code class="hljs bash"> openssl x509 -text -noout -<span class="hljs-keyword">in</span> /certs/dashboard.crt
Certificate:
...
        X509v3 extensions:
            X509v3 Basic Constraints:
                CA:FALSE
            X509v3 Key Usage:
                Digital Signature, Non Repudiation, Key Encipherment
            X509v3 Subject Alternative Name:
                DNS:dashboard.mokr.cn, DNS:kubernetes-dashboard.kubernetes-dashboard.svc, DNS:kubernetes-dashboard.kubernetes-dashboard.svc.cluster.local, IP Address:10.104.71.164, IP Address:10.10.34.89
...</code></pre></div><h3 id="éƒ¨ç½²-dashboard"><a href="#éƒ¨ç½²-dashboard" class="headerlink" title="éƒ¨ç½² dashboard"></a>éƒ¨ç½² dashboard</h3><div class="hljs"><pre><code class="hljs bash">kubectl apply -f kubernetes-dashboard.yaml</code></pre></div><h3 id="ä¸º-dashboard-é…ç½®-secret-è¯ä¹¦"><a href="#ä¸º-dashboard-é…ç½®-secret-è¯ä¹¦" class="headerlink" title="ä¸º dashboard é…ç½® secret è¯ä¹¦"></a>ä¸º dashboard é…ç½® secret è¯ä¹¦</h3><div class="hljs"><pre><code class="hljs bash">kubectl create secret generic kubernetes-dashboard-certs --from-file=/certs/dashboard -n kubernetes-dashboard

å¯ä¸é…ç½®
kubectl create secret tls kubernetes-dashboard-tls --cert=/certs/dashboard/dashboard.crt --key=/certs/dashboard/dashboard.key -n kubernetes-dashboard</code></pre></div><h3 id="æ ¡éªŒ-dashboard"><a href="#æ ¡éªŒ-dashboard" class="headerlink" title="æ ¡éªŒ dashboard"></a>æ ¡éªŒ dashboard</h3><div class="hljs"><pre><code class="hljs bash"> kubectl get pods,svc -n kubernetes-dashboard
NAME                                             READY   STATUS    RESTARTS   AGE
pod/dashboard-metrics-scraper-566cddb686-m5dzb   1/1     Running   0          22h
pod/kubernetes-dashboard-7b5bf5d559-dbrh2        1/1     Running   0          22h

NAME                                TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE
service/dashboard-metrics-scraper   ClusterIP   10.107.240.229   &lt;none&gt;        8000/TCP   22h
service/kubernetes-dashboard        ClusterIP   10.96.188.203    &lt;none&gt;        443/TCP    22h</code></pre></div><h3 id="åˆ›å»º-dashboard-route"><a href="#åˆ›å»º-dashboard-route" class="headerlink" title="åˆ›å»º dashboard route"></a>åˆ›å»º dashboard route</h3><div class="hljs"><pre><code class="hljs bash"> kubectl apply -f -  &lt;&lt;EOF
---
apiVersion: route.openshift.io/v1
kind: Route
metadata:
  name: kubernetes-dashboard
  labels:
    app: kubernetes-dashboard
  namespace: kubernetes-dashboard
spec:
  host: dashboard.mokr.cn
  tls:
    insecureEdgeTerminationPolicy: Redirect <span class="hljs-comment">## None Allow Redirect</span>
    termination: reencrypt <span class="hljs-comment">## edge passthrough reencrypt</span>
  to:
    kind: Service
    name: kubernetes-dashboard
    weight: 100
  wildcardPolicy: None
EOF</code></pre></div><h3 id="curl-è®¿é—®-dashboard"><a href="#curl-è®¿é—®-dashboard" class="headerlink" title="curl è®¿é—® dashboard"></a>curl è®¿é—® dashboard</h3><div class="hljs"><pre><code class="hljs bash">curl -ik https://dashboard.mokr.cn --resolve <span class="hljs-string">'dashboard.mokr.cn:443:10.10.34.89'</span></code></pre></div><h3 id="æˆ–è€…"><a href="#æˆ–è€…" class="headerlink" title="æˆ–è€…"></a>æˆ–è€…</h3><div class="hljs"><pre><code class="hljs bash">curl -ik https://10.10.34.89 -H <span class="hljs-string">'Host: dashboard.mokr.cn'</span></code></pre></div><h3 id="åˆ›å»º-dashboard-ç”¨æˆ·"><a href="#åˆ›å»º-dashboard-ç”¨æˆ·" class="headerlink" title="åˆ›å»º dashboard ç”¨æˆ·"></a>åˆ›å»º dashboard ç”¨æˆ·</h3><div class="hljs"><pre><code class="hljs bash"> åˆ›å»ºç”¨æˆ·
 kubectl create serviceaccount seanzhau -n kubernetes-dashboard

 æ·»åŠ ç”¨æˆ·æˆæƒï¼Œé…ç½®é›†ç¾¤ admin æƒé™
<span class="hljs-comment">## ex: kubectl create clusterrolebinding cluster-admin --clusterrole=cluster-admin --user=user1 --user=user2 --group=group1</span>
 kubectl create clusterrolebinding dashboard-admin --clusterrole cluster-admin --serviceaccount kubernetes-dashboard:seanzhau

 æˆ–è€…
 kubectl apply -f - &lt;&lt;EOF
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: seanzhau
  namespace: kubernetes-dashboard
  labels:
    kubernetes.io/cluster-service: <span class="hljs-string">"true"</span>
    addonmanager.kubernetes.io/mode: Reconcile

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: dashboard-admin
  namespace: kubernetes-dashboard
  annotations:
    rbac.authorization.kubernetes.io/autoupdate: <span class="hljs-string">"true"</span>
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin
subjects:
- kind: ServiceAccount
  name: seanzhau
  namespace: kubernetes-dashboard
EOF</code></pre></div><h3 id="æŸ¥çœ‹-secret-ä¿¡æ¯"><a href="#æŸ¥çœ‹-secret-ä¿¡æ¯" class="headerlink" title="æŸ¥çœ‹ secret ä¿¡æ¯"></a>æŸ¥çœ‹ secret ä¿¡æ¯</h3><div class="hljs"><pre><code class="hljs bash">æŸ¥çœ‹ secret ç§é’¥æˆ–è€… ca ä¿¡æ¯
kubectl -n kubernetes-dashboard get secret -o jsonpath=<span class="hljs-string">'&#123;range .items[?(@.metadata.annotations.kubernetes\.io/service-account\.name=="seanzhau")].data&#125;&#123;.ca\.crt&#125;&#123;end&#125;'</span> | base64 -d

æŸ¥çœ‹ç”¨æˆ· token
kubectl -n kubernetes-dashboard get secret -o jsonpath=<span class="hljs-string">'&#123;range .items[?(@.metadata.annotations.kubernetes\.io/service-account\.name=="seanzhau")].data&#125;&#123;.token&#125;&#123;end&#125;'</span> | base64 -d</code></pre></div><h3 id="æµè§ˆå™¨è®¿é—®"><a href="#æµè§ˆå™¨è®¿é—®" class="headerlink" title="æµè§ˆå™¨è®¿é—®"></a>æµè§ˆå™¨è®¿é—®</h3><p>æµè§ˆå™¨æ‰“å¼€ <code>https://dashboard.mokr.cn</code> ï¼Œé€‰æ‹© Token ï¼Œè¾“å…¥è·å–çš„ç”¨æˆ· tokenã€‚</p><h3 id="ä½¿ç”¨-kubeconfig-ç™»å½•"><a href="#ä½¿ç”¨-kubeconfig-ç™»å½•" class="headerlink" title="ä½¿ç”¨ kubeconfig ç™»å½•"></a>ä½¿ç”¨ kubeconfig ç™»å½•</h3><p>ä¸‹è½½ /etc/kubernetes/admin.conf åˆ°æœ¬åœ°ï¼Œä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œåœ¨æœ€åº•éƒ¨æ·»åŠ  token å­—æ®µã€‚</p><div class="hljs"><pre><code class="hljs bash"> vim admin.conf
...
users:
- name: kubernetes-admin
  user:
    client-certificate-data: xxxxxxxxxxxxxxxxxxxxx
    client-key-data: xxxxxxxxxxxxxxxxxxxxx
    token: xxxxxxxxxxxxxxxxxxxxx</code></pre></div><h2 id="å®‰è£…-ceph-å­˜å‚¨"><a href="#å®‰è£…-ceph-å­˜å‚¨" class="headerlink" title="å®‰è£… ceph å­˜å‚¨"></a><strong>å®‰è£… ceph å­˜å‚¨</strong></h2><h3 id="ceph-ansible-å®‰è£…"><a href="#ceph-ansible-å®‰è£…" class="headerlink" title="ceph ansible å®‰è£…"></a>ceph ansible å®‰è£…</h3><div class="hljs"><pre><code class="hljs bash">git <span class="hljs-built_in">clone</span> -b stable-5.0 https://github.com/ceph/ceph-ansible.git
<span class="hljs-built_in">cd</span> ceph-ansible</code></pre></div><h3 id="å®‰è£…-pip"><a href="#å®‰è£…-pip" class="headerlink" title="å®‰è£… pip"></a>å®‰è£… pip</h3><div class="hljs"><pre><code class="hljs bash">apt install -y python-pip</code></pre></div><h3 id="é…ç½®-pip-æº"><a href="#é…ç½®-pip-æº" class="headerlink" title="é…ç½® pip æº"></a>é…ç½® pip æº</h3><div class="hljs"><pre><code class="hljs bash"> mkdir -p ~/.pip
 cat &gt; ~/.pip/pip.conf &lt;&lt;EOF
[global]
index-url = https://mirrors.aliyun.com/pypi/simple/

[install]
trusted-host=mirrors.aliyun.com
EOF</code></pre></div><h3 id="å®‰è£…-ansible-ä»¥åŠä¾èµ–"><a href="#å®‰è£…-ansible-ä»¥åŠä¾èµ–" class="headerlink" title="å®‰è£… ansible ä»¥åŠä¾èµ–"></a>å®‰è£… ansible ä»¥åŠä¾èµ–</h3><div class="hljs"><pre><code class="hljs bash">pip install -r requirements.txt</code></pre></div><h3 id="é…ç½®-ansible-èµ„äº§æ–‡ä»¶"><a href="#é…ç½®-ansible-èµ„äº§æ–‡ä»¶" class="headerlink" title="é…ç½® ansible èµ„äº§æ–‡ä»¶"></a>é…ç½® ansible èµ„äº§æ–‡ä»¶</h3><div class="hljs"><pre><code class="hljs bash"> cat  &gt; dummy-ansible-hosts &lt;&lt;EOF
[mons]
10.10.34.29
10.10.34.31
10.10.34.42

[osds]
10.10.34.29
10.10.34.31
10.10.34.42

[mdss]
10.10.34.29
10.10.34.31
10.10.34.42

[rgws]
10.10.34.29
10.10.34.31
10.10.34.42

[mgrs]
10.10.34.29
10.10.34.31
10.10.34.42

[grafana-server]
10.10.34.29

[clients]
10.10.34.29
10.10.34.31
10.10.34.42
EOF</code></pre></div><h3 id="é…ç½®-ceph-å®‰è£…æ–‡ä»¶"><a href="#é…ç½®-ceph-å®‰è£…æ–‡ä»¶" class="headerlink" title="é…ç½® ceph å®‰è£…æ–‡ä»¶"></a>é…ç½® ceph å®‰è£…æ–‡ä»¶</h3><div class="hljs"><pre><code class="hljs bash"> docker å®‰è£…
 cp site-container.yml.sample site-container.yml

 äºŒè¿›åˆ¶æ–‡ä»¶å®‰è£…
 cp site.yml.sample site.yml

 cat &gt; group_vars/all.yml &lt;&lt;EOF
---
cluster: ceph
generate_fsid: <span class="hljs-literal">true</span>
journal_size: 512
ceph_origin: repository
ceph_repository: community

 docker å®‰è£…
ceph_docker_image: <span class="hljs-string">"ceph/daemon"</span>
ceph_docker_image_tag: latest-octopus
containerized_deployment: <span class="hljs-literal">true</span>
ceph_docker_registry: docker.io
ceph_stable_repo: <span class="hljs-string">"&#123;&#123; ceph_mirror &#125;&#125;/debian-&#123;&#123; ceph_stable_release &#125;&#125;"</span>

 äºŒè¿›åˆ¶å®‰è£…
ceph_mirror: http://mirrors.aliyun.com/ceph
ceph_stable_key: http://mirrors.aliyun.com/ceph/keys/release.asc
ceph_stable_release: octopus

public_network: <span class="hljs-string">"10.10.34.0/24"</span>
cluster_network: <span class="hljs-string">"10.10.34.0/24"</span>
monitor_interface: eth0
osd_objectstore: bluestore
dmcrypt: <span class="hljs-literal">false</span>
devices:
  - /dev/vdb
  - /dev/vdc
radosgw_interface: eth0
radosgw_address: 0.0.0.0
radosgw_address_block: <span class="hljs-string">"10.10.34.0/24"</span>
grafana_admin_user: seanzhau
grafana_admin_password: iPaaS2020
dashboard_enabled: True
dashboard_admin_user: seanzhau
dashboard_admin_password: iPaaS2020
EOF</code></pre></div><h3 id="å®‰è£…-ceph-é›†ç¾¤"><a href="#å®‰è£…-ceph-é›†ç¾¤" class="headerlink" title="å®‰è£… ceph é›†ç¾¤"></a>å®‰è£… ceph é›†ç¾¤</h3><div class="hljs"><pre><code class="hljs bash">docker å®‰è£…
ansible-playbook -i dummy-ansible-hosts site-container.yml

äºŒè¿›åˆ¶æ–‡ä»¶å®‰è£…
ansible-playbook -i dummy-ansible-hosts site.yml</code></pre></div><h3 id="éé›†ç¾¤èŠ‚ç‚¹å®‰è£…-ceph-å®¢æˆ·ç«¯"><a href="#éé›†ç¾¤èŠ‚ç‚¹å®‰è£…-ceph-å®¢æˆ·ç«¯" class="headerlink" title="éé›†ç¾¤èŠ‚ç‚¹å®‰è£… ceph å®¢æˆ·ç«¯"></a>éé›†ç¾¤èŠ‚ç‚¹å®‰è£… ceph å®¢æˆ·ç«¯</h3><div class="hljs"><pre><code class="hljs bash">apt install -y ceph-common</code></pre></div><h3 id="é…ç½®å®¢æˆ·ç«¯"><a href="#é…ç½®å®¢æˆ·ç«¯" class="headerlink" title="é…ç½®å®¢æˆ·ç«¯"></a>é…ç½®å®¢æˆ·ç«¯</h3><div class="hljs"><pre><code class="hljs bash"> é…ç½® ceph.conf
 cat &gt; /etc/ceph/ceph.conf &lt;&lt;EOF
[global]
mon host = 10.10.34.29,10.10.34.31,10.10.34.42
EOF

 ä» ceph é›†ç¾¤å¤åˆ¶ admin key
 scp 10.10.34.29:/etc/ceph/ceph.client.admin.keyring /etc/ceph/ceph.client.admin.keyring</code></pre></div><h3 id="æŸ¥çœ‹é›†ç¾¤çŠ¶æ€"><a href="#æŸ¥çœ‹é›†ç¾¤çŠ¶æ€" class="headerlink" title="æŸ¥çœ‹é›†ç¾¤çŠ¶æ€"></a>æŸ¥çœ‹é›†ç¾¤çŠ¶æ€</h3><div class="hljs"><pre><code class="hljs bash">ceph -s
 cluster:
   id:     5ae77bc9-1831-42df-8ef2-956499ce685b
   health: HEALTH_WARN
           1 pools have too few placement groups

 services:
   mon: 3 daemons, quorum ceph01,ceph02,ceph03 (age 15m)
   mgr: ceph01(active, since 14m), standbys: ceph02, ceph03
   mds: cephfs:1 &#123;0=ceph01=up:active&#125; 2 up:standby
   osd: 6 osds: 6 up (since 19m), 6 <span class="hljs-keyword">in</span> (since 19m)
   rgw: 3 daemons active (ceph01.rgw0, ceph02.rgw0, ceph03.rgw0)

 task status:
   scrub status:
       mds.ceph01: idle

 data:
   pools:   7 pools, 121 pgs
   objects: 215 objects, 11 KiB
   usage:   6.1 GiB used, 2.9 TiB / 2.9 TiB avail
   pgs:     121 active+clean</code></pre></div><h3 id="æŸ¥çœ‹ç£ç›˜çŠ¶æ€"><a href="#æŸ¥çœ‹ç£ç›˜çŠ¶æ€" class="headerlink" title="æŸ¥çœ‹ç£ç›˜çŠ¶æ€"></a>æŸ¥çœ‹ç£ç›˜çŠ¶æ€</h3><div class="hljs"><pre><code class="hljs bash"> ceph osd tree
ID  CLASS  WEIGHT   TYPE NAME                STATUS  REWEIGHT  PRI-AFF
-1         2.92978  root default
-3         0.97659      host ceph01
 0    hdd  0.48830          osd.0                up   1.00000  1.00000
 3    hdd  0.48830          osd.3                up   1.00000  1.00000
-7         0.97659      host ceph02
 2    hdd  0.48830          osd.2                up   1.00000  1.00000
 5    hdd  0.48830          osd.5                up   1.00000  1.00000
-5         0.97659      host ceph03
 1    hdd  0.48830          osd.1                up   1.00000  1.00000
 4    hdd  0.48830          osd.4                up   1.00000  1.00000</code></pre></div><h3 id="æŒ‚è½½-ceph"><a href="#æŒ‚è½½-ceph" class="headerlink" title="æŒ‚è½½ ceph"></a>æŒ‚è½½ ceph</h3><div class="hljs"><pre><code class="hljs bash"> mount.ceph 10.10.34.29,10.10.34.31,10.10.34.42:/ /mnt/ -o name=admin,secret=admin-password   secretfile=/root/admin.secret

 df -h /mnt/
Filesystem                             Size  Used Avail Use% Mounted on
10.10.34.29,10.10.34.31,10.10.34.42:/  948G     0  948G   0% /mnt</code></pre></div><h3 id="åˆ é™¤é›†ç¾¤"><a href="#åˆ é™¤é›†ç¾¤" class="headerlink" title="åˆ é™¤é›†ç¾¤"></a>åˆ é™¤é›†ç¾¤</h3><div class="hljs"><pre><code class="hljs bash">docker å¸è½½
ansible-playbook -i dummy-ansible-hosts infrastructure-playbooks/purge-container-cluster.yml

äºŒè¿›åˆ¶æ–‡ä»¶å¸è½½
ansible-playbook -i dummy-ansible-hosts infrastructure-playbooks/purge-cluster.yml</code></pre></div><h3 id="åˆ é™¤ç£ç›˜åˆ†åŒºä¿¡æ¯"><a href="#åˆ é™¤ç£ç›˜åˆ†åŒºä¿¡æ¯" class="headerlink" title="åˆ é™¤ç£ç›˜åˆ†åŒºä¿¡æ¯"></a>åˆ é™¤ç£ç›˜åˆ†åŒºä¿¡æ¯</h3><p>RuntimeError: Unable to use device, already a member of LVM: /dev/vdb</p><div class="hljs"><pre><code class="hljs bash">ansible -i dummy-ansible-hosts osds -m shell -a <span class="hljs-string">'wipefs -a /dev/vdb --force'</span></code></pre></div><h2 id="é…ç½®-provisioner"><a href="#é…ç½®-provisioner" class="headerlink" title="é…ç½® provisioner"></a><strong>é…ç½® provisioner</strong></h2><h3 id="ä¸‹è½½-ceph-images"><a href="#ä¸‹è½½-ceph-images" class="headerlink" title="ä¸‹è½½ ceph images"></a>ä¸‹è½½ ceph images</h3><div class="hljs"><pre><code class="hljs bash">docker pull quay.io/external_storage/rbd-provisioner:latest
docker pull quay.io/external_storage/cephfs-provisioner:latest</code></pre></div><h3 id="åˆ›å»º-ceph-namespace"><a href="#åˆ›å»º-ceph-namespace" class="headerlink" title="åˆ›å»º ceph namespace"></a>åˆ›å»º ceph namespace</h3><div class="hljs"><pre><code class="hljs bash">kubectl create namespace ceph</code></pre></div><h3 id="å®‰è£…-cephfs"><a href="#å®‰è£…-cephfs" class="headerlink" title="å®‰è£… cephfs"></a>å®‰è£… cephfs</h3><h4 id="ç”Ÿæˆ-cephfs-admin-å¯†ç "><a href="#ç”Ÿæˆ-cephfs-admin-å¯†ç " class="headerlink" title="ç”Ÿæˆ cephfs admin å¯†ç "></a>ç”Ÿæˆ cephfs admin å¯†ç </h4><div class="hljs"><pre><code class="hljs bash">ceph auth get-key client.admin &gt; /tmp/key</code></pre></div><h4 id="åˆ›å»º-cephfs-secret"><a href="#åˆ›å»º-cephfs-secret" class="headerlink" title="åˆ›å»º cephfs secret"></a>åˆ›å»º cephfs secret</h4><div class="hljs"><pre><code class="hljs bash">kubectl create secret generic cephfs-secret-admin --from-file=/tmp/key --namespace=ceph --<span class="hljs-built_in">type</span>=kubernetes.io/cephfs</code></pre></div><h4 id="åˆ›å»º-cephfs-å®‰è£…æ–‡ä»¶"><a href="#åˆ›å»º-cephfs-å®‰è£…æ–‡ä»¶" class="headerlink" title="åˆ›å»º cephfs å®‰è£…æ–‡ä»¶"></a>åˆ›å»º cephfs å®‰è£…æ–‡ä»¶</h4><div class="hljs"><pre><code class="hljs bash">mkdir -p storageClass/cephfs</code></pre></div><h3 id="é‡æ–°æ„å»º-image"><a href="#é‡æ–°æ„å»º-image" class="headerlink" title="é‡æ–°æ„å»º image"></a>é‡æ–°æ„å»º image</h3><p>å¦‚æœæœ‰æƒé™é—®é¢˜ï¼Œå¯ä»¥æŒ‰æ“ä½œé‡æ–°åˆ¶é€  imageã€‚</p><div class="hljs"><pre><code class="hljs bash"> cat &gt; storageClass/cephfs/Dockerfile &lt;&lt;EOF
FROM quay.io/external_storage/cephfs-provisioner:latest

USER root

RUN sed -i <span class="hljs-string">'s|0o755|0o777|g'</span> /usr/lib/python2.7/site-packages/ceph_volume_client.py
EOF

 docker build -t quay.io/external_storage/cephfs-provisioner:new storageClass/cephfs/</code></pre></div><h4 id="åˆ›å»º-cephfs-deployment-å®‰è£…æ–‡ä»¶"><a href="#åˆ›å»º-cephfs-deployment-å®‰è£…æ–‡ä»¶" class="headerlink" title="åˆ›å»º cephfs deployment å®‰è£…æ–‡ä»¶"></a>åˆ›å»º cephfs deployment å®‰è£…æ–‡ä»¶</h4><div class="hljs"><pre><code class="hljs bash"> cat &gt; storageClass/cephfs/deployment.yaml &lt;&lt;EOF
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: cephfs-provisioner
  namespace: ceph
spec:
  replicas: 1
  selector:
    matchLabels:
      app: cephfs-provisioner
  strategy:
    <span class="hljs-built_in">type</span>: Recreate
  template:
    metadata:
      labels:
        app: cephfs-provisioner
    spec:
      nodeSelector:
        node-role.kubernetes.io/infra: <span class="hljs-string">"true"</span>
      containers:
      - name: cephfs-provisioner
        image: <span class="hljs-string">"quay.io/external_storage/cephfs-provisioner:latest"</span>
        imagePullPolicy: IfNotPresent
        env:
        - name: PROVISIONER_NAME
          value: ceph.com/cephfs
        - name: PROVISIONER_SECRET_NAMESPACE
          value: ceph
        <span class="hljs-built_in">command</span>:
        - <span class="hljs-string">"/usr/local/bin/cephfs-provisioner"</span>
        args:
        - <span class="hljs-string">"-id=cephfs-provisioner-1"</span>
      serviceAccount: cephfs-provisioner
EOF</code></pre></div><h4 id="åˆ›å»º-cephfs-serviceaccount-å®‰è£…æ–‡ä»¶"><a href="#åˆ›å»º-cephfs-serviceaccount-å®‰è£…æ–‡ä»¶" class="headerlink" title="åˆ›å»º cephfs serviceaccount å®‰è£…æ–‡ä»¶"></a>åˆ›å»º cephfs serviceaccount å®‰è£…æ–‡ä»¶</h4><div class="hljs"><pre><code class="hljs bash"> cat &gt; storageClass/cephfs/serviceaccount.yaml &lt;&lt;EOF
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: cephfs-provisioner
  namespace: ceph
EOF</code></pre></div><h4 id="åˆ›å»º-cephfs-rbac-å®‰è£…æ–‡ä»¶"><a href="#åˆ›å»º-cephfs-rbac-å®‰è£…æ–‡ä»¶" class="headerlink" title="åˆ›å»º cephfs rbac å®‰è£…æ–‡ä»¶"></a>åˆ›å»º cephfs rbac å®‰è£…æ–‡ä»¶</h4><div class="hljs"><pre><code class="hljs bash"> cat &gt; storageClass/cephfs/rbac.yaml &lt;&lt;EOF
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: cephfs-provisioner
  namespace: ceph
rules:
  - apiGroups: [<span class="hljs-string">""</span>]
    resources: [<span class="hljs-string">"secrets"</span>]
    verbs: [<span class="hljs-string">"create"</span>, <span class="hljs-string">"get"</span>, <span class="hljs-string">"delete"</span>]
  - apiGroups: [<span class="hljs-string">""</span>]
    resources: [<span class="hljs-string">"endpoints"</span>]
    verbs: [<span class="hljs-string">"get"</span>, <span class="hljs-string">"list"</span>, <span class="hljs-string">"watch"</span>, <span class="hljs-string">"create"</span>, <span class="hljs-string">"update"</span>, <span class="hljs-string">"patch"</span>]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: cephfs-provisioner
  namespace: ceph
subjects:
- kind: ServiceAccount
  name: cephfs-provisioner
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: cephfs-provisioner

---
kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: cephfs-provisioner
  namespace: ceph
rules:
  - apiGroups: [<span class="hljs-string">""</span>]
    resources: [<span class="hljs-string">"persistentvolumes"</span>]
    verbs: [<span class="hljs-string">"get"</span>, <span class="hljs-string">"list"</span>, <span class="hljs-string">"watch"</span>, <span class="hljs-string">"create"</span>, <span class="hljs-string">"delete"</span>]
  - apiGroups: [<span class="hljs-string">""</span>]
    resources: [<span class="hljs-string">"persistentvolumeclaims"</span>]
    verbs: [<span class="hljs-string">"get"</span>, <span class="hljs-string">"list"</span>, <span class="hljs-string">"watch"</span>, <span class="hljs-string">"update"</span>]
  - apiGroups: [<span class="hljs-string">"storage.k8s.io"</span>]
    resources: [<span class="hljs-string">"storageclasses"</span>]
    verbs: [<span class="hljs-string">"get"</span>, <span class="hljs-string">"list"</span>, <span class="hljs-string">"watch"</span>]
  - apiGroups: [<span class="hljs-string">""</span>]
    resources: [<span class="hljs-string">"events"</span>]
    verbs: [<span class="hljs-string">"create"</span>, <span class="hljs-string">"update"</span>, <span class="hljs-string">"patch"</span>]
  - apiGroups: [<span class="hljs-string">""</span>]
    resources: [<span class="hljs-string">"services"</span>]
    resourceNames: [<span class="hljs-string">"kube-dns"</span>,<span class="hljs-string">"coredns"</span>]
    verbs: [<span class="hljs-string">"list"</span>, <span class="hljs-string">"get"</span>]
  - apiGroups: [<span class="hljs-string">""</span>]
    resources: [<span class="hljs-string">"endpoints"</span>]
    verbs: [<span class="hljs-string">"get"</span>, <span class="hljs-string">"list"</span>, <span class="hljs-string">"watch"</span>, <span class="hljs-string">"create"</span>, <span class="hljs-string">"update"</span>, <span class="hljs-string">"patch"</span>]

---
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: cephfs-provisioner
subjects:
  - kind: ServiceAccount
    name: cephfs-provisioner
    namespace: ceph
roleRef:
  kind: ClusterRole
  name: cephfs-provisioner
  apiGroup: rbac.authorization.k8s.io
EOF</code></pre></div><h4 id="åˆ›å»º-cephfs-storageclass-å®‰è£…æ–‡ä»¶"><a href="#åˆ›å»º-cephfs-storageclass-å®‰è£…æ–‡ä»¶" class="headerlink" title="åˆ›å»º cephfs storageclass å®‰è£…æ–‡ä»¶"></a>åˆ›å»º cephfs storageclass å®‰è£…æ–‡ä»¶</h4><div class="hljs"><pre><code class="hljs bash"> cat &gt; storageClass/cephfs/storageclass.yaml &lt;&lt;EOF
---
kind: StorageClass
apiVersion: storage.k8s.io/v1
metadata:
  name: cephfs-provisioner
provisioner: ceph.com/cephfs
parameters:
    monitors: <span class="hljs-string">"10.10.34.29:6789,10.10.34.31:6789,10.10.34.42:6789"</span>
    adminId: admin
    adminSecretName: cephfs-secret-admin
    adminSecretNamespace: ceph
    claimRoot: /storage
EOF</code></pre></div><h4 id="å®‰è£…-cephfs-provisioner"><a href="#å®‰è£…-cephfs-provisioner" class="headerlink" title="å®‰è£… cephfs provisioner"></a>å®‰è£… cephfs provisioner</h4><div class="hljs"><pre><code class="hljs bash">kubectl apply -f storageClass/cephfs/serviceaccount.yaml

kubectl apply -f storageClass/cephfs/rbac.yaml

kubectl apply -f storageClass/cephfs/deployment.yaml

kubectl apply -f storageClass/cephfs/storageclass.yaml</code></pre></div><h4 id="æŸ¥çœ‹-cephfs-provisioner"><a href="#æŸ¥çœ‹-cephfs-provisioner" class="headerlink" title="æŸ¥çœ‹ cephfs provisioner"></a>æŸ¥çœ‹ cephfs provisioner</h4><div class="hljs"><pre><code class="hljs bash"> kubectl get storageclasses cephfs-provisioner
NAME                 PROVISIONER       RECLAIMPOLICY   VOLUMEBINDINGMODE   ALLOWVOLUMEEXPANSION   AGE
cephfs-provisioner   ceph.com/cephfs   Delete          Immediate           <span class="hljs-literal">false</span>                  17s</code></pre></div><h4 id="åˆ›å»º-cephfs-PVC"><a href="#åˆ›å»º-cephfs-PVC" class="headerlink" title="åˆ›å»º cephfs PVC"></a>åˆ›å»º cephfs PVC</h4><div class="hljs"><pre><code class="hljs bash"> cat &gt; storageClass/cephfs/pvc.yaml &lt;&lt;EOF
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: cephfs-test
spec:
  storageClassName: cephfs-provisioner
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 5Gi
EOF

 kubectl apply -f storageClass/cephfs/pvc.yaml -n kube-system
 kubectl apply -f storageClass/cephfs/pvc.yaml -n ceph
 kubectl apply -f storageClass/cephfs/pvc.yaml -n default</code></pre></div><h4 id="éªŒè¯-cephfs-PVC"><a href="#éªŒè¯-cephfs-PVC" class="headerlink" title="éªŒè¯ cephfs PVC"></a>éªŒè¯ cephfs PVC</h4><div class="hljs"><pre><code class="hljs bash"> kubectl get pvc --all-namespaces
NAMESPACE     NAME          STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS         AGE
ceph          cephfs-test   Bound    pvc-ae5ff9f8-4032-4690-9104-eeb563d45a1e   5Gi        RWX            cephfs-provisioner   8s
default       cephfs-test   Bound    pvc-85d47294-50a0-4f6c-b9ca-7a676cf3c34e   5Gi        RWX            cephfs-provisioner   5s
kube-system   cephfs-test   Bound    pvc-759c1b48-df22-4b72-ab22-490a2f3ebd5c   5Gi        RWX            cephfs-provisioner   13s</code></pre></div><h3 id="åˆ›å»º-rbd"><a href="#åˆ›å»º-rbd" class="headerlink" title="åˆ›å»º rbd"></a>åˆ›å»º rbd</h3><h4 id="ç”Ÿæˆ-rbd-admin-å¯†ç "><a href="#ç”Ÿæˆ-rbd-admin-å¯†ç " class="headerlink" title="ç”Ÿæˆ rbd admin å¯†ç "></a>ç”Ÿæˆ rbd admin å¯†ç </h4><div class="hljs"><pre><code class="hljs bash">ceph auth get-key client.admin &gt; /tmp/key</code></pre></div><h4 id="åˆ›å»º-admin-secret"><a href="#åˆ›å»º-admin-secret" class="headerlink" title="åˆ›å»º admin secret"></a>åˆ›å»º admin secret</h4><div class="hljs"><pre><code class="hljs bash">kubectl create secret generic rbd-secret-admin  --from-file=/tmp/key --namespace=ceph --<span class="hljs-built_in">type</span>=kubernetes.io/rbd</code></pre></div><h4 id="åˆ›å»º-pool-secret"><a href="#åˆ›å»º-pool-secret" class="headerlink" title="åˆ›å»º pool secret"></a>åˆ›å»º pool secret</h4><div class="hljs"><pre><code class="hljs bash">ceph osd pool create kube 8 8

ceph auth add client.kube mon <span class="hljs-string">'allow r'</span> osd <span class="hljs-string">'allow rwx pool=kube'</span>

ceph auth get-key client.kube &gt; /tmp/key

kubectl create secret generic kube-secret --from-file=/tmp/key --namespace=ceph --<span class="hljs-built_in">type</span>=kubernetes.io/rbd</code></pre></div><h4 id="åˆ›å»º-rbd-ç›®å½•"><a href="#åˆ›å»º-rbd-ç›®å½•" class="headerlink" title="åˆ›å»º rbd ç›®å½•"></a>åˆ›å»º rbd ç›®å½•</h4><div class="hljs"><pre><code class="hljs bash">mkdir -p storageClass/rbd</code></pre></div><h4 id="åˆ›å»º-rbd-deployment-å®‰è£…æ–‡ä»¶"><a href="#åˆ›å»º-rbd-deployment-å®‰è£…æ–‡ä»¶" class="headerlink" title="åˆ›å»º rbd deployment å®‰è£…æ–‡ä»¶"></a>åˆ›å»º rbd deployment å®‰è£…æ–‡ä»¶</h4><div class="hljs"><pre><code class="hljs bash"> cat &gt; storageClass/rbd/deployment.yaml &lt;&lt;EOF
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: rbd-provisioner
  namespace: ceph
spec:
  replicas: 1
  selector:
    matchLabels:
      app: rbd-provisioner
  strategy:
    <span class="hljs-built_in">type</span>: Recreate
  template:
    metadata:
      labels:
        app: rbd-provisioner
    spec:
      nodeSelector:
        node-role.kubernetes.io/infra: <span class="hljs-string">"true"</span>
      containers:
      - name: rbd-provisioner
        image: <span class="hljs-string">"quay.io/external_storage/rbd-provisioner:latest"</span>
        imagePullPolicy: IfNotPresent
        env:
        - name: PROVISIONER_NAME
          value: ceph.com/rbd
      serviceAccount: rbd-provisioner
EOF</code></pre></div><h4 id="åˆ›å»º-rbd-serviceaccount-å®‰è£…æ–‡ä»¶"><a href="#åˆ›å»º-rbd-serviceaccount-å®‰è£…æ–‡ä»¶" class="headerlink" title="åˆ›å»º rbd serviceaccount å®‰è£…æ–‡ä»¶"></a>åˆ›å»º rbd serviceaccount å®‰è£…æ–‡ä»¶</h4><div class="hljs"><pre><code class="hljs bash"> cat &gt; storageClass/rbd/serviceaccount.yaml &lt;&lt;EOF
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: rbd-provisioner
  namespace: ceph
EOF</code></pre></div><h4 id="åˆ›å»º-rbd-rbac-å®‰è£…æ–‡ä»¶"><a href="#åˆ›å»º-rbd-rbac-å®‰è£…æ–‡ä»¶" class="headerlink" title="åˆ›å»º rbd rbac å®‰è£…æ–‡ä»¶"></a>åˆ›å»º rbd rbac å®‰è£…æ–‡ä»¶</h4><div class="hljs"><pre><code class="hljs bash"> cat &gt; storageClass/rbd/rbac.yaml &lt;&lt;EOF
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: rbd-provisioner
  namespace: ceph
rules:
- apiGroups: [<span class="hljs-string">""</span>]
  resources: [<span class="hljs-string">"secrets"</span>]
  verbs: [<span class="hljs-string">"get"</span>]
- apiGroups: [<span class="hljs-string">""</span>]
  resources: [<span class="hljs-string">"endpoints"</span>]
  verbs: [<span class="hljs-string">"get"</span>, <span class="hljs-string">"list"</span>, <span class="hljs-string">"watch"</span>, <span class="hljs-string">"create"</span>, <span class="hljs-string">"update"</span>, <span class="hljs-string">"patch"</span>]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: rbd-provisioner
  namespace: ceph
subjects:
- kind: ServiceAccount
  name: rbd-provisioner
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: rbd-provisioner

---
kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: rbd-provisioner
  namespace: ceph
rules:
  - apiGroups: [<span class="hljs-string">""</span>]
    resources: [<span class="hljs-string">"persistentvolumes"</span>]
    verbs: [<span class="hljs-string">"get"</span>, <span class="hljs-string">"list"</span>, <span class="hljs-string">"watch"</span>, <span class="hljs-string">"create"</span>, <span class="hljs-string">"delete"</span>]
  - apiGroups: [<span class="hljs-string">""</span>]
    resources: [<span class="hljs-string">"persistentvolumeclaims"</span>]
    verbs: [<span class="hljs-string">"get"</span>, <span class="hljs-string">"list"</span>, <span class="hljs-string">"watch"</span>, <span class="hljs-string">"update"</span>]
  - apiGroups: [<span class="hljs-string">"storage.k8s.io"</span>]
    resources: [<span class="hljs-string">"storageclasses"</span>]
    verbs: [<span class="hljs-string">"get"</span>, <span class="hljs-string">"list"</span>, <span class="hljs-string">"watch"</span>]
  - apiGroups: [<span class="hljs-string">""</span>]
    resources: [<span class="hljs-string">"events"</span>]
    verbs: [<span class="hljs-string">"create"</span>, <span class="hljs-string">"update"</span>, <span class="hljs-string">"patch"</span>]
  - apiGroups: [<span class="hljs-string">""</span>]
    resources: [<span class="hljs-string">"services"</span>]
    resourceNames: [<span class="hljs-string">"kube-dns"</span>,<span class="hljs-string">"coredns"</span>]
    verbs: [<span class="hljs-string">"list"</span>, <span class="hljs-string">"get"</span>]
  - apiGroups: [<span class="hljs-string">""</span>]
    resources: [<span class="hljs-string">"endpoints"</span>]
    verbs: [<span class="hljs-string">"get"</span>, <span class="hljs-string">"list"</span>, <span class="hljs-string">"watch"</span>, <span class="hljs-string">"create"</span>, <span class="hljs-string">"update"</span>, <span class="hljs-string">"patch"</span>]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: rbd-provisioner
subjects:
  - kind: ServiceAccount
    name: rbd-provisioner
    namespace: ceph
roleRef:
  kind: ClusterRole
  name: rbd-provisioner
  apiGroup: rbac.authorization.k8s.io
EOF</code></pre></div><h4 id="åˆ›å»º-rbd-storageclass-å®‰è£…æ–‡ä»¶"><a href="#åˆ›å»º-rbd-storageclass-å®‰è£…æ–‡ä»¶" class="headerlink" title="åˆ›å»º rbd storageclass å®‰è£…æ–‡ä»¶"></a>åˆ›å»º rbd storageclass å®‰è£…æ–‡ä»¶</h4><div class="hljs"><pre><code class="hljs bash"> cat &gt; storageClass/rbd/storageclass.yaml &lt;&lt;EOF
---
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: rbd-provisioner
provisioner: ceph.com/rbd
parameters:
  monitors: <span class="hljs-string">"10.10.34.29:6789,10.10.34.31:6789,10.10.34.42:6789"</span>
  pool: kube
  adminId: admin
  adminSecretNamespace: ceph
  adminSecretName: rbd-secret-admin
  userId: kube
  userSecretNamespace: ceph
  userSecretName: ceph-secret
  imageFormat: <span class="hljs-string">"2"</span>
  imageFeatures: layering
EOF</code></pre></div><h4 id="å®‰è£…-rbd-provisioner"><a href="#å®‰è£…-rbd-provisioner" class="headerlink" title="å®‰è£… rbd provisioner"></a>å®‰è£… rbd provisioner</h4><div class="hljs"><pre><code class="hljs bash">kubectl apply -f storageClass/rbd/serviceaccount.yaml

kubectl apply -f storageClass/rbd/rbac.yaml

kubectl apply -f storageClass/rbd/deployment.yaml

kubectl apply -f storageClass/rbd/storageclass.yaml</code></pre></div><h4 id="æŸ¥çœ‹-rbd-provisioner"><a href="#æŸ¥çœ‹-rbd-provisioner" class="headerlink" title="æŸ¥çœ‹ rbd provisioner"></a>æŸ¥çœ‹ rbd provisioner</h4><div class="hljs"><pre><code class="hljs bash"> kubectl get storageclasses rbd-provisioner
NAME              PROVISIONER    RECLAIMPOLICY   VOLUMEBINDINGMODE   ALLOWVOLUMEEXPANSION   AGE
rbd-provisioner   ceph.com/rbd   Delete          Immediate           <span class="hljs-literal">false</span>                  7s</code></pre></div><h4 id="åˆ›å»º-rbd-PVC"><a href="#åˆ›å»º-rbd-PVC" class="headerlink" title="åˆ›å»º rbd PVC"></a>åˆ›å»º rbd PVC</h4><div class="hljs"><pre><code class="hljs bash"> cat &gt; storageClass/rbd/pvc.yaml &lt;&lt;EOF
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: rbd-test
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: rbd-provisioner
  resources:
    requests:
      storage: 10Gi
EOF

 kubectl apply -f storageClass/rbd/pvc.yaml -n kube-system
 kubectl apply -f storageClass/rbd/pvc.yaml -n ceph
 kubectl apply -f storageClass/rbd/pvc.yaml -n default</code></pre></div><h4 id="éªŒè¯-rbd-PVC"><a href="#éªŒè¯-rbd-PVC" class="headerlink" title="éªŒè¯ rbd PVC"></a>éªŒè¯ rbd PVC</h4><div class="hljs"><pre><code class="hljs bash"> kubectl get pvc --all-namespaces
NAMESPACE     NAME          STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS         AGE
ceph          rbd-test      Bound    pvc-4d85ad48-b24c-43b6-a7c2-89aec9c661a7   10Gi       RWO            rbd-provisioner      19s
default       rbd-test      Bound    pvc-9d93ccbd-b6ed-42fe-8f57-78fbff88baeb   10Gi       RWO            rbd-provisioner      11s
kube-system   rbd-test      Bound    pvc-5887166f-d9b4-4d40-b419-2e37ac81901d   10Gi       RWO            rbd-provisioner      31s</code></pre></div><h3 id="å¯¹è±¡å­˜å‚¨"><a href="#å¯¹è±¡å­˜å‚¨" class="headerlink" title="å¯¹è±¡å­˜å‚¨"></a>å¯¹è±¡å­˜å‚¨</h3><h4 id="s3-å­˜å‚¨"><a href="#s3-å­˜å‚¨" class="headerlink" title="s3 å­˜å‚¨"></a>s3 å­˜å‚¨</h4><div class="hljs"><pre><code class="hljs bash"> é…ç½® ceph s3 è´¦å·ï¼Œä¿ç•™ access_key å’Œ secret_key
 radosgw-admin user create --uid=<span class="hljs-string">"testuser"</span> --display-name=<span class="hljs-string">"test user"</span>
&#123;
    <span class="hljs-string">"user_id"</span>: <span class="hljs-string">"testuser"</span>,
    <span class="hljs-string">"display_name"</span>: <span class="hljs-string">"test user"</span>,
    <span class="hljs-string">"email"</span>: <span class="hljs-string">""</span>,
    <span class="hljs-string">"suspended"</span>: 0,
    <span class="hljs-string">"max_buckets"</span>: 1000,
    <span class="hljs-string">"subusers"</span>: [],
    <span class="hljs-string">"keys"</span>: [
        &#123;
            <span class="hljs-string">"user"</span>: <span class="hljs-string">"testuser"</span>,
            <span class="hljs-string">"access_key"</span>: <span class="hljs-string">"60DD3SXN58LIRC06ILQE"</span>,
            <span class="hljs-string">"secret_key"</span>: <span class="hljs-string">"zgFnP3lL3uPF3WsCeQtnESKvgPYHnW75cSJfkYeZ"</span>
        &#125;
    ],
    <span class="hljs-string">"swift_keys"</span>: [],
    <span class="hljs-string">"caps"</span>: [],
    <span class="hljs-string">"op_mask"</span>: <span class="hljs-string">"read, write, delete"</span>,
    <span class="hljs-string">"default_placement"</span>: <span class="hljs-string">""</span>,
    <span class="hljs-string">"default_storage_class"</span>: <span class="hljs-string">""</span>,
    <span class="hljs-string">"placement_tags"</span>: [],
    <span class="hljs-string">"bucket_quota"</span>: &#123;
        <span class="hljs-string">"enabled"</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-string">"check_on_raw"</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-string">"max_size"</span>: -1,
        <span class="hljs-string">"max_size_kb"</span>: 0,
        <span class="hljs-string">"max_objects"</span>: -1
    &#125;,
    <span class="hljs-string">"user_quota"</span>: &#123;
        <span class="hljs-string">"enabled"</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-string">"check_on_raw"</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-string">"max_size"</span>: -1,
        <span class="hljs-string">"max_size_kb"</span>: 0,
        <span class="hljs-string">"max_objects"</span>: -1
    &#125;,
    <span class="hljs-string">"temp_url_keys"</span>: [],
    <span class="hljs-string">"type"</span>: <span class="hljs-string">"rgw"</span>,
    <span class="hljs-string">"mfa_ids"</span>: []
&#125;

 å®‰è£… s3 python åº“
 pip install boto

 åˆ›å»º s3 æµ‹è¯•æ–‡ä»¶ï¼Œä½¿ç”¨ä¸Šé¢åˆ›å»ºçš„è´¦å·ã€‚
 cat &gt; s3.py &lt;&lt;EOF
from boto.s3.connection import S3Connection
from boto.s3.connection import OrdinaryCallingFormat


 add radosgw user <span class="hljs-keyword">in</span> ceph cluster
 radosgw-admin user create --uid=rgwuser --subuser=rgwuser:swift --display-name=s3 --access=full

conn = S3Connection(aws_access_key_id=<span class="hljs-string">'60DD3SXN58LIRC06ILQE'</span>,
                    aws_secret_access_key=<span class="hljs-string">'zgFnP3lL3uPF3WsCeQtnESKvgPYHnW75cSJfkYeZ'</span>,
                    host=<span class="hljs-string">'10.10.34.29'</span>,
                    port=8080,
                    is_secure=False,
                    calling_format=OrdinaryCallingFormat())

create_bucket = conn.create_bucket(<span class="hljs-string">'cephfs'</span>)

buckets_list = conn.get_all_buckets()
<span class="hljs-keyword">for</span> bucket <span class="hljs-keyword">in</span> buckets_list:
     <span class="hljs-built_in">print</span>(<span class="hljs-string">'%s\t%s'</span> % (bucket.name, bucket.creation_date))

delete_bucket = conn.delete_bucket(<span class="hljs-string">'cephfs'</span>)
EOF

 æµ‹è¯•éªŒè¯
 python s3.py
cephfs  2020-04-10T08:16:15.647Z</code></pre></div><h4 id="swift"><a href="#swift" class="headerlink" title="swift"></a>swift</h4><div class="hljs"><pre><code class="hljs bash"> åˆ›å»ºè´¦å·
 radosgw-admin subuser create --uid=testuser --subuser=testuser:swift --access=full
&#123;
    <span class="hljs-string">"user_id"</span>: <span class="hljs-string">"testuser"</span>,
    <span class="hljs-string">"display_name"</span>: <span class="hljs-string">"test user"</span>,
    <span class="hljs-string">"email"</span>: <span class="hljs-string">""</span>,
    <span class="hljs-string">"suspended"</span>: 0,
    <span class="hljs-string">"max_buckets"</span>: 1000,
    <span class="hljs-string">"subusers"</span>: [
        &#123;
            <span class="hljs-string">"id"</span>: <span class="hljs-string">"testuser:swift"</span>,
            <span class="hljs-string">"permissions"</span>: <span class="hljs-string">"full-control"</span>
        &#125;
    ],
    <span class="hljs-string">"keys"</span>: [
        &#123;
            <span class="hljs-string">"user"</span>: <span class="hljs-string">"testuser"</span>,
            <span class="hljs-string">"access_key"</span>: <span class="hljs-string">"60DD3SXN58LIRC06ILQE"</span>,
            <span class="hljs-string">"secret_key"</span>: <span class="hljs-string">"zgFnP3lL3uPF3WsCeQtnESKvgPYHnW75cSJfkYeZ"</span>
        &#125;
    ],
    <span class="hljs-string">"swift_keys"</span>: [
        &#123;
            <span class="hljs-string">"user"</span>: <span class="hljs-string">"testuser:swift"</span>,
            <span class="hljs-string">"secret_key"</span>: <span class="hljs-string">"b59Aw59eiStnhibukAm7fN3vQRtTU2BwNio2dHnl"</span>
        &#125;
    ],
    <span class="hljs-string">"caps"</span>: [],
    <span class="hljs-string">"op_mask"</span>: <span class="hljs-string">"read, write, delete"</span>,
    <span class="hljs-string">"default_placement"</span>: <span class="hljs-string">""</span>,
    <span class="hljs-string">"default_storage_class"</span>: <span class="hljs-string">""</span>,
    <span class="hljs-string">"placement_tags"</span>: [],
    <span class="hljs-string">"bucket_quota"</span>: &#123;
        <span class="hljs-string">"enabled"</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-string">"check_on_raw"</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-string">"max_size"</span>: -1,
        <span class="hljs-string">"max_size_kb"</span>: 0,
        <span class="hljs-string">"max_objects"</span>: -1
    &#125;,
    <span class="hljs-string">"user_quota"</span>: &#123;
        <span class="hljs-string">"enabled"</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-string">"check_on_raw"</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-string">"max_size"</span>: -1,
        <span class="hljs-string">"max_size_kb"</span>: 0,
        <span class="hljs-string">"max_objects"</span>: -1
    &#125;,
    <span class="hljs-string">"temp_url_keys"</span>: [],
    <span class="hljs-string">"type"</span>: <span class="hljs-string">"rgw"</span>,
    <span class="hljs-string">"mfa_ids"</span>: []
&#125;

 é‡ç½®å¯†ç 
 radosgw-admin key create --subuser=testuser:swift --key-type=swift --gen-secret

 å®‰è£… swift å®¢æˆ·ç«¯
 pip install python-swiftclient

 æµ‹è¯•
 swift -A http://10.10.34.29:8080/auth/1.0 -U testuser:swift -K <span class="hljs-string">'b59Aw59eiStnhibukAm7fN3vQRtTU2BwNio2dHnl'</span> list</code></pre></div><h2 id="å®‰è£…-istio"><a href="#å®‰è£…-istio" class="headerlink" title="å®‰è£… istio"></a><strong>å®‰è£… istio</strong></h2><h3 id="ä½¿ç”¨-demo-å®‰è£…"><a href="#ä½¿ç”¨-demo-å®‰è£…" class="headerlink" title="ä½¿ç”¨ demo å®‰è£…"></a>ä½¿ç”¨ demo å®‰è£…</h3><ul><li>å‚è€ƒ <code>https://istio.io/docs/setup/additional-setup/config-profiles/</code></li></ul><div class="hljs"><pre><code class="hljs bash">istioctl manifest apply --<span class="hljs-built_in">set</span> profile=demo --<span class="hljs-built_in">set</span> values.gateways.istio-ingressgateway.type=NodePort</code></pre></div><h3 id="è‡ªå®šä¹‰å‚æ•°å®‰è£…"><a href="#è‡ªå®šä¹‰å‚æ•°å®‰è£…" class="headerlink" title="è‡ªå®šä¹‰å‚æ•°å®‰è£…"></a>è‡ªå®šä¹‰å‚æ•°å®‰è£…</h3><ul><li>å‚æ•° <code>https://istio.io/zh/docs/reference/config/installation-options/</code></li></ul><div class="hljs"><pre><code class="hljs bash">istioctl manifest apply \
 --namespace istio-system \
 --<span class="hljs-built_in">set</span> values.global.hub=docker.io/istio \
 --<span class="hljs-built_in">set</span> values.global.tag=1.5.0 \
 --<span class="hljs-built_in">set</span> values.global.logging.level=<span class="hljs-string">"default:info"</span> \
 --<span class="hljs-built_in">set</span> values.global.imagePullPolicy=IfNotPresent \
 --<span class="hljs-built_in">set</span> values.global.k8sIngress.enabled=<span class="hljs-literal">false</span> \
 --<span class="hljs-built_in">set</span> values.global.k8sIngress.enableHttps=<span class="hljs-literal">false</span> \
 --<span class="hljs-built_in">set</span> values.global.proxy.image=proxyv2 \
 --<span class="hljs-built_in">set</span> values.global.proxy.clusterDomain=<span class="hljs-string">"cluster.local"</span> \
 --<span class="hljs-built_in">set</span> values.global.proxy.privileged=<span class="hljs-literal">true</span> \
 --<span class="hljs-built_in">set</span> values.global.proxy.enableCoreDump=<span class="hljs-literal">true</span> \
 --<span class="hljs-built_in">set</span> values.global.proxy.autoInject=enabled \
 --<span class="hljs-built_in">set</span> values.global.proxy.tracer=zipkin \
 --<span class="hljs-built_in">set</span> values.global.controlPlaneSecurityEnabled=<span class="hljs-literal">true</span> \
 --<span class="hljs-built_in">set</span> values.global.mtls.enabled=<span class="hljs-literal">false</span> \
 --<span class="hljs-built_in">set</span> values.global.outboundTrafficPolicy.mode=ALLOW_ANY \
 --<span class="hljs-built_in">set</span> values.global.sds.enabled=<span class="hljs-literal">false</span> \
 --<span class="hljs-built_in">set</span> values.certmanager.enabled=<span class="hljs-literal">false</span> \
 --<span class="hljs-built_in">set</span> values.galley.enabled=<span class="hljs-literal">true</span> \
 --<span class="hljs-built_in">set</span> values.gateways.enabled=<span class="hljs-literal">true</span> \
 --<span class="hljs-built_in">set</span> values.gateways.istio-ingressgateway.enabled=<span class="hljs-literal">true</span> \
 --<span class="hljs-built_in">set</span> values.gateways.istio-ingressgateway.type=NodePort  NodePort, ClusterIP or LoadBalancer \
 --<span class="hljs-built_in">set</span> values.gateways.istio-egressgateway.enabled=<span class="hljs-literal">true</span> \
 --<span class="hljs-built_in">set</span> values.grafana.enabled=<span class="hljs-literal">true</span> \
 --<span class="hljs-built_in">set</span> values.istio_cni.enabled=<span class="hljs-literal">false</span> \
 --<span class="hljs-built_in">set</span> values.istiocoredns.enabled=<span class="hljs-literal">false</span> \
 --<span class="hljs-built_in">set</span> values.kiali.enabled=<span class="hljs-literal">true</span> \
 --<span class="hljs-built_in">set</span> values.kiali.createDemoSecret=<span class="hljs-literal">true</span> \
 --<span class="hljs-built_in">set</span> values.kiali.hub=docker.io/kiali \
 --<span class="hljs-built_in">set</span> values.mixer.policy.enabled=<span class="hljs-literal">false</span> \
 --<span class="hljs-built_in">set</span> values.mixer.policy.autoscaleEnabled=<span class="hljs-literal">true</span> \
 --<span class="hljs-built_in">set</span> values.nodeagent.enabled=<span class="hljs-literal">false</span> \
 --<span class="hljs-built_in">set</span> values.pilot.enabled=<span class="hljs-literal">true</span> \
 --<span class="hljs-built_in">set</span> values.pilot.sidecar=<span class="hljs-literal">true</span> \
 --<span class="hljs-built_in">set</span> values.prometheus.enabled=<span class="hljs-literal">true</span> \
 --<span class="hljs-built_in">set</span> values.security.enabled=<span class="hljs-literal">true</span> \
 --<span class="hljs-built_in">set</span> values.sidecarInjectorWebhook.enabled=<span class="hljs-literal">true</span> \
 --<span class="hljs-built_in">set</span> values.sidecarInjectorWebhook.enableNamespacesByDefault=<span class="hljs-literal">true</span> \
 --<span class="hljs-built_in">set</span> values.tracing.enabled=<span class="hljs-literal">true</span> \
 --<span class="hljs-built_in">set</span> values.tracing.jaeger.hub=docker.io/jaegertracing \
 --<span class="hljs-built_in">set</span> values.tracing.jaeger.tag=1.14</code></pre></div><h3 id="æŸ¥çœ‹-ingress-ç«¯å£ç›‘å¬æƒ…å†µ"><a href="#æŸ¥çœ‹-ingress-ç«¯å£ç›‘å¬æƒ…å†µ" class="headerlink" title="æŸ¥çœ‹ ingress ç«¯å£ç›‘å¬æƒ…å†µ"></a>æŸ¥çœ‹ ingress ç«¯å£ç›‘å¬æƒ…å†µ</h3><div class="hljs"><pre><code class="hljs bash"> kubectl get svc -n istio-system | grep ingress
istio-ingressgateway        NodePort    10.105.16.129    &lt;none&gt;        15020:30796/TCP,80:32179/TCP,443:31133/TCP,15029:31338/TCP,15030:30980/TCP,15031:31675/TCP,15032:32296/TCP,31400:31821/TCP,15443:32679/TCP   30s

 ansible ins -m shell -a <span class="hljs-string">'netstat -lntp | grep -E "32179|31133"'</span>
10.10.34.92 | CHANGED | rc=0 &gt;&gt;
tcp6       0      0 :::32179                :::*                    LISTEN      21780/kube-proxy
tcp6       0      0 :::31133                :::*                    LISTEN      21780/kube-proxy
10.10.34.94 | CHANGED | rc=0 &gt;&gt;
tcp6       0      0 :::32179                :::*                    LISTEN      3093/kube-proxy
tcp6       0      0 :::31133                :::*                    LISTEN      3093/kube-proxy
10.10.34.100 | CHANGED | rc=0 &gt;&gt;
tcp6       0      0 :::32179                :::*                    LISTEN      14998/kube-proxy
tcp6       0      0 :::31133                :::*                    LISTEN      14998/kube-proxy
10.10.34.99 | CHANGED | rc=0 &gt;&gt;
tcp6       0      0 :::31133                :::*                    LISTEN      3031/kube-proxy
tcp6       0      0 :::32179                :::*                    LISTEN      3031/kube-proxy
10.10.34.95 | CHANGED | rc=0 &gt;&gt;
tcp6       0      0 :::32179                :::*                    LISTEN      23912/kube-proxy
tcp6       0      0 :::31133                :::*                    LISTEN      23912/kube-proxy
10.10.34.96 | CHANGED | rc=0 &gt;&gt;
tcp6       0      0 :::32179                :::*                    LISTEN      26951/kube-proxy
tcp6       0      0 :::31133                :::*                    LISTEN      26951/kube-proxy
10.10.34.93 | CHANGED | rc=0 &gt;&gt;
tcp6       0      0 :::31133                :::*                    LISTEN      31622/kube-proxy
tcp6       0      0 :::32179                :::*                    LISTEN      31622/kube-proxy
10.10.34.97 | CHANGED | rc=0 &gt;&gt;
tcp6       0      0 :::32179                :::*                    LISTEN      4244/kube-proxy
tcp6       0      0 :::31133                :::*                    LISTEN      4244/kube-proxy
10.10.34.98 | CHANGED | rc=0 &gt;&gt;
tcp6       0      0 :::31133                :::*                    LISTEN      8077/kube-proxy
tcp6       0      0 :::32179                :::*                    LISTEN      8077/kube-proxy</code></pre></div><h3 id="é…ç½®-load-blance"><a href="#é…ç½®-load-blance" class="headerlink" title="é…ç½® load blance"></a>é…ç½® load blance</h3><ul><li>LB 80 ç«¯å£çš„ TCP åè®®è¯·æ±‚è½¬å‘åˆ°é›†ç¾¤ node èŠ‚ç‚¹çš„ 32179 ç«¯å£</li><li>LB 443 ç«¯å£çš„ TCP åè®®è¯·æ±‚è½¬å‘åˆ°é›†ç¾¤ node èŠ‚ç‚¹çš„ 31133 ç«¯å£</li></ul><h3 id="åº”ç”¨æµ‹è¯•"><a href="#åº”ç”¨æµ‹è¯•" class="headerlink" title="åº”ç”¨æµ‹è¯•"></a>åº”ç”¨æµ‹è¯•</h3><p>åˆ›å»º namespace å¹¶æ‰“å¼€è‡ªåŠ¨æ³¨å…¥</p><div class="hljs"><pre><code class="hljs bash">kubectl create namespace book

kubectl label namespace book istio-injection=enabled</code></pre></div><h3 id="åˆ›å»º-demo"><a href="#åˆ›å»º-demo" class="headerlink" title="åˆ›å»º demo"></a>åˆ›å»º demo</h3><div class="hljs"><pre><code class="hljs bash">kubectl apply -f samples/bookinfo/platform/kube/bookinfo.yaml -n book

kubectl get services -n book

kubectl get pods -n book

kubectl <span class="hljs-built_in">exec</span> -n book \
 -it $(kubectl get pod  -n book -l app=ratings -o jsonpath=<span class="hljs-string">'&#123;.items[0].metadata.name&#125;'</span>) -c ratings \
 -- curl productpage:9080/productpage | grep -o <span class="hljs-string">"&lt;title&gt;.*&lt;/title&gt;"</span></code></pre></div><h3 id="åˆ›å»º-http-gateway"><a href="#åˆ›å»º-http-gateway" class="headerlink" title="åˆ›å»º http gateway"></a>åˆ›å»º http gateway</h3><div class="hljs"><pre><code class="hljs bash"> kubectl apply -f - &lt;&lt;EOF
--
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: book
  namespace: book
spec:
  hosts:
  - <span class="hljs-string">"book.mokr.cn"</span>
  gateways:
  - istio-system/ingressgateway
  http:
  - match:
    - uri:
        exact: /productpage
    - uri:
        prefix: /static
    - uri:
        exact: /login
    - uri:
        exact: /<span class="hljs-built_in">logout</span>
    - uri:
        prefix: /api/v1/products
    route:
    - destination:
        host: productpage
        port:
          number: 9080
EOF</code></pre></div><h3 id="éªŒè¯-http-gateway"><a href="#éªŒè¯-http-gateway" class="headerlink" title="éªŒè¯ http gateway"></a>éªŒè¯ http gateway</h3><div class="hljs"><pre><code class="hljs bash">curl -ik http://book.mokr.cn --resolve <span class="hljs-string">'book.mokr.cn:443:10.10.34.89'</span> -v</code></pre></div><h3 id="åˆ›å»º-https-gateway"><a href="#åˆ›å»º-https-gateway" class="headerlink" title="åˆ›å»º https gateway"></a>åˆ›å»º https gateway</h3><div class="hljs"><pre><code class="hljs bash"> åˆ›å»ºæ ¹è¯ä¹¦
 openssl req -x509 -sha256 -nodes -days 365 -newkey rsa:2048 -keyout mokr.cn.key -out mokr.cn.crt -subj <span class="hljs-string">"/C=CN/ST=Guangdong/L=Shenzhen/O=mokr/OU=ops/CN=mokr.cn"</span>

 åˆ›å»ºåŸŸå key
 openssl req -out book.mokr.cn.csr -newkey rsa:2048 -nodes -keyout book.mokr.cn.key -subj <span class="hljs-string">"/C=CN/ST=Guangdong/L=Shenzhen/O=mokr/OU=ops/CN=book.mokr.cn"</span>

 åˆ›å»ºåŸŸåè¯ä¹¦
 openssl x509 -req -days 365 -CA mokr.cn.crt -CAkey mokr.cn.key -set_serial 0 -<span class="hljs-keyword">in</span> book.mokr.cn.csr -out book.mokr.cn.crt

 åˆ›å»º tls secret
 kubectl create secret tls ingressgateway-book-certs --key book.mokr.cn.key --cert book.mokr.cn.crt  -n istio-system

 åˆ›å»º https gateway
 kubectl apply -f - &lt;&lt;EOF
--
apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
  name: book-gateway
  namespace: istio-system
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - book.mokr.cn
    tls:
      httpsRedirect: <span class="hljs-literal">true</span>
  - port:
      number: 443
      name: https
      protocol: HTTPS   HTTP | HTTPS | GRPC | HTTP2 | MONGO | TCP | TLS
    tls:
      mode: SIMPLE    PASSTHROUGH | SIMPLE | MUTUAL | AUTO_PASSTHROUGH | ISTIO_MUTUAL
      credentialName: ingressgateway-book-certs
    hosts:
    - book.mokr.cn
EOF

 åˆ›å»º https VirtualService
 kubectl apply -f - &lt;&lt;EOF
--
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: book
  namespace: book
spec:
  hosts:
  - <span class="hljs-string">"book.mokr.cn"</span>
  gateways:
  - istio-system/book-gateway
  http:
  - match:
    - uri:
        exact: /productpage
    - uri:
        prefix: /static
    - uri:
        exact: /login
    - uri:
        exact: /<span class="hljs-built_in">logout</span>
    - uri:
        prefix: /api/v1/products
    route:
    - destination:
        host: productpage
        port:
          number: 9080
EOF</code></pre></div><h3 id="æŸ¥çœ‹å®‰è£…æƒ…å†µ"><a href="#æŸ¥çœ‹å®‰è£…æƒ…å†µ" class="headerlink" title="æŸ¥çœ‹å®‰è£…æƒ…å†µ"></a>æŸ¥çœ‹å®‰è£…æƒ…å†µ</h3><div class="hljs"><pre><code class="hljs bash"> kubectl get gateway -n book
NAME               AGE
bookinfo-gateway   23s

 kubectl get virtualservice -n book
NAME       GATEWAYS             HOSTS                       AGE
bookinfo   [bookinfo-gateway]   [book.mokr.cn]   36s</code></pre></div><h3 id="éªŒè¯-https-gateway"><a href="#éªŒè¯-https-gateway" class="headerlink" title="éªŒè¯ https gateway"></a>éªŒè¯ https gateway</h3><div class="hljs"><pre><code class="hljs bash">curl -ik https://book.mokr.cn --resolve <span class="hljs-string">'book.mokr.cn:443:10.10.34.89'</span> -v</code></pre></div><h3 id="åˆ é™¤-demo"><a href="#åˆ é™¤-demo" class="headerlink" title="åˆ é™¤ demo"></a>åˆ é™¤ demo</h3><div class="hljs"><pre><code class="hljs bash">kubectl delete -f samples/bookinfo/platform/kube/bookinfo.yaml -n book

kubectl delete namespace book --force --grace-period=0</code></pre></div><h3 id="åˆ é™¤-istioctl-é›†ç¾¤"><a href="#åˆ é™¤-istioctl-é›†ç¾¤" class="headerlink" title="åˆ é™¤ istioctl é›†ç¾¤"></a>åˆ é™¤ istioctl é›†ç¾¤</h3><div class="hljs"><pre><code class="hljs bash">istioctl manifest generate | kubectl delete -f -</code></pre></div><h2 id="éƒ¨ç½²-registry"><a href="#éƒ¨ç½²-registry" class="headerlink" title="éƒ¨ç½² registry"></a>éƒ¨ç½² registry</h2><h3 id="åˆ›å»º-pvc-éƒ¨ç½²æ–‡ä»¶"><a href="#åˆ›å»º-pvc-éƒ¨ç½²æ–‡ä»¶" class="headerlink" title="åˆ›å»º pvc éƒ¨ç½²æ–‡ä»¶"></a>åˆ›å»º pvc éƒ¨ç½²æ–‡ä»¶</h3><div class="hljs"><pre><code class="hljs bash"> cat &gt; registry/pvc.yaml &lt;&lt;EOF
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: registry-storage
spec:
  storageClassName: cephfs-provisioner
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 10Gi
EOF</code></pre></div><h3 id="åˆ›å»º-service-éƒ¨ç½²æ–‡ä»¶"><a href="#åˆ›å»º-service-éƒ¨ç½²æ–‡ä»¶" class="headerlink" title="åˆ›å»º service éƒ¨ç½²æ–‡ä»¶"></a>åˆ›å»º service éƒ¨ç½²æ–‡ä»¶</h3><div class="hljs"><pre><code class="hljs bash"> cat &gt; registry/service.yaml &lt;&lt;EOF
---
apiVersion: v1
kind: Service
metadata:
  name: docker-registry
  namespace: default
spec:
  ports:
  - port: 5000
    protocol: TCP
    targetPort: 5000
  selector:
    k8s-app: docker-registry
  sessionAffinity: None
  <span class="hljs-built_in">type</span>: ClusterIP
EOF</code></pre></div><h3 id="åˆ›å»º-registry-éƒ¨ç½²æ–‡ä»¶"><a href="#åˆ›å»º-registry-éƒ¨ç½²æ–‡ä»¶" class="headerlink" title="åˆ›å»º registry éƒ¨ç½²æ–‡ä»¶"></a>åˆ›å»º registry éƒ¨ç½²æ–‡ä»¶</h3><div class="hljs"><pre><code class="hljs bash"> cat &gt; registry/deployment.yaml &lt;&lt;EOF
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    k8s-app: docker-registry
  name: docker-registry
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      k8s-app: docker-registry
  template:
    metadata:
      labels:
        k8s-app: docker-registry
    spec:
      nodeSelector:
        node-role.kubernetes.io/infra: <span class="hljs-string">"true"</span>
      containers:
      - env:
        - name: REGISTRY_HTTP_ADDR
          value: :5000
        - name: REGISTRY_HTTP_TLS_CERTIFICATE
          value: /etc/secrets/tls.crt
        - name: REGISTRY_HTTP_TLS_KEY
          value: /etc/secrets/tls.key
        - name: REGISTRY_STORAGE_DELETE_ENABLED
          value: <span class="hljs-string">"true"</span>
        name: registry
        image: registry:2
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 5000
          protocol: TCP
        resources:
          requests:
            cpu: 100m
            memory: 256Mi
        volumeMounts:
        - name: registry-data
          mountPath: /var/lib/registry
        - name: registry-certificates
          mountPath: /etc/secrets
      serviceAccountName: docker-registry
      volumes:
      - name: registry-data
        persistentVolumeClaim:
          claimName: registry-storage
      - name: registry-certificates
        secret:
          defaultMode: 420
          secretName: registry-certificates
EOF</code></pre></div><h3 id="åˆ›å»º-service"><a href="#åˆ›å»º-service" class="headerlink" title="åˆ›å»º service"></a>åˆ›å»º service</h3><div class="hljs"><pre><code class="hljs bash">kubectl apply -f registry/service.yaml

kubectl get svc docker-registry -o custom-columns=clusterIP:.spec.clusterIP</code></pre></div><h3 id="é…ç½®å¤šåŸŸå"><a href="#é…ç½®å¤šåŸŸå" class="headerlink" title="é…ç½®å¤šåŸŸå"></a>é…ç½®å¤šåŸŸå</h3><div class="hljs"><pre><code class="hljs bash"> mkdir -p registry/

 cp /etc/ssl/openssl.cnf registry/
 vim registry/openssl.cnf
[ v3_req ]
basicConstraints = CA:FALSE
keyUsage = nonRepudiation, digitalSignature, keyEncipherment
subjectAltName = @alt_names

[alt_names]
DNS.1 = docker-registry.mokr.cn
DNS.2 = docker-registry.default.svc
DNS.3 = docker-registry.default.svc.cluster.local</code></pre></div><h3 id="ç­¾å‘-registry-å¯†é’¥"><a href="#ç­¾å‘-registry-å¯†é’¥" class="headerlink" title="ç­¾å‘ registry å¯†é’¥"></a>ç­¾å‘ registry å¯†é’¥</h3><div class="hljs"><pre><code class="hljs bash">openssl req -nodes -newkey rsa:2048 \
 -keyout registry/docker-registry.key \
 -out registry/docker-registry.csr \
 -subj <span class="hljs-string">"/C=CN/ST=GuangDong/L=ShenZhen/O=Mokr LTD/OU=OPS"</span> \
 -config registry/openssl.cnf \
 -extensions v3_req</code></pre></div><h3 id="ç­¾å‘-registry-è¯ä¹¦"><a href="#ç­¾å‘-registry-è¯ä¹¦" class="headerlink" title="ç­¾å‘ registry è¯ä¹¦"></a>ç­¾å‘ registry è¯ä¹¦</h3><div class="hljs"><pre><code class="hljs bash">ç§é’¥ç­¾å‘
openssl x509 -req -sha256 -days 365 \
 -<span class="hljs-keyword">in</span> registry/docker-registry.csr \
 -signkey registry/docker-registry.key \
 -out registry/docker-registry.crt \
 -extfile registry/openssl.cnf \
 -extensions v3_req

ca ç­¾å‘
openssl x509 -req -days 365 \
 -<span class="hljs-keyword">in</span> registry/docker-registry.csr \
 -CA /etc/kubernetes/pki/ca.crt \
 -CAkey /etc/kubernetes/pki/ca.key \
 -CAcreateserial \
 -out registry/docker-registry.crt \
 -extfile registry/openssl.cnf \
 -extensions v3_req</code></pre></div><h3 id="éªŒè¯-registry-è¯ä¹¦"><a href="#éªŒè¯-registry-è¯ä¹¦" class="headerlink" title="éªŒè¯ registry è¯ä¹¦"></a>éªŒè¯ registry è¯ä¹¦</h3><div class="hljs"><pre><code class="hljs bash"> openssl x509 -text -noout -<span class="hljs-keyword">in</span> registry/docker-registry.crt
Certificate:
...
        X509v3 extensions:
            X509v3 Basic Constraints:
                CA:FALSE
            X509v3 Key Usage:
                Digital Signature, Non Repudiation, Key Encipherment
            X509v3 Subject Alternative Name:
                DNS:docker-registry.mokr.cn, DNS:docker-registry.default.svc, DNS:docker-registry.default.svc.cluster.local
...</code></pre></div><h3 id="ä¸º-registry-é…ç½®-secret-è¯ä¹¦"><a href="#ä¸º-registry-é…ç½®-secret-è¯ä¹¦" class="headerlink" title="ä¸º registry é…ç½® secret è¯ä¹¦"></a>ä¸º registry é…ç½® secret è¯ä¹¦</h3><div class="hljs"><pre><code class="hljs bash">kubectl create secret tls registry-certificates --cert=registry/docker-registry.crt --key=registry/docker-registry.key</code></pre></div><h3 id="åˆ›å»º-registry"><a href="#åˆ›å»º-registry" class="headerlink" title="åˆ›å»º registry"></a>åˆ›å»º registry</h3><div class="hljs"><pre><code class="hljs bash">kubectl apply -f registry/pvc.yaml

kubectl apply -f registry/deployment.yaml</code></pre></div><h3 id="åˆ›å»º-registry-route"><a href="#åˆ›å»º-registry-route" class="headerlink" title="åˆ›å»º registry route"></a>åˆ›å»º registry route</h3><div class="hljs"><pre><code class="hljs bash"> cat &gt; registry/docker-registry-route.yaml &lt;&lt;EOF
kind: Route
apiVersion: route.openshift.io/v1
metadata:
  name: docker-registry
  labels:
    app: docker-registry
spec:
  host: docker-registry.mokr.cn
  tls:
    insecureEdgeTerminationPolicy: Redirect <span class="hljs-comment">## None Allow Redirect</span>
    termination: passthrough <span class="hljs-comment">## edge passthrough reencrypt</span>
  to:
    kind: Service
    name: docker-registry
    weight: 100
  wildcardPolicy: None
EOF

 kubectl apply -f registry/docker-registry-route.yaml</code></pre></div><h3 id="é…ç½®-docker"><a href="#é…ç½®-docker" class="headerlink" title="é…ç½® docker"></a>é…ç½® docker</h3><div class="hljs"><pre><code class="hljs bash"> vim /etc/docker/daemon.json
&#123;
...
  <span class="hljs-string">"registry-mirrors"</span>: [
    <span class="hljs-string">"https://docker-registry.mokr.cn"</span>,
    <span class="hljs-string">"https://docker-registry.default.svc:5000"</span>,
    <span class="hljs-string">"https://docker-registry.default.svc.cluster.local:5000"</span>
  ],
  <span class="hljs-string">"insecure-registries"</span>: [
    <span class="hljs-string">"docker-registry.mokr.cn"</span>,
    <span class="hljs-string">"docker-registry.default.svc:5000"</span>,
    <span class="hljs-string">"docker-registry.default.svc.cluster.local:5000"</span>
  ],
...
&#125;

 systemctl restart docker

 docker info
...
 Insecure Registries:
  docker-registry.default.svc.cluster.local:5000
  docker-registry.default.svc:5000
  docker-registry.mokr.cn
  127.0.0.0/8
 Registry Mirrors:
  https://docker-registry.mokr.cn/
  https://docker-registry.default.svc:5000/
  https://docker-registry.default.svc.cluster.local:5000/
 Live Restore Enabled: <span class="hljs-literal">false</span></code></pre></div><h3 id="ä¸‹è½½-image-æµ‹è¯•"><a href="#ä¸‹è½½-image-æµ‹è¯•" class="headerlink" title="ä¸‹è½½ image æµ‹è¯•"></a>ä¸‹è½½ image æµ‹è¯•</h3><div class="hljs"><pre><code class="hljs bash">docker pull busybox:latest

docker tag busybox:latest docker-registry.default.svc:5000/busybox:latest
docker tag busybox:latest docker-registry.default.svc.cluster.local:5000/busybox:latest
docker tag busybox:latest docker-registry.mokr.cn/default/busybox:latest

docker push docker-registry.default.svc:5000/busybox:latest
docker push docker-registry.default.svc.cluster.local:5000/busybox:latest
docker push docker-registry.mokr.cn/default/busybox:latest</code></pre></div><h3 id="éªŒè¯-registry"><a href="#éªŒè¯-registry" class="headerlink" title="éªŒè¯ registry"></a>éªŒè¯ registry</h3><div class="hljs"><pre><code class="hljs bash"> curl -ik https://docker-registry.mokr.cn/v2/_catalog --resolve <span class="hljs-string">'docker-registry.mokr.cn:443:10.10.34.89'</span> -v
* Added docker-registry.mokr.cn:443:10.10.34.89 to DNS cache
* Hostname docker-registry.mokr.cn was found <span class="hljs-keyword">in</span> DNS cache
*   Trying 10.10.34.89...
* TCP_NODELAY <span class="hljs-built_in">set</span>
* Connected to docker-registry.mokr.cn (10.10.34.89) port 443 (0)
* ALPN, offering h2
* ALPN, offering http/1.1
* successfully <span class="hljs-built_in">set</span> certificate verify locations:
*   CAfile: /etc/ssl/certs/ca-certificates.crt
  CApath: /etc/ssl/certs
* TLSv1.3 (OUT), TLS handshake, Client hello (1):
* TLSv1.3 (IN), TLS handshake, Server hello (2):
* TLSv1.2 (IN), TLS handshake, Certificate (11):
* TLSv1.2 (IN), TLS handshake, Server key exchange (12):
* TLSv1.2 (IN), TLS handshake, Server finished (14):
* TLSv1.2 (OUT), TLS handshake, Client key exchange (16):
* TLSv1.2 (OUT), TLS change cipher, Client hello (1):
* TLSv1.2 (OUT), TLS handshake, Finished (20):
* TLSv1.2 (IN), TLS handshake, Finished (20):
* SSL connection using TLSv1.2 / ECDHE-RSA-AES128-GCM-SHA256
* ALPN, server accepted to use h2
* Server certificate:
*  subject: C=CN; ST=GuangDong; L=ShenZhen; O=Mokr LTD; OU=OPS
*  start date: Apr 11 15:05:20 2020 GMT
*  expire date: Apr 11 15:05:20 2021 GMT
*  issuer: CN=kubernetes
*  SSL certificate verify result: unable to get <span class="hljs-built_in">local</span> issuer certificate (20), continuing anyway.
* Using HTTP2, server supports multi-use
* Connection state changed (HTTP/2 confirmed)
* Copying HTTP/2 data <span class="hljs-keyword">in</span> stream buffer to connection buffer after upgrade: len=0
* Using Stream ID: 1 (easy handle 0x556a671559a0)
&gt; GET /v2/_catalog HTTP/2
&gt; Host: docker-registry.mokr.cn
&gt; User-Agent: curl/7.58.0
&gt; Accept: */*
&gt;
* Connection state changed (MAX_CONCURRENT_STREAMS updated)!
&lt; HTTP/2 200
HTTP/2 200
&lt; content-type: application/json; charset=utf-8
content-type: application/json; charset=utf-8
&lt; docker-distribution-api-version: registry/2.0
docker-distribution-api-version: registry/2.0
&lt; x-content-type-options: nosniff
x-content-type-options: nosniff
&lt; content-length: 47
content-length: 47
&lt; date: Sat, 11 Apr 2020 15:57:22 GMT
date: Sat, 11 Apr 2020 15:57:22 GMT

&lt;
&#123;<span class="hljs-string">"repositories"</span>:[<span class="hljs-string">"busybox"</span>,<span class="hljs-string">"default/busybox"</span>]&#125;
* Connection 0 to host docker-registry.mokr.cn left intact</code></pre></div><h3 id="æ¸…ç†-registry-images"><a href="#æ¸…ç†-registry-images" class="headerlink" title="æ¸…ç† registry images"></a>æ¸…ç† registry images</h3><div class="hljs"><pre><code class="hljs bash"> ç™»å½• docker-registry
 kubectl <span class="hljs-built_in">exec</span> -it $(kubectl get pods -l k8s-app=docker-registry -o jsonpath=&#123;.items[0].metadata.name&#125;) sh

/  registry garbage-collect /etc/docker/registry/config.yml --delete-untagged=<span class="hljs-literal">true</span></code></pre></div><h2 id="å®‰è£…éƒ¨ç½²-cert-manager"><a href="#å®‰è£…éƒ¨ç½²-cert-manager" class="headerlink" title="å®‰è£…éƒ¨ç½² cert-manager"></a>å®‰è£…éƒ¨ç½² cert-manager</h2><h3 id="ä¸‹è½½å®‰è£…è„šæœ¬"><a href="#ä¸‹è½½å®‰è£…è„šæœ¬" class="headerlink" title="ä¸‹è½½å®‰è£…è„šæœ¬"></a>ä¸‹è½½å®‰è£…è„šæœ¬</h3><div class="hljs"><pre><code class="hljs bash">mkdir -p cert-manager

curl -L https://github.com/jetstack/cert-manager/releases/download/v0.14.1/cert-manager.yaml -o cert-manager/cert-manager.yaml

sed -i <span class="hljs-string">'s/namespace: "cert-manager"/namespace: kube-system/g'</span> cert-manager/cert-manager.yaml

sed -i <span class="hljs-string">'s/namespace: cert-manager/namespace: kube-system/g'</span> cert-manager/cert-manager.yaml

sed -i <span class="hljs-string">'s/secret: "cert-manager/secret: kube-system/g'</span> cert-manager/cert-manager.yaml

sed -i <span class="hljs-string">'s/secret: cert-manager/secret: kube-system/g'</span> cert-manager/cert-manager.yaml

æ³¨é‡Š 5878 - 5882 è¡Œï¼Œå…³é—­
sed -i <span class="hljs-string">'5878,5882s/^//g'</span> cert-manager/cert-manager.yaml</code></pre></div><h3 id="æ‰§è¡Œå®‰è£…"><a href="#æ‰§è¡Œå®‰è£…" class="headerlink" title="æ‰§è¡Œå®‰è£…"></a>æ‰§è¡Œå®‰è£…</h3><div class="hljs"><pre><code class="hljs bash">kubectl apply -f cert-manager/cert-manager.yaml</code></pre></div><h3 id="æ£€æŸ¥å®‰è£…"><a href="#æ£€æŸ¥å®‰è£…" class="headerlink" title="æ£€æŸ¥å®‰è£…"></a>æ£€æŸ¥å®‰è£…</h3><div class="hljs"><pre><code class="hljs bash"> kubectl get pods -n kube-system | grep cert-manager
cert-manager-557f8d6944-zr5jh              1/1     Running   0          2m1s
cert-manager-cainjector-6999bdd97-nfsrn    1/1     Running   0          2m1s
cert-manager-webhook-c579c9f47-g6rd5       1/1     Running   0          2m1s

 kubectl get crd -o custom-columns=crd-name:.metadata.name|grep cert-manager
certificaterequests.cert-manager.io
certificates.cert-manager.io
challenges.acme.cert-manager.io
clusterissuers.cert-manager.io
issuers.cert-manager.io
orders.acme.cert-manager.io</code></pre></div></article><hr><div><div class="post-metas mb-3"></div><p class="note note-warning">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨: <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" title="Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)">ç½²å-éå•†ä¸šæ€§ä½¿ç”¨-ç¦æ­¢æ¼”ç» 4.0 å›½é™…åè®®</a>ï¼Œè½¬è½½è¯·ä¿ç•™åŸæ–‡é“¾æ¥åŠä½œè€…ã€‚</p><div class="post-prevnext row"><div class="post-prev col-6"><a href="/post/66cb4f6f.html"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">Ansibleç®€æ˜æŒ‡åŒ—</span> <span class="visible-mobile">ä¸Šä¸€ç¯‡</span></a></div><div class="post-next col-6"><a href="/post/c21ba7a3.html"><span class="hidden-mobile">ansible éƒ¨ç½²zkã€kafkaã€nacosé›†ç¾¤</span> <span class="visible-mobile">ä¸‹ä¸€ç¯‡</span> <i class="iconfont icon-arrowright"></i></a></div></div></div><div class="comments" id="comments"><div id="vcomments"></div><script defer src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="/js/Valine.min.js"></script><script type="text/javascript">var notify=!1,verify=!1,oldLoadVa=window.onload;window.onload=function(){oldLoadVa&&oldLoadVa(),new Valine({lang:"zh-cn",el:"#vcomments",notify:notify,verify:verify,app_id:"dXhxgFWthuLPDnYYuAJbIe6X-MdYXbMMI",app_key:"In8P9esI1pt8dBUc7JbFCvLa",placeholder:"è¯´ç‚¹ä»€ä¹ˆ",avatar:"/retro",meta:["nick","mail","link"],pageSize:"10",emoticon_url:"/emoji",emoticon_list:["åŠ¨è€³æœµ.gif","æŠ–è„šè„š.gif","æŠ–çœ¼.gif","æŠ–çœ¼é•œ.gif","é£å¹ç§€å‘.gif","æ…Œå¼ .gif","å¤¹ä½.gif","å¼€è½¦.gif","å“­å”§å”§.gif","ç»¿è‰²çš„.gif","è·³èˆ.gif","è·³ç€èµ°.gif","å°èŠ±èŠ±.gif","çœ¼ç›è½¬.gif","æ‘‡å¤´.gif","çœ¨çœ¼.gif","åƒä¸œè¥¿.gif","å¼¹è‚šçš®.gif","åŠ¨æ¬¡æ‰“æ¬¡.gif","æ¯”å¿ƒå¿ƒ.gif","å¹é£.gif","æ‰“ç¯®çƒ.gif","éƒ½æ˜¯å°å¿ƒå¿ƒ.gif","å.png","å–·è¡€.png","ç‹‚æ±—.png","ä¸è¯´è¯.png","æ±—.png","åç­‰.png","çŒ®èŠ±.png","ä¸é«˜å…´.png","ä¸­åˆ€.png","å®³ç¾.png","çš±çœ‰.png","å°çœ¼ç›.png","ä¸­æŒ‡.png","å°´å°¬.png","ç…ä½ .png","æƒ³ä¸€æƒ³.png","ä¸­æª.png","å¾—æ„.png","è‚¿åŒ….png","æ‰‡è€³å…‰.png","äº²äº².png","æƒŠå–œ.png","è„¸çº¢.png","æ— æ‰€è°“.png","ä¾¿ä¾¿.png","æ„¤æ€’.png","èœ¡çƒ›.png","çŒ®é»„ç“œ.png","å†…ä¼¤.png","æŠ•é™.png","è§‚å¯Ÿ.png","çœ‹ä¸è§.png","å‡»æŒ.png","æŠ é¼».png","é‚ªæ¶.png","çœ‹çƒ­é—¹.png","å£æ°´.png","æŠ½çƒŸ.png","é”çœ‰.png","è£…å¤§æ¬¾.png","åèˆŒ.png","æ— å¥ˆ.png","é•¿è‰.png","èµä¸€ä¸ª.png","å‘²ç‰™.png","æ— è¯­.png","é˜´æš—.png","ä¸å‡ºæ‰€æ–™.png","å’½æ°”.png","æœŸå¾….png","é«˜å…´.png","åè¡€å€’åœ°.png","å“­æ³£.png","æ¬¢å‘¼.png","é»‘çº¿.png","å–œæè€Œæ³£.png","å–·æ°´.png","æ·±æ€.png","é¼“æŒ.png","æš—åœ°è§‚å¯Ÿ.png"]})}</script></div></div></div></div></div><div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;ç›®å½•</p><div id="tocbot"></div></div></div></div></div><div class="col-lg-7 mx-auto nopadding-md"><div class="container custom post-content mx-auto"><img src="/images/wechatpay.webp" class="rounded mx-auto d-block mt-5" style="width:120px;height:150px;vertical-align:-webkit-baseline-middle"><br><div style="text-align:center">ä¹°ä¸ªå¤è›‹ï¼Œåƒæ ¹å†°æ£’</div></div></div></main><a id="scroll-top-button" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">æœç´¢</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">å…³é”®è¯</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div><footer class="mt-5"><div class="text-center py-3"><div><svg t="1586793095516" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3553" width="16" height="16"><path d="M512 0c282.7776 0 512 229.2224 512 512s-229.2224 512-512 512S0 794.7776 0 512 229.2224 0 512 0z m0 71.424a440.576 440.576 0 1 0 0 881.152 440.576 440.576 0 0 0 0-881.152z m8.192 166.7072c55.296 0 108.3904 15.5136 153.7536 44.2368a35.7376 35.7376 0 0 1-38.144 60.3648 215.6032 215.6032 0 0 0-115.5584-33.1264c-116.6336 0-210.6368 90.88-210.6368 202.3936s94.0032 202.3936 210.6368 202.3936c41.0112 0 80.2304-11.264 113.8688-32.1024a35.7376 35.7376 0 0 1 37.632 60.7744 287.1296 287.1296 0 0 1-151.552 42.8032c-155.4944 0-282.0608-122.368-282.0608-273.8688 0-151.552 126.5664-273.8688 282.112-273.8688z" fill="#8a8a8a" p-id="3554"></path></svg> <span itemprop="copyrightYear" id="cori">2021</span><br><svg t="1584375698087" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1913" width="23" height="14"><path d="M513.984496 513.984496c141.383442 0 256-114.616558 256-256S655.367938 1.984496 513.984496 1.984496 257.984496 116.601054 257.984496 257.984496s114.616558 256 256 256z m0-59.534884c-108.50431 0-196.465116-87.960806-196.465116-196.465116s87.960806-196.465116 196.465116-196.465116 196.465116 87.960806 196.465116 196.465116-87.960806 196.465116-196.465116 196.465116z" fill="#8a8a8a" p-id="1914"></path><path d="M1020.031008 992.248062c0-281.647628-227.423256-510.015504-508.031008-510.015504S3.968992 710.600434 3.968992 992.248062a29.767442 29.767442 0 1 0 59.534884 0c0-248.820093 200.827039-450.48062 448.496124-450.48062s448.496124 201.660527 448.496124 450.48062a29.767442 29.767442 0 1 0 59.534884 0z" fill="#8a8a8a" p-id="1915"></path></svg> <span class="author" id="cori" itemprop="copyrightHolder">Bryce Huang</span></div></div><script type="text/javascript" src="/js/commentTyping.min.js"></script></footer><script src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js"></script><script src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js"></script><script src="/js/main.js"></script><script src="https://cdn.staticfile.org/tocbot/4.11.1/tocbot.min.js"></script><script>$(document).ready(function(){var t=$("#board-ctn").offset().top;tocbot.init({tocSelector:"#tocbot",contentSelector:".post-content",headingSelector:"h1,h2,h3,h4,h5,h6",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",collapseDepth:6,scrollSmooth:!0,headingsOffset:-t}),0<$(".toc-list-item").length&&$("#toc").css("visibility","visible")})</script><script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js"></script><script src="/js/clipboard-use.js"></script><script src="/js/custom.js"></script><script src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js"></script><script>var typed=new Typed("#subtitle",{strings:["  ","kubernetes å®‰è£…&nbsp;"],cursorChar:"_",typeSpeed:70,loop:!1});typed.stop(),$(document).ready(function(){$(".typed-cursor").addClass("h2"),typed.start()})</script><script src="/js/local-search.js"></script><script>var path="/local-search.xml",inputArea=document.querySelector("#local-search-input");inputArea.onclick=function(){searchFunc(path,"local-search-input","local-search-result"),this.onclick=null}</script><script src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js"></script><link rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css"><script>$("#post img:not(.no-zoom img, img[no-zoom]), img[zoom]").each(function(){var t=document.createElement("a");$(t).attr("data-fancybox","images"),$(t).attr("href",$(this).attr("src")),$(this).wrap(t)})</script></body></html>